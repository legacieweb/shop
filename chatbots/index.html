<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatbots ‚Äì ShopRight</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style type="text/tailwindcss">
    .section-card { @apply bg-white rounded-2xl shadow-lg p-6 border border-gray-100; }
    .pill { @apply inline-block px-3 py-1 rounded-full text-xs font-semibold; }
    .btn { @apply px-4 py-2 rounded-lg font-semibold transition; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-ghost { @apply bg-gray-100 text-gray-700 hover:bg-gray-200; }
    .btn-danger { @apply bg-red-600 text-white hover:bg-red-700; }
    .btn-outline { @apply border border-gray-300 bg-white hover:bg-gray-50; }
    .label { @apply block text-sm font-medium text-gray-700 mb-1; }
    .input { @apply w-full border border-gray-300 rounded-md px-3 py-2 shadow-sm focus:ring-indigo-500 focus:border-indigo-500; }

    /* Mobile sidebar (drawer) */
    .drawer { @apply fixed inset-y-0 left-0 w-72 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 z-40; }
    .drawer-open { @apply translate-x-0; }
    .backdrop { @apply fixed inset-0 bg-black/40 z-30 hidden; }
    .backdrop-show { @apply block; }

    .sidebar-btn { @apply w-full text-left px-4 py-2 rounded-lg font-semibold transition; }
    .sidebar-btn-active { @apply bg-indigo-600 text-white; }
    .sidebar-btn-inactive { @apply bg-white text-gray-700 hover:bg-gray-50 border; }

    /* Training area flair */
    .training-wrap { @apply relative overflow-hidden; }
    .training-wrap::before { content: ""; @apply absolute inset-0 bg-gradient-to-br from-indigo-50 via-white to-emerald-50; opacity: 0.7; }
    .training-inner { @apply relative; }

    .glass { @apply bg-white/70 backdrop-blur border border-white/60 shadow-lg; }

    /* Widget preview */
    .widget-sim { @apply relative h-[560px] rounded-xl border bg-gradient-to-br from-slate-50 to-white overflow-hidden; }
    .widget-bubble { @apply rounded-full shadow-lg text-white fixed; width:56px; height:56px; display:flex; align-items:center; justify-content:center; font-size:22px; }
    .widget-panel { @apply shadow-2xl rounded-xl overflow-hidden border bg-white fixed flex flex-col; width: 360px; height: 500px; }
    .widget-header { @apply flex items-center justify-between px-3 py-2 font-semibold text-white; }
    .widget-body { @apply flex-1 bg-gray-50 p-3 overflow-y-auto; }
    .widget-input { @apply flex gap-2 p-3 border-t bg-white; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-indigo-50 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <button id="hamburgerBtn" class="btn btn-ghost lg:hidden" aria-label="Open menu">‚ò∞</button>
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-700">ü§ñ Chatbots</h1>
          <p class="text-gray-600">Train, configure, and manage your store assistant.</p>
        </div>
      </div>
      <a id="backToDashboard" class="btn btn-ghost">‚Üê Back to Dashboard</a>
    </div>

    <!-- Mobile backdrop -->
    <div id="sidebarBackdrop" class="backdrop lg:hidden"></div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Sidebar (drawer on mobile, static on desktop) -->
      <aside class="lg:col-span-1">
        <div id="sidebarDrawer" class="drawer lg:static lg:translate-x-0 lg:shadow-none lg:bg-transparent lg:w-auto lg:z-auto lg:transform-none">
          <div class="p-4 space-y-3">
            <button id="tabTraining" class="sidebar-btn sidebar-btn-active">1) Bot Training</button>
            <button id="tabConfig" class="sidebar-btn sidebar-btn-inactive">2) Bot Configuration</button>
            <button id="tabSettings" class="sidebar-btn sidebar-btn-inactive">3) Bot Settings</button>

            <div class="section-card">
              <h3 class="font-semibold text-gray-800 mb-2">Status</h3>
              <div class="text-sm text-gray-600">
                <div>Deployment: <span id="statusDeployment" class="pill bg-gray-100 text-gray-700">Unknown</span></div>
                <div>Plan: <span id="planBadge" class="pill bg-indigo-100 text-indigo-700">All plans</span></div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main area -->
      <main class="lg:col-span-3 space-y-6">
        <!-- Training Panel (visually separated) -->
        <section id="panelTraining" class="training-wrap rounded-3xl p-2">
          <div class="training-inner space-y-6">
            <div class="section-card glass">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h2 class="text-xl font-bold text-indigo-700">Bot Training</h2>
                  <span class="text-xs text-gray-500">Build smarter replies, live product answers, and curated showcases.</span>
                </div>
                <div class="flex items-center gap-2 text-xs">
                  <span class="pill bg-indigo-100 text-indigo-700">Live</span>
                  <span class="pill bg-emerald-100 text-emerald-700">AI Ready</span>
                </div>
              </div>

              <!-- Bot Capabilities -->
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <label class="flex items-center gap-2"><input id="permProducts" type="checkbox" class="h-4 w-4" /><span class="text-sm text-gray-700">Allow bot to read store products</span></label>
                <label class="flex items-center gap-2"><input id="permShipping" type="checkbox" class="h-4 w-4" /><span class="text-sm text-gray-700">Shipping fees</span></label>
                <label class="flex items-center gap-2"><input id="permDelivery" type="checkbox" class="h-4 w-4" /><span class="text-sm text-gray-700">Delivery locations</span></label>
                <label class="flex items-center gap-2"><input id="permPayments" type="checkbox" class="h-4 w-4" /><span class="text-sm text-gray-700">Payment gateways</span></label>
                <!-- Voice responses removed -->
              </div>

              <!-- Two Columns: Keyword rules and Product rules -->
              <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <!-- Keyword Rules -->
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Keyword Rules</h3>
                    <button id="addKeywordRuleBtn" class="btn btn-outline">+ Add Keyword Rule</button>
                  </div>
                  <p class="text-sm text-gray-500">Match keywords or regex and set quick replies. Tip: Use @tag to reference product tags in triggers (e.g., "@shoes, discount").</p>
                  <div id="keywordRules" class="space-y-3"></div>
                </div>

                <!-- Removed Product Rules/Curated UI: Using keyword rules + capability toggles only -->
              </div>

              <!-- Curated Collections Removed -->

              <div class="flex flex-wrap gap-3 mt-6">
                <button id="saveTraining" class="btn btn-primary">Save Training</button>
                <span id="trainingMsg" class="text-sm text-gray-500"></span>
              </div>
            </div>

            <!-- Live Preview (widget simulation) -->
            <div class="section-card glass">
              <h2 class="text-xl font-bold text-indigo-700 mb-3">Live Preview</h2>
              <div class="widget-sim" id="widgetSim"></div>
            </div>
          </div>
        </section>

        <!-- Configuration Panel -->
        <section id="panelConfig" class="space-y-6 hidden">
          <div class="section-card">
            <h2 class="text-xl font-bold text-indigo-700 mb-3">Widget Configuration</h2>
            <p class="text-sm text-gray-600 mb-4">Pick a look. You're done.</p>

            <!-- Super Minimal: Style Packs -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="stylePacks"></div>
            <div class="mt-2 text-xs text-gray-500">Click a style to apply instantly. Preview updates live.</div>

            <!-- Tiny toggles -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
              <div>
                <label class="label">Position</label>
                <select id="position" class="input">
                  <option value="right">Bottom Right</option>
                  <option value="left">Bottom Left</option>
                </select>
              </div>
              <div>
                <label class="label">Initial State</label>
                <select id="initialState" class="input">
                  <option value="closed">Closed</option>
                  <option value="open">Open</option>
                </select>
              </div>
              <div>
                <label class="label">Accent</label>
                <input id="accentColor" class="input" type="color" value="#4f46e5" />
              </div>
            </div>

            <!-- Samples (Templates) -->
            <h3 class="text-lg font-semibold text-gray-800 mt-8">Samples</h3>
            <div id="templatesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-2"></div>

            <!-- Widget Controls -->
            <h3 class="text-lg font-semibold text-gray-800 mt-8">Widget Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
              <div>
                <label class="label">Theme</label>
                <select id="widgetTheme" class="input">
                  <option value="indigo">Indigo</option>
                  <option value="glass">Glass</option>
                  <option value="neon">Neon</option>
                  <option value="emerald">Emerald</option>
                  <option value="slate">Slate</option>
                  <option value="rose">Rose</option>
                </select>
              </div>
              <div>
                <label class="label">Header Style</label>
                <select id="headerStyle" class="input">
                  <option value="solid">Solid</option>
                  <option value="gradient">Gradient</option>
                  <option value="glass">Glass</option>
                </select>
              </div>
              <div>
                <label class="label">Bubble Shape</label>
                <select id="bubbleStyle" class="input">
                  <option value="rounded">Rounded</option>
                  <option value="pill">Pill</option>
                  <option value="square">Square</option>
                </select>
              </div>
              <div>
                <label class="label">User Bubble BG</label>
                <input id="userBg" class="input" type="color" value="#4f46e5" />
              </div>
              <div>
                <label class="label">User Bubble FG</label>
                <input id="userFg" class="input" type="color" value="#ffffff" />
              </div>
              <div>
                <label class="label">Bot Bubble BG</label>
                <input id="botBg" class="input" type="color" value="#ffffff" />
              </div>
              <div>
                <label class="label">Bot Bubble FG</label>
                <input id="botFg" class="input" type="color" value="#111827" />
              </div>
              <div class="flex items-center gap-2">
                <input id="botBorder" type="checkbox" />
                <label class="label !mb-0">Bot Bubble Border</label>
              </div>
            </div>

            <!-- Launcher Button -->
            <h3 class="text-lg font-semibold text-gray-800 mt-8">Launcher Button</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
              <div>
                <label class="label">Type</label>
                <select id="btnType" class="input">
                  <option value="text">Icon/Text</option>
                  <option value="image">Image</option>
                </select>
              </div>
              <div>
                <label class="label">Label Text</label>
                <input id="btnText" class="input" placeholder="e.g. Chat with us" />
              </div>
              <div>
                <label class="label">Emoji</label>
                <input id="btnEmoji" class="input" placeholder="üí¨" />
              </div>
              <div>
                <label class="label">Text Color</label>
                <input id="btnTextColor" class="input" type="color" value="#ffffff" />
              </div>
              <div>
                <label class="label">Background</label>
                <input id="btnBgColor" class="input" type="color" value="#4f46e5" />
              </div>
              <div>
                <label class="label">Image URL</label>
                <input id="btnImageUrl" class="input" type="url" placeholder="https://... or data:image/..." />
                <p class="text-xs text-gray-500 mt-1">Paste a URL or upload below. Preview updates live.</p>
              </div>
              <div>
                <label class="label">Upload Image</label>
                <input id="btnUploadFile" class="input" type="file" accept="image/*" />
                <p class="text-xs text-gray-500 mt-1">We‚Äôll store as a data URL for quick preview.</p>
              </div>
              <div>
                <label class="label">Preview</label>
                <img id="btnImagePreview" alt="Button image preview" class="w-full h-28 object-cover rounded-lg border hidden" />
              </div>
              <div>
                <label class="label">Radius</label>
                <input id="btnRadius" class="input" type="range" min="0" max="999" value="999" />
              </div>
              <div>
                <label class="label">Size</label>
                <select id="btnSize" class="input">
                  <option value="sm">Small</option>
                  <option value="md" selected>Medium</option>
                  <option value="lg">Large</option>
                </select>
              </div>
              <div class="flex items-center gap-2">
                <input id="btnShadow" type="checkbox" />
                <label class="label !mb-0">Drop Shadow</label>
              </div>
            </div>

            <div class="flex gap-3 mt-6">
              <button id="saveWidget" class="btn btn-primary">Save</button>
              <span id="configMsg" class="text-sm text-gray-500"></span>
              <span class="text-xs text-gray-400">Changes appear live above.</span>
            </div>
          </div>
        </section>

        <!-- Settings Panel -->
        <section id="panelSettings" class="space-y-6 hidden">
          <div class="section-card">
            <h2 class="text-xl font-bold text-indigo-700 mb-4">Bot Settings</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="label">Bot Name</label>
                <input id="botName" class="input" placeholder="e.g. ShopRight Helper" />
              </div>
              <div>
                <label class="label">Primary Tone</label>
                <select id="botTone" class="input">
                  <option value="friendly">Friendly</option>
                  <option value="professional">Professional</option>
                  <option value="playful">Playful</option>
                  <option value="concise">Concise</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="label">Welcome Message</label>
                <input id="welcomeMessage" class="input" placeholder="e.g. Hi! I can help with products, orders, and policies." />
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-3 mt-4">
              <button id="saveSettings" class="btn btn-primary">Save Settings</button>
              <button id="deployBot" class="btn btn-primary">Deploy</button>
              <button id="undeployBot" class="btn btn-danger">Undeploy</button>
              <span id="settingsMsg" class="text-sm text-gray-500"></span>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script type="module">
    const API = "https://shop-stp5.onrender.com";
    const params = new URLSearchParams(window.location.search);
    const seller = params.get('seller') || (JSON.parse(localStorage.getItem('user')||"{}").username || '');

    // Back link
    const back = document.getElementById('backToDashboard');
    if (seller) back.href = `./dashboard?seller=${encodeURIComponent(seller)}`; else back.href = './dashboard';

    // Drawer logic
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebarDrawer = document.getElementById('sidebarDrawer');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');
    function openSidebar(){ sidebarDrawer.classList.add('drawer-open'); sidebarBackdrop.classList.add('backdrop-show'); }
    function closeSidebar(){ sidebarDrawer.classList.remove('drawer-open'); sidebarBackdrop.classList.remove('backdrop-show'); }
    if (hamburgerBtn) hamburgerBtn.addEventListener('click', openSidebar);
    if (sidebarBackdrop) sidebarBackdrop.addEventListener('click', closeSidebar);

    // Tabs
    const tabTraining = document.getElementById('tabTraining');
    const tabConfig = document.getElementById('tabConfig');
    const tabSettings = document.getElementById('tabSettings');
    const panelTraining = document.getElementById('panelTraining');
    const panelConfig = document.getElementById('panelConfig');
    const panelSettings = document.getElementById('panelSettings');

    function activate(tab){
      const map = { tabTraining: panelTraining, tabConfig: panelConfig, tabSettings: panelSettings };
      [tabTraining, tabConfig, tabSettings].forEach(btn => {
        const active = (btn === tab);
        btn.classList.toggle('sidebar-btn-active', active);
        btn.classList.toggle('sidebar-btn-inactive', !active);
        map[btn.id].classList.toggle('hidden', !active);
      });
      if (window.innerWidth < 1024) closeSidebar();
    }

    tabTraining.addEventListener('click', ()=>activate(tabTraining));
    tabConfig.addEventListener('click', ()=>activate(tabConfig));
    tabSettings.addEventListener('click', ()=>activate(tabSettings));

    // Storage helpers
    const KEY = (s) => `chatbot_config_${s || 'anonymous'}`;
    function defaultConfig() {
      return {
        botName: 'Shop Assistant',
        botTone: 'friendly',
        welcomeMessage: 'Hi! How can I help you today?',
        training: {
          capabilities: { products: true, shipping: false, delivery: false, payments: false, voice: false },
          rules: [
            { id: crypto.randomUUID(), pattern: 'refund, return', match: 'contains', response: 'You can view our return policy here: /policies/returns' }
          ]
        },
        widget: {
          preset: 'classic',
          theme: 'indigo',
          accentColor: '#4f46e5',
          position: 'right',
          initialState: 'closed',
          headerStyle: 'solid',          // solid | gradient | glass
          bubbleStyle: 'rounded',        // rounded | square | pill
          bubbleColor: '#4f46e5',
          userBubble: { bg: '#4f46e5', fg: '#ffffff' },
          botBubble: { bg: '#ffffff', fg: '#111827', border: true },
          button: {
            type: 'text',         // 'text' | 'image'
            text: 'Chat with us',
            emoji: 'üí¨',
            textColor: '#ffffff',
            bgColor: '#4f46e5',
            radius: 999,          // px
            size: 'md',           // 'sm' | 'md' | 'lg'
            shadow: true,
            imageUrl: ''
          }
        },
        deployed: false
      };
    }

    function normalizeConfig(cfg){
      const base = defaultConfig();
      const merged = {
        ...base,
        ...cfg,
        training: {
          capabilities: { ...base.training.capabilities, ...(cfg?.training?.capabilities||{}) },
          rules: Array.isArray(cfg?.training?.rules) ? cfg.training.rules : (cfg?.training?.rules ? [cfg.training?.rules] : base.training.rules)
        },
        widget: { ...base.widget, ...(cfg?.widget||{}) }
      };
      merged.training.rules = merged.training.rules.map(r => ({ id: r.id || crypto.randomUUID(), pattern: r.pattern||'', match: r.match||'contains', response: r.response||'' }));
      // ensure widget sub-keys
      merged.widget.userBubble = { ...base.widget.userBubble, ...(cfg?.widget?.userBubble||{}) };
      merged.widget.botBubble = { ...base.widget.botBubble, ...(cfg?.widget?.botBubble||{}) };
      return merged;
    }

    async function loadConfig() {
      try {
        if (seller) {
          const r = await fetch(`${API}/chatbots/${encodeURIComponent(seller)}`);
          if (r.ok) {
            const j = await r.json();
            if (j && j.data) return normalizeConfig(j.data);
          } else if (r.status === 404) {
            let localCfg = null;
            try { localCfg = JSON.parse(localStorage.getItem(KEY(seller)) || 'null'); } catch {}
            const cfg = normalizeConfig(localCfg || defaultConfig());
            try {
              const up = await fetch(`${API}/chatbots/${encodeURIComponent(seller)}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg)
              });
              if (up.ok) {
                const j2 = await up.json();
                if (j2 && j2.data) return normalizeConfig(j2.data);
              }
            } catch(_){}
            return cfg;
          }
        }
      } catch(_){}
      try { return normalizeConfig(JSON.parse(localStorage.getItem(KEY(seller)) || 'null') || defaultConfig()); } catch { return defaultConfig(); }
    }

    async function saveConfig(cfg) {
      localStorage.setItem(KEY(seller), JSON.stringify(cfg));
      try {
        if (seller) {
          await fetch(`${API}/chatbots/${encodeURIComponent(seller)}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg)
          });
        }
      } catch(_){}
    }

    // Bind UI elements
    const statusDeployment = document.getElementById('statusDeployment');
    const trainingMsg = document.getElementById('trainingMsg');
    const configMsg = document.getElementById('configMsg');
    const settingsMsg = document.getElementById('settingsMsg');

    const botName = document.getElementById('botName');
    const botTone = document.getElementById('botTone');
    const welcomeMessage = document.getElementById('welcomeMessage');

    // Capability toggles
    const permProducts = document.getElementById('permProducts');
    const permShipping = document.getElementById('permShipping');
    const permDelivery = document.getElementById('permDelivery');
    const permPayments = document.getElementById('permPayments');

    const widgetTheme = document.getElementById('widgetTheme');
    const accentColor = document.getElementById('accentColor');
    const headerStyleSel = document.getElementById('headerStyle');
    const bubbleStyleSel = document.getElementById('bubbleStyle');
    const userBg = document.getElementById('userBg');
    const userFg = document.getElementById('userFg');
    const botBg = document.getElementById('botBg');
    const botFg = document.getElementById('botFg');
    const botBorder = document.getElementById('botBorder');
    // Voice features removed
    const position = document.getElementById('position');
    const initialState = document.getElementById('initialState');

    // Button designer controls
    const btnType = document.getElementById('btnType');
    const btnText = document.getElementById('btnText');
    const btnEmoji = document.getElementById('btnEmoji');
    const btnTextColor = document.getElementById('btnTextColor');
    const btnBgColor = document.getElementById('btnBgColor');
    const btnRadius = document.getElementById('btnRadius');
    const btnSize = document.getElementById('btnSize');
    const btnShadow = document.getElementById('btnShadow');
    const btnImageUrl = document.getElementById('btnImageUrl');
    const btnUploadFile = document.getElementById('btnUploadFile');
    const btnImagePreview = document.getElementById('btnImagePreview');

    const keywordRulesEl = document.getElementById('keywordRules');

    const addKeywordRuleBtn = document.getElementById('addKeywordRuleBtn');

    // Removed product/curated DOM references

    // Preview container
    const widgetSim = document.getElementById('widgetSim');
    let chatWindowEl; let chatInputEl; let sendBtnEl; let panelEl; let bubbleEl;

    // Super minimal style packs
    const stylePacks = document.getElementById('stylePacks');
    const templatesGrid = document.getElementById('templatesGrid');

    // Restore sample controls (soft) if missing in DOM
    function ensureSampleControls(){
      // Training Keyword Rules container exists
      if (!document.getElementById('keywordRules')){
        const container = document.createElement('div');
        container.id = 'keywordRules';
        const target = document.getElementById('panelTraining');
        if (target) target.appendChild(container);
      }
    }
    ensureSampleControls();

    // Load config
    let config = await loadConfig();

    // Ensure saveConfig exists; if not, polyfill minimal backend persistence
    if (typeof saveConfig !== 'function') {
      async function saveConfig(cfg){
        try {
          if (!seller) return; // anonymous preview only
          const payload = normalizeConfig(cfg);
          await fetch(`${API}/chatbots/${encodeURIComponent(seller)}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
          });
        } catch(_){ /* ignore */ }
      }
    }

    // Hook live preview modal controls
    const previewModal = document.getElementById('previewModal');
    const previewFrame = document.getElementById('previewFrame');
    const previewBackdrop = document.getElementById('previewBackdrop');
    const previewClose = document.getElementById('previewClose');
    const previewRebuild = document.getElementById('previewRebuild');
    const openPreviewBtn = document.getElementById('openPreview');

    function openPreview(){ previewModal.classList.remove('hidden'); buildWidgetPreview(true); }
    function closePreview(){ previewModal.classList.add('hidden'); }
    if (openPreviewBtn) openPreviewBtn.addEventListener('click', openPreview);
    if (previewClose) previewClose.addEventListener('click', closePreview);
    if (previewBackdrop) previewBackdrop.addEventListener('click', closePreview);
    if (previewRebuild) previewRebuild.addEventListener('click', ()=> buildWidgetPreview(true));

    // Populate fields (guard against missing controls)
    if (botName) botName.value = config.botName;
    if (botTone) botTone.value = config.botTone;
    if (welcomeMessage) welcomeMessage.value = config.welcomeMessage;

    // Capability toggles (persisted under training.capabilities)
    config.training.capabilities = config.training.capabilities || { products: true, shipping: false, delivery: false, payments: false };
    document.getElementById('permProducts').checked = !!config.training.capabilities.products;
    document.getElementById('permShipping').checked = !!config.training.capabilities.shipping;
    document.getElementById('permDelivery').checked = !!config.training.capabilities.delivery;
    document.getElementById('permPayments').checked = !!config.training.capabilities.payments;
    const permVoiceEl = document.getElementById('permVoice'); if (permVoiceEl) permVoiceEl.checked = !!config.training.capabilities.voice;

    if (widgetTheme) widgetTheme.value = config.widget.theme;
    if (accentColor) accentColor.value = config.widget.accentColor;
    if (headerStyleSel) headerStyleSel.value = config.widget.headerStyle || 'solid';
    if (bubbleStyleSel) bubbleStyleSel.value = config.widget.bubbleStyle || 'rounded';
    if (userBg) userBg.value = config.widget.userBubble?.bg || '#4f46e5';
    if (userFg) userFg.value = config.widget.userBubble?.fg || '#ffffff';
    if (botBg) botBg.value = config.widget.botBubble?.bg || '#ffffff';
    if (botFg) botFg.value = config.widget.botBubble?.fg || '#111827';
    if (botBorder) botBorder.checked = !!config.widget.botBubble?.border;
    if (position) position.value = config.widget.position;
    if (initialState) initialState.value = config.widget.initialState;
    // Button: hydrate from config for convenience
    const bc = config.widget.button || {};
    if (btnType) btnType.value = bc.type || 'text';
    if (btnText) btnText.value = bc.text || '';
    if (btnEmoji) btnEmoji.value = bc.emoji || 'üí¨';
    if (btnTextColor) btnTextColor.value = bc.textColor || '#ffffff';
    if (btnBgColor) btnBgColor.value = bc.bgColor || (config.widget.accentColor||'#4f46e5');
    if (btnRadius) btnRadius.value = bc.radius != null ? bc.radius : 999;
    if (btnSize) btnSize.value = bc.size || 'md';
    if (btnShadow) btnShadow.checked = !!bc.shadow;
    if (btnImageUrl) btnImageUrl.value = bc.imageUrl || '';
    if (btnImagePreview) { btnImagePreview.src = bc.imageUrl || ''; btnImagePreview.classList.toggle('hidden', !bc.imageUrl); }

    statusDeployment.textContent = config.deployed ? 'Deployed' : 'Not Deployed';
    statusDeployment.className = `pill ${config.deployed ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`;

    // Presets (removed in super minimal)
    const PRESETS = [
      { id: 'classic', name: 'Classic', preview: 'üí¨', apply: cfg => Object.assign(cfg.widget, { theme:'indigo', accentColor:'#4f46e5', headerStyle:'solid', bubbleStyle:'rounded', userBubble:{bg:'#4f46e5',fg:'#fff'}, botBubble:{bg:'#fff',fg:'#111827',border:true}, button:{...cfg.widget.button, bgColor:'#4f46e5', textColor:'#fff', emoji:'üí¨'} }) },
      { id: 'compact', name: 'Compact', preview: 'üó®Ô∏è', apply: cfg => Object.assign(cfg.widget, { theme:'slate', accentColor:'#334155', headerStyle:'solid', bubbleStyle:'square', userBubble:{bg:'#334155',fg:'#fff'}, botBubble:{bg:'#fff',fg:'#111827',border:false}, button:{...cfg.widget.button, bgColor:'#334155', textColor:'#fff', emoji:'üó®Ô∏è'} }) },
      { id: 'modern', name: 'Modern', preview: '‚ú®', apply: cfg => Object.assign(cfg.widget, { theme:'glass', accentColor:'#22d3ee', headerStyle:'glass', bubbleStyle:'rounded', userBubble:{bg:'#22d3ee',fg:'#00131a'}, botBubble:{bg:'rgba(255,255,255,0.9)',fg:'#111827',border:false}, button:{...cfg.widget.button, bgColor:'#22d3ee', textColor:'#00131a', emoji:'‚ú®'} }) },
      { id: 'neon', name: 'Neon', preview: '‚ö°', apply: cfg => Object.assign(cfg.widget, { theme:'neon', accentColor:'#f43f5e', headerStyle:'gradient', bubbleStyle:'pill', userBubble:{bg:'#f43f5e',fg:'#fff'}, botBubble:{bg:'#0f172a',fg:'#f8fafc',border:false}, button:{...cfg.widget.button, bgColor:'#f43f5e', textColor:'#fff', emoji:'‚ö°'} }) },
      { id: 'glass', name: 'Glass Morph', preview: 'üßä', apply: cfg => Object.assign(cfg.widget, { theme:'glass', accentColor:'#60a5fa', headerStyle:'glass', bubbleStyle:'rounded', userBubble:{bg:'#60a5fa',fg:'#00131a'}, botBubble:{bg:'rgba(255,255,255,0.65)',fg:'#111827',border:true}, button:{...cfg.widget.button, bgColor:'#60a5fa', textColor:'#00131a', emoji:'üßä'} }) },
      { id: 'sunset', name: 'Sunset', preview: 'üåÜ', apply: cfg => Object.assign(cfg.widget, { theme:'rose', accentColor:'#fb7185', headerStyle:'gradient', bubbleStyle:'rounded', userBubble:{bg:'#fb7185',fg:'#fff'}, botBubble:{bg:'#fff',fg:'#111827',border:false}, button:{...cfg.widget.button, bgColor:'#fb7185', textColor:'#fff', emoji:'üåÜ'} }) },
      { id: 'forest', name: 'Forest', preview: 'üå≤', apply: cfg => Object.assign(cfg.widget, { theme:'emerald', accentColor:'#10b981', headerStyle:'solid', bubbleStyle:'rounded', userBubble:{bg:'#10b981',fg:'#00131a'}, botBubble:{bg:'#fff',fg:'#111827',border:false}, button:{...cfg.widget.button, bgColor:'#10b981', textColor:'#00131a', emoji:'üå≤'} }) },
      { id: 'mono', name: 'Monochrome', preview: '‚ö´', apply: cfg => Object.assign(cfg.widget, { theme:'slate', accentColor:'#111827', headerStyle:'solid', bubbleStyle:'square', userBubble:{bg:'#111827',fg:'#fff'}, botBubble:{bg:'#fff',fg:'#111827',border:true}, button:{...cfg.widget.button, bgColor:'#111827', textColor:'#fff', emoji:'‚ö´'} }) },
    ];

    // Super minimal replaces presets rendering
    function renderStylePacks(){
      if (!stylePacks) return;
      stylePacks.innerHTML = '';
      STYLE_PACKS.forEach(p => {
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'text-left p-4 rounded-xl border bg-white hover:bg-gray-50 hover:shadow transition';
        card.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="text-2xl">${p.emoji}</div>
            <div>
              <div class="font-semibold text-gray-800">${p.name}</div>
              <div class="text-xs text-gray-500">One-click apply</div>
            </div>
          </div>`;
        card.addEventListener('click', ()=>{
          config.widget.preset = p.id;
          p.apply(config);
          if (accentColor) accentColor.value = config.widget.accentColor;
          buildWidgetPreview(true);
          renderStylePacks();
        });
        stylePacks.appendChild(card);
      });
    }

    // Super Minimal: Style Packs data and renderer
    const STYLE_PACKS = [
      { id:'clean-indigo', name:'Clean Indigo', emoji:'üí¨', apply: cfg => Object.assign(cfg.widget, { theme:'indigo', accentColor:'#4f46e5', headerStyle:'solid', bubbleStyle:'rounded', userBubble:{bg:'#4f46e5',fg:'#ffffff'}, botBubble:{bg:'#ffffff',fg:'#111827',border:true}, button:{...cfg.widget.button, type:'text', bgColor:'#4f46e5', textColor:'#ffffff', emoji:'üí¨', text:''} }) },
      { id:'glass-sky', name:'Glass Sky', emoji:'üßä', apply: cfg => Object.assign(cfg.widget, { theme:'glass', accentColor:'#60a5fa', headerStyle:'glass', bubbleStyle:'rounded', userBubble:{bg:'#60a5fa',fg:'#00131a'}, botBubble:{bg:'rgba(255,255,255,0.75)',fg:'#111827',border:true}, button:{...cfg.widget.button, type:'text', bgColor:'#60a5fa', textColor:'#00131a', emoji:'üßä', text:''} }) },
      { id:'neon-rose', name:'Neon Rose', emoji:'‚ö°', apply: cfg => Object.assign(cfg.widget, { theme:'neon', accentColor:'#f43f5e', headerStyle:'gradient', bubbleStyle:'pill', userBubble:{bg:'#f43f5e',fg:'#ffffff'}, botBubble:{bg:'#0f172a',fg:'#f8fafc',border:false}, button:{...cfg.widget.button, type:'text', bgColor:'#f43f5e', textColor:'#ffffff', emoji:'‚ö°', text:''} }) },
      { id:'emerald-fresh', name:'Emerald Fresh', emoji:'üå≤', apply: cfg => Object.assign(cfg.widget, { theme:'emerald', accentColor:'#10b981', headerStyle:'solid', bubbleStyle:'rounded', userBubble:{bg:'#10b981',fg:'#00131a'}, botBubble:{bg:'#ffffff',fg:'#111827',border:false}, button:{...cfg.widget.button, type:'text', bgColor:'#10b981', textColor:'#00131a', emoji:'üå≤', text:''} }) },
      { id:'slate-pro', name:'Slate Pro', emoji:'üó®Ô∏è', apply: cfg => Object.assign(cfg.widget, { theme:'slate', accentColor:'#334155', headerStyle:'solid', bubbleStyle:'square', userBubble:{bg:'#334155',fg:'#ffffff'}, botBubble:{bg:'#ffffff',fg:'#111827',border:true}, button:{...cfg.widget.button, type:'text', bgColor:'#334155', textColor:'#ffffff', emoji:'üó®Ô∏è', text:''} }) },
      { id:'retro-sunset', name:'Retro Sunset', emoji:'üåÜ', apply: cfg => Object.assign(cfg.widget, { theme:'rose', accentColor:'#fb7185', headerStyle:'gradient', bubbleStyle:'rounded', userBubble:{bg:'#fb7185',fg:'#ffffff'}, botBubble:{bg:'#ffffff',fg:'#111827',border:false}, button:{...cfg.widget.button, type:'text', bgColor:'#fb7185', textColor:'#ffffff', emoji:'üåÜ', text:''} }) },
    ];

    // Templates (Samples) ‚Äî richer than style packs; also set bot meta and starter rules
    const TEMPLATES = [
      {
        id: 'concise-helpdesk', name: 'Concise Helpdesk', desc: 'Quick, to-the-point support replies.', emoji: 'üß≠',
        apply: cfg => {
          cfg.botName = 'Helpdesk Bot'; cfg.botTone = 'concise'; cfg.welcomeMessage = 'Hi! I can quickly answer product, shipping, and payment questions.';
          cfg.training.rules = [
            { id: crypto.randomUUID(), pattern: 'return, refund', match: 'contains', response: 'You can return items within 30 days if unused. Need a label?' },
            { id: crypto.randomUUID(), pattern: 'shipping, delivery', match: 'contains', response: 'We ship worldwide. Standard 5‚Äì7 days, express 2‚Äì3 days.' }
          ];
          Object.assign(cfg.widget, { theme:'slate', accentColor:'#334155', headerStyle:'solid', bubbleStyle:'square', userBubble:{bg:'#334155',fg:'#ffffff'}, botBubble:{bg:'#ffffff',fg:'#111827',border:true}, button:{...cfg.widget.button, type:'text', bgColor:'#334155', textColor:'#ffffff', emoji:'üß≠', text:''} });
        }
      },
      {
        id: 'friendly-shopper', name: 'Friendly Shopper', desc: 'Warm tone and product-focused suggestions.', emoji: 'üõçÔ∏è',
        apply: cfg => {
          cfg.botName = 'Shopping Buddy'; cfg.botTone = 'friendly'; cfg.welcomeMessage = 'Hello! I can help you find great products and deals.';
          cfg.training.rules = [
            { id: crypto.randomUUID(), pattern: '@sale, discount, deals', match: 'contains', response: 'Here are some products on sale: @sale' },
            { id: crypto.randomUUID(), pattern: 'gift, present', match: 'contains', response: 'Looking for a gift? Tell me a budget or category and I‚Äôll help.' }
          ];
          Object.assign(cfg.widget, { theme:'rose', accentColor:'#fb7185', headerStyle:'gradient', bubbleStyle:'rounded', userBubble:{bg:'#fb7185',fg:'#ffffff'}, botBubble:{bg:'#ffffff',fg:'#111827',border:false}, button:{...cfg.widget.button, type:'text', bgColor:'#fb7185', textColor:'#ffffff', emoji:'üõçÔ∏è', text:''} });
        }
      },
      {
        id: 'modern-glass', name: 'Modern Glass', desc: 'Sleek glass effect, playful tone.', emoji: '‚ú®',
        apply: cfg => {
          cfg.botName = 'Modern Assistant'; cfg.botTone = 'playful'; cfg.welcomeMessage = 'Hey! Ask me about products, shipping, or promos ‚ú®';
          cfg.training.rules = [
            { id: crypto.randomUUID(), pattern: 'track, order status', match: 'contains', response: 'Use your order ID to check status on the Orders page.' },
            { id: crypto.randomUUID(), pattern: '@trending, popular', match: 'contains', response: 'Trending now: @trending' }
          ];
          Object.assign(cfg.widget, { theme:'glass', accentColor:'#60a5fa', headerStyle:'glass', bubbleStyle:'rounded', userBubble:{bg:'#60a5fa',fg:'#00131a'}, botBubble:{bg:'rgba(255,255,255,0.75)',fg:'#111827',border:true}, button:{...cfg.widget.button, type:'text', bgColor:'#60a5fa', textColor:'#00131a', emoji:'‚ú®', text:''} });
        }
      },
    ];

    function renderTemplates(){
      if (!templatesGrid) return;
      templatesGrid.innerHTML = '';
      TEMPLATES.forEach(t => {
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'text-left p-4 rounded-xl border bg-white hover:shadow transition';
        card.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="text-2xl">${t.emoji}</div>
            <div>
              <div class="font-semibold text-gray-800">${t.name}</div>
              <div class="text-xs text-gray-500">${t.desc}</div>
            </div>
          </div>`;
        card.addEventListener('click', ()=>{
          t.apply(config);
          // Sync visible controls if present
          if (widgetTheme) widgetTheme.value = config.widget.theme;
          if (accentColor) accentColor.value = config.widget.accentColor;
          if (headerStyleSel) headerStyleSel.value = config.widget.headerStyle || 'solid';
          if (bubbleStyleSel) bubbleStyleSel.value = config.widget.bubbleStyle || 'rounded';
          if (userBg) userBg.value = config.widget.userBubble?.bg || '#4f46e5';
          if (userFg) userFg.value = config.widget.userBubble?.fg || '#ffffff';
          if (botBg) botBg.value = config.widget.botBubble?.bg || '#ffffff';
          if (botFg) botFg.value = config.widget.botBubble?.fg || '#111827';
          if (botBorder) botBorder.checked = !!config.widget.botBubble?.border;
          if (botName) botName.value = config.botName;
          if (botTone) botTone.value = config.botTone;
          if (welcomeMessage) welcomeMessage.value = config.welcomeMessage;
          buildWidgetPreview(true);
        });
        templatesGrid.appendChild(card);
      });
    }

    // Initial renders
    renderStylePacks();
    renderTemplates();

    // Utility: action bar
    function actionBar(removeCb){
      const bar = document.createElement('div');
      bar.className = 'flex justify-end gap-2 mt-2';
      const rm = document.createElement('button');
      rm.className = 'btn btn-outline';
      rm.textContent = 'Remove';
      rm.addEventListener('click', removeCb);
      bar.appendChild(rm);
      return bar;
    }

    // Keyword Rules list
    function renderKeywordRules(){
      keywordRulesEl.innerHTML = '';
      if (!Array.isArray(config.training.rules)) config.training.rules = [];
      if (config.training.rules.length === 0){
        const empty = document.createElement('div');
        empty.className = 'text-sm text-gray-500';
        empty.textContent = 'No keyword rules yet.';
        keywordRulesEl.appendChild(empty);
      }
      config.training.rules.forEach(rule => {
        const card = document.createElement('div');
        card.className = 'p-4 border rounded-xl bg-white/70 backdrop-blur';
        card.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="label">Trigger Keywords</label>
              <input class="input" value="${rule.pattern||''}" />
            </div>
            <div>
              <label class="label">Match</label>
              <select class="input">
                <option value="contains" ${rule.match==='contains'?'selected':''}>Contains</option>
                <option value="exact" ${rule.match==='exact'?'selected':''}>Exact</option>
                <option value="regex" ${rule.match==='regex'?'selected':''}>Regex</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="label">Response</label>
              <textarea class="input h-20">${rule.response||''}</textarea>
            </div>
          </div>`;
        const [patternEl, matchEl, respEl] = card.querySelectorAll('input,select,textarea');
        patternEl.addEventListener('input', e => rule.pattern = e.target.value);
        matchEl.addEventListener('change', e => rule.match = e.target.value);
        respEl.addEventListener('input', e => rule.response = e.target.value);
        card.appendChild(actionBar(()=>{
          config.training.rules = config.training.rules.filter(r => r.id !== rule.id);
          renderKeywordRules();
        }));
        keywordRulesEl.appendChild(card);
      });
    }

    function newKeywordRule(){
      return { id: crypto.randomUUID(), pattern: '', match: 'contains', response: '' };
    }

    addKeywordRuleBtn.addEventListener('click', ()=>{
      config.training.rules.push(newKeywordRule());
      renderKeywordRules();
    });

    // Product Catalog + Editor (single product rules)
    function normalizeUploadUrl(img){
      if (!img || typeof img !== 'string') return '';
      let val = img.trim().replace(/\\\\/g,'/').replace(/\\/g,'/');
      if (/^(https?:)?\/\//i.test(val) || val.startsWith('data:')) return val;
      const uploadsIdx2 = val.toLowerCase().lastIndexOf('uploads/');
      if (uploadsIdx2 !== -1) {
        const clean = val.slice(uploadsIdx2 + 8);
        return `${API}/uploads/${clean.replace(/^\/+/, '')}`;
      }
      if (/^\/?uploads\//i.test(val)) {
        const clean = val.replace(/^\/?uploads\//i, '');
        return `${API}/uploads/${clean}`;
      }
      return `${API}/uploads/${val.replace(/^\/+/, '')}`;
    }

    async function tryFetchJson(url, opts){ try { const r = await fetch(url, opts); if (!r.ok) return null; return await r.json(); } catch { return null; } }

    // Cache seller products to avoid multiple calls
    let _sellerProducts = null;
    async function getSellerProducts(force=false){
      if (!force && Array.isArray(_sellerProducts)) return _sellerProducts;
      let items = [];
      if (seller) {
        const j = await tryFetchJson(`${API}/find?collection=products&seller=${encodeURIComponent(seller)}`);
        items = j && (Array.isArray(j) ? j : j.data);
      } else {
        // Preview fallback: load all products when seller is not set
        const j = await tryFetchJson(`${API}/find?collection=products`);
        items = j && (Array.isArray(j) ? j : j.data);
      }
      _sellerProducts = Array.isArray(items) ? items : [];
      return _sellerProducts;
    }

    // Helpers for bot product search/display
    async function fetchSellerProducts(force=false){
      return await getSellerProducts(force);
    }
    function tagsFromProduct(p){
      const arr = [];
      if (Array.isArray(p?.tags)) arr.push(...p.tags.map(t=>String(t).toLowerCase()));
      if (p?.category) arr.push(String(p.category).toLowerCase());
      const name = (p?.title || p?.name || '').toString().toLowerCase();
      name.split(/[^a-z0-9]+/i).forEach(w=>{ if (w && w.length>2) arr.push(w); });
      const desc = (p?.description || p?.details || p?.summary || '').toString().toLowerCase();
      desc.split(/[^a-z0-9]+/i).forEach(w=>{ if (w && w.length>2) arr.push(w); });
      // common e-commerce aspects
      ['cheapest','premium','luxury','budget','new','latest','popular','trending','discount','sale'].forEach(t=>arr.push(t));
      return Array.from(new Set(arr.filter(Boolean)));
    }
    function getPrice(p){
      const v = (p && (p.price!=null ? p.price : (p.pricing?.price)));
      const n = typeof v === 'string' ? parseFloat(v) : v;
      return Number.isFinite(n) ? n : null;
    }
    function findCheapestProduct(list){
      return (list||[]).reduce((min,p)=>{
        const pv = getPrice(p); const mv = getPrice(min);
        if (pv==null) return min;
        if (mv==null) return p;
        return pv < mv ? p : min;
      }, null);
    }

    function applyTagPrefs(products){
      const allow = Array.isArray(config?.training?.allowedTags) ? config.training.allowedTags.map(t=>t.toLowerCase()) : [];
      const block = Array.isArray(config?.training?.blockedTags) ? config.training.blockedTags.map(t=>t.toLowerCase()) : [];
      let out = Array.isArray(products) ? [...products] : [];
      // Blocked tags first
      if (block.length){
        out = out.filter(p=>{
          const toks = tagsFromProduct(p);
          return !block.some(b=> toks.includes(b));
        });
      }
      // Allowed tags narrow down if provided
      if (allow.length){
        out = out.filter(p=>{
          const toks = tagsFromProduct(p);
          return allow.some(a=> toks.includes(a));
        });
      }
      return out;
    }
    let CURRENCY = '$';
    async function resolveCurrency(){
      try{
        if (!seller) return;
        const u = await tryFetchJson(`${API}/find?collection=users&username=${encodeURIComponent(seller)}`);
        const doc = Array.isArray(u?.data) ? u.data[0] : Array.isArray(u) ? u[0] : u?.data;
        const ss = doc?.shopSettings || {};
        const code = (ss.storeCurrency || ss.currency || ss.currencyCode || '').toString().toUpperCase();
        const symFromSettings = (ss.currencySymbol || '').toString();
        const SYMBOLS = { USD:'$', NGN:'‚Ç¶', GHS:'‚Çµ', EUR:'‚Ç¨', GBP:'¬£', INR:'‚Çπ', KES:'KSh', ZAR:'R', CAD:'C$', AUD:'A$', JPY:'¬•' };
        CURRENCY = symFromSettings || SYMBOLS[code] || '$';
        // Rebuild preview to reflect currency
        try{ buildWidgetPreview(true); }catch(_){}
      }catch(_){ CURRENCY = '$'; }
    }

    function productCard(p){
      const title = p.title || p.name || 'Product';
      const id = (p._id || p.id || '').toString();
      let img = p.image || (Array.isArray(p.gallery) ? p.gallery[0] : '');
      img = normalizeImage(img);
      return `
        <a href="../detail/?id=${encodeURIComponent(id)}" class="block p-3 rounded-xl border bg-white hover:shadow transition">
          ${img?`<img src="${img}" class="w-full h-28 object-cover rounded-lg mb-2" />`:''}
          <div class="font-medium text-gray-800 truncate">${title}</div>
        </a>`;
    }

    async function catalogSearchProducts(query){
      const limit = 12;
      const items = await getSellerProducts(false);
      const q = (query||'').trim().toLowerCase();
      if (!q) return items.slice(0, limit);
      const filtered = items.filter(p => {
        const name = (p.title || p.name || '').toString().toLowerCase();
        const category = (p.category || '').toString().toLowerCase();
        const tags = Array.isArray(p.tags) ? p.tags.join(' ').toLowerCase() : '';
        return name.includes(q) || category.includes(q) || tags.includes(q);
      });
      return filtered.slice(0, limit);
    }

    function productCardMini(p){
      const title = p.title || p.name || 'Product';
      const price = (p.price!=null) ? p.price : (p.pricing?.price);
      let img = p.image || (Array.isArray(p.gallery) ? p.gallery[0] : '');
      img = normalizeUploadUrl(img);
      return `
        <div class="group p-3 rounded-xl border bg-white hover:shadow transition">
          ${img?`<img src="${img}" class="w-full h-28 object-cover rounded-lg mb-2" />`:''}
          <div class="font-medium text-gray-800 truncate">${title}</div>
          ${price!=null?`<div class="text-xs text-gray-500">$${price}</div>`:''}
          <div class="mt-2 text-xs text-indigo-600 opacity-0 group-hover:opacity-100 transition">Add rule ‚Üí</div>
        </div>`;
    }

    let editorProduct = null;

    function renderProductCatalog(items){
      productCatalog.innerHTML = '';
      productCatalogEmpty.classList.toggle('hidden', items && items.length);
      (items||[]).forEach(p => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'text-left';
        btn.innerHTML = productCardMini(p);
        btn.addEventListener('click', ()=>{
          const title = p.title || p.name || 'Product';
          const price = (p.price!=null) ? p.price : (p.pricing?.price);
          const img = normalizeUploadUrl(p.image || (Array.isArray(p.gallery) ? p.gallery[0] : ''));
          editorProduct = { id: p._id || p.id || '', title, price, image: img };
          editorProdImg.src = img;
          editorProdTitle.textContent = title;
          editorProdPrice.textContent = price!=null?`$${price}`:'';
          editorPrPattern.value = '';
          editorPrMatch.value = 'contains';
          editorPrResponse.value = '';
          productRuleEditor.classList.remove('hidden');
          productRuleEditor.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        productCatalog.appendChild(btn);
      });
    }

    async function loadCatalog(initial=false){
      const q = productSearch.value.trim();
      const items = await catalogSearchProducts(q);
      renderProductCatalog(items);
      if (initial && items && items.length) {
        const p = items[0];
        const title = p.title || p.name || 'Product';
        const price = (p.price!=null) ? p.price : (p.pricing?.price);
        const img = normalizeUploadUrl(p.image || (Array.isArray(p.gallery) ? p.gallery[0] : ''));
        editorProduct = { id: p._id || p.id || '', title, price, image: img };
        editorProdImg.src = img;
        editorProdTitle.textContent = title;
        editorProdPrice.textContent = price!=null?`$${price}`:'';
        productRuleEditor.classList.remove('hidden');
      }
    }

    let searchDebounceA;
    // Catalog UI removed; guard old listeners to avoid errors
    if (typeof productSearch !== 'undefined' && productSearch) {
      productSearch.addEventListener('input', ()=>{
        clearTimeout(searchDebounceA);
        searchDebounceA = setTimeout(()=> loadCatalog(false), 250);
      });
    }
    if (typeof reloadCatalogBtn !== 'undefined' && reloadCatalogBtn) {
      reloadCatalogBtn.addEventListener('click', ()=> loadCatalog(false));
    }
    if (typeof focusProductSearchBtn !== 'undefined' && focusProductSearchBtn) {
      focusProductSearchBtn.addEventListener('click', ()=> productSearch.focus());
    }

    if (typeof addProductRuleBtn !== 'undefined' && addProductRuleBtn) {
      addProductRuleBtn.addEventListener('click', ()=>{
        if (!editorProduct) return;
        const pr = {
          id: crypto.randomUUID(),
          productId: editorProduct.id,
          productTitle: editorProduct.title,
          productImage: editorProduct.image,
          pattern: editorPrPattern?.value?.trim() || '',
          match: editorPrMatch?.value || 'contains',
          responseTemplate: editorPrResponse?.value?.trim() || ''
        };
        if (!pr.pattern){ editorPrPattern?.focus?.(); return; }
        config.training.productRules.push(pr);
        renderProductRules?.();
        addProductRuleBtn.textContent = 'Added ‚úî';
        setTimeout(()=> addProductRuleBtn.textContent = 'Add Product Rule', 900);
      });
    }

    // Existing Product Rules list
    function renderProductRules(){
      productRulesEl.innerHTML = '';
      if (!Array.isArray(config.training.productRules)) config.training.productRules = [];
      if (config.training.productRules.length === 0){
        const empty = document.createElement('div');
        empty.className = 'text-sm text-gray-500';
        empty.textContent = 'No product rules yet.';
        productRulesEl.appendChild(empty);
      }
      config.training.productRules.forEach(pr => {
        const card = document.createElement('div');
        card.className = 'p-4 border rounded-xl bg-white/70 backdrop-blur';
        card.innerHTML = `
          <div class="flex items-start gap-3">
            ${pr.productImage ? `<img src="${pr.productImage}" class="w-12 h-12 rounded object-cover" />` : ''}
            <div class="min-w-0 flex-1">
              <div class="font-medium text-gray-800 truncate">${pr.productTitle || 'Product'}</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div>
                  <label class="label">Trigger Keywords</label>
                  <input class="input" value="${pr.pattern||''}" />
                </div>
                <div>
                  <label class="label">Match</label>
                  <select class="input">
                    <option value="contains" ${pr.match==='contains'?'selected':''}>Contains</option>
                    <option value="exact" ${pr.match==='exact'?'selected':''}>Exact</option>
                    <option value="regex" ${pr.match==='regex'?'selected':''}>Regex</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="label">Response Template</label>
                  <textarea class="input h-20">${pr.responseTemplate||''}</textarea>
                  <p class="text-xs text-gray-500 mt-1">Placeholders: {{title}}, {{price}}, {{description}}</p>
                </div>
              </div>
            </div>
          </div>`;
        const inputs = card.querySelectorAll('input,select,textarea');
        inputs[0].addEventListener('input', e => pr.pattern = e.target.value);
        inputs[1].addEventListener('change', e => pr.match = e.target.value);
        inputs[2].addEventListener('input', e => pr.responseTemplate = e.target.value);
        card.appendChild(actionBar(()=>{
          config.training.productRules = config.training.productRules.filter(r => r.id !== pr.id);
          renderProductRules();
        }));
        productRulesEl.appendChild(card);
      });
    }

    // Curated collections
    const CUR_TYPES = {
      top: 'Top Sold',
      trending: 'Trending',
      cheap: 'Cheap',
      expensive: 'Expensive',
      exclusive: 'Exclusive',
      best: 'Best Reviewed'
    };
    let curatedType = 'trending';
    let curatedSelected = new Map(); // id -> {id,title,image,price}

    function cardSelectable(p){
      const title = p.title || p.name || 'Product';
      const price = (p.price!=null) ? p.price : (p.pricing?.price);
      let img = p.image || (Array.isArray(p.gallery) ? p.gallery[0] : '');
      img = normalizeUploadUrl(img);
      const id = p._id || p.id || title+img;
      const selected = curatedSelected.has(id);
      return `
        <div class="relative p-3 rounded-xl border bg-white hover:shadow transition">
          ${img?`<img src="${img}" class="w-full h-28 object-cover rounded-lg mb-2" />`:''}
          <div class="font-medium text-gray-800 truncate">${title}</div>
          ${price!=null?`<div class="text-xs text-gray-500">$${price}</div>`:''}
          <div class="absolute top-2 right-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs ${selected?'bg-indigo-600 text-white':'bg-gray-200 text-gray-600'}">${selected?'‚úì':'+'}</span>
          </div>
        </div>`;
    }

    function renderCurated(items){
      curatedCatalog.innerHTML = '';
      curatedEmpty.classList.toggle('hidden', items && items.length);
      (items||[]).forEach(p => {
        const id = p._id || p.id || (p.title||p.name||'');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'text-left';
        btn.innerHTML = cardSelectable(p);
        btn.addEventListener('click', ()=>{
          const title = p.title || p.name || 'Product';
          const price = (p.price!=null) ? p.price : (p.pricing?.price);
          const image = normalizeUploadUrl(p.image || (Array.isArray(p.gallery)?p.gallery[0]:''));
          if (curatedSelected.has(id)) curatedSelected.delete(id); else curatedSelected.set(id, { id, title, price, image });
          curatedCount.textContent = `${curatedSelected.size} selected`;
          renderCurated(items); // re-render to update checkmarks
        });
        curatedCatalog.appendChild(btn);
      });
    }

    async function curatedFetch(type, q){
      const limit = 18;
      const qs = encodeURIComponent(q||'');
      let candidates = [];
      if (type === 'top') {
        candidates = [
          `${API}/find?collection=products&sort=-sales&limit=${limit}&search=${qs}`,
          `${API}/find?collection=products&sort=-orderCount&limit=${limit}&search=${qs}`,
          `${API}/products?sort=-sales&limit=${limit}`
        ];
      } else if (type === 'trending') {
        candidates = [
          `${API}/find?collection=products&sort=-views&limit=${limit}&search=${qs}`,
          `${API}/find?collection=products&sort=-popularity&limit=${limit}&search=${qs}`,
          `${API}/find?collection=products&sort=-createdAt&limit=${limit}&search=${qs}`
        ];
      } else if (type === 'cheap') {
        candidates = [
          `${API}/find?collection=products&sort=price&limit=${limit}&search=${qs}`,
          `${API}/products?sort=price&limit=${limit}`
        ];
      } else if (type === 'expensive') {
        candidates = [
          `${API}/find?collection=products&sort=-price&limit=${limit}&search=${qs}`,
          `${API}/products?sort=-price&limit=${limit}`
        ];
      } else if (type === 'exclusive') {
        candidates = [
          `${API}/find?collection=products&tag=exclusive&limit=${limit}&search=${qs}`,
          `${API}/find?collection=products&category=exclusive&limit=${limit}&search=${qs}`,
          `${API}/products/search?q=exclusive&limit=${limit}`
        ];
      } else if (type === 'best') {
        candidates = [
          `${API}/find?collection=products&sort=-rating&limit=${limit}&search=${qs}`,
          `${API}/find?collection=products&sort=-reviewsCount&limit=${limit}&search=${qs}`,
          `${API}/products?sort=-rating&limit=${limit}`
        ];
      }
      // Always add generic fallbacks
      candidates.push(
        `${API}/find?collection=products&search=${qs}&limit=${limit}`,
        `${API}/find?collection=products&q=${qs}&limit=${limit}`,
        `${API}/products/search?q=${qs}&limit=${limit}`,
        `${API}/products?limit=${limit}`
      );
      for (const url of candidates){
        const j = await tryFetchJson(url);
        if (j && (Array.isArray(j) ? j.length : j.data)) return Array.isArray(j) ? j : j.data;
      }
      return [];
    }

    async function loadCurated(){
      const items = await curatedFetch(curatedType, curatedSearch.value.trim());
      renderCurated(items);
    }

    if (typeof curatedButtons !== 'undefined' && curatedButtons && curatedButtons.forEach) {
      curatedButtons.forEach(btn => btn.addEventListener('click', async ()=>{
        curatedButtons.forEach(b=> b.classList.remove('btn-primary'));
        btn.classList.add('btn-primary');
        curatedType = btn.getAttribute('data-curated');
        curatedSelected.clear();
        if (typeof curatedCount !== 'undefined' && curatedCount) curatedCount.textContent = '0 selected';
        await loadCurated();
      }));
    }

    if (typeof curatedReload !== 'undefined' && curatedReload) {
      curatedReload.addEventListener('click', ()=> loadCurated());
    }
    let searchDebounceB;
    if (typeof curatedSearch !== 'undefined' && curatedSearch) {
      curatedSearch.addEventListener('input', ()=>{
        clearTimeout(searchDebounceB);
        searchDebounceB = setTimeout(()=> loadCurated(), 250);
      });
    }

    function renderCuratedRules(){
      curatedRulesEl.innerHTML = '';
      if (!Array.isArray(config.training.collectionRules)) config.training.collectionRules = [];
      if (config.training.collectionRules.length === 0){
        const empty = document.createElement('div');
        empty.className = 'text-sm text-gray-500';
        empty.textContent = 'No collection rules yet.';
        curatedRulesEl.appendChild(empty);
      }
      config.training.collectionRules.forEach(cr => {
        const card = document.createElement('div');
        card.className = 'p-4 border rounded-xl bg-white/70 backdrop-blur';
        card.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="min-w-0 flex-1">
              <div class="font-medium text-gray-800 truncate">${CUR_TYPES[cr.type]||'Collection'} ¬∑ ${cr.productIds?.length||0} items</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                <div>
                  <label class="label">Trigger Keywords</label>
                  <input class="input" value="${cr.pattern||''}" />
                </div>
                <div>
                  <label class="label">Match</label>
                  <select class="input">
                    <option value="contains" ${cr.match==='contains'?'selected':''}>Contains</option>
                    <option value="exact" ${cr.match==='exact'?'selected':''}>Exact</option>
                    <option value="regex" ${cr.match==='regex'?'selected':''}>Regex</option>
                  </select>
                </div>
                <div>
                  <label class="label">Intro</label>
                  <input class="input" value="${cr.intro||''}" />
                </div>
              </div>
            </div>
          </div>`;
        const inputs = card.querySelectorAll('input,select');
        inputs[0].addEventListener('input', e => cr.pattern = e.target.value);
        inputs[1].addEventListener('change', e => cr.match = e.target.value);
        inputs[2].addEventListener('input', e => cr.intro = e.target.value);
        card.appendChild(actionBar(()=>{
          config.training.collectionRules = config.training.collectionRules.filter(r => r.id !== cr.id);
          renderCuratedRules();
        }));
        curatedRulesEl.appendChild(card);
      });
    }

    if (typeof addCuratedRuleBtn !== 'undefined' && addCuratedRuleBtn) addCuratedRuleBtn.addEventListener('click', ()=>{
      if (curatedSelected.size === 0) { curatedCount.classList.add('text-red-600'); setTimeout(()=>curatedCount.classList.remove('text-red-600'), 900); return; }
      const cr = {
        id: crypto.randomUUID(),
        type: curatedType,
        productIds: Array.from(curatedSelected.values()).map(p=>p.id),
        pattern: curPattern.value.trim(),
        match: curMatch.value,
        intro: curIntro.value.trim() || `${CUR_TYPES[curatedType]||'Selected'} products:`
      };
      if (!cr.pattern){ curPattern.focus(); return; }
      config.training.collectionRules.push(cr);
      curatedSelected.clear();
      curatedCount.textContent = '0 selected';
      curPattern.value = '';
      curIntro.value = '';
      renderCuratedRules();
    });

    // Persist training toggles immediately on change to avoid losing state on refresh
    ['permProducts','permShipping','permDelivery','permPayments'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', async ()=>{
        config.training.capabilities = config.training.capabilities || {};
        config.training.capabilities.products = document.getElementById('permProducts')?.checked || false;
        config.training.capabilities.shipping = document.getElementById('permShipping')?.checked || false;
        config.training.capabilities.delivery = document.getElementById('permDelivery')?.checked || false;
        config.training.capabilities.payments = document.getElementById('permPayments')?.checked || false;
        try { await saveConfig(config); } catch(_){ }
      });
    });

    // Save Training (send to backend)
    document.getElementById('saveTraining').addEventListener('click', async ()=>{
      // persist keyword rules and capability toggles
      config.training.capabilities = {
        products: document.getElementById('permProducts').checked,
        shipping: document.getElementById('permShipping').checked,
        delivery: document.getElementById('permDelivery').checked,
        payments: document.getElementById('permPayments').checked,
      };

      // persist tag preferences (from settings panel inputs if present)
      const allowEl = document.getElementById('allowedTags');
      const blockEl = document.getElementById('blockedTags');
      config.training.allowedTags = allowEl ? allowEl.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean) : (config.training.allowedTags||[]);
      config.training.blockedTags = blockEl ? blockEl.value.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean) : (config.training.blockedTags||[]);

      await saveConfig(config);
      try {
        const payload = {
          meta: { name: config.botName, tone: config.botTone },
          capabilities: config.training.capabilities,
          rules: config.training.rules || [],
          tagPrefs: { allow: config.training.allowedTags||[], block: config.training.blockedTags||[] }
        };
        if (seller) {
          await fetch(`${API}/chatbots/${encodeURIComponent(seller)}/train`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
          });
        }
        trainingMsg.textContent = 'Saved and updated ‚úî';
      } catch (_) {
        trainingMsg.textContent = 'Saved locally (update failed)';
      }
      setTimeout(()=>trainingMsg.textContent='',1500);
    });

    // Load available voices for selection
    async function populateVoices(){
      try{
        const voices = window.speechSynthesis.getVoices();
        voiceSelect.innerHTML = '';
        voices.forEach(v=>{
          const opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = `${v.name} (${v.lang})${v.default?' ‚Äî default':''}`;
          voiceSelect.appendChild(opt);
        });
        const saved = config.training.voice || {};
        if (saved.name) voiceSelect.value = saved.name;
        voiceEnabled.checked = !!saved.enabled;
        // Persist checkbox state immediately to avoid losing on refresh
        config.training.voice = { ...(config.training.voice||{}), name: voiceSelect.value, enabled: voiceEnabled.checked };
        try { await saveConfig(config); } catch(_){}
      }catch(_){/* ignore */}
    }
    // Voice features removed

    // Save widget config
    document.getElementById('saveWidget').addEventListener('click', async ()=>{
      // Safely read optional controls with fallbacks
      const v = (el, d='') => (el && 'value' in el) ? el.value : d;
      const cb = (el) => !!(el && 'checked' in el && el.checked);

      config.widget.theme = v(widgetTheme, config.widget.theme || 'indigo');
      config.widget.accentColor = v(accentColor, config.widget.accentColor || '#4f46e5');
      config.widget.headerStyle = v(headerStyleSel, config.widget.headerStyle || 'solid');
      config.widget.bubbleStyle = v(bubbleStyleSel, config.widget.bubbleStyle || 'rounded');
      config.widget.userBubble = { bg: v(userBg, config.widget.userBubble?.bg || '#4f46e5'), fg: v(userFg, config.widget.userBubble?.fg || '#ffffff') };
      config.widget.botBubble = { bg: v(botBg, config.widget.botBubble?.bg || '#ffffff'), fg: v(botFg, config.widget.botBubble?.fg || '#111827'), border: cb(botBorder) };
      config.widget.position = v(position, config.widget.position || 'right');
      config.widget.initialState = v(initialState, config.widget.initialState || 'closed');
      // Button designer
      const radiusParsed = parseInt(v(btnRadius, String(config.widget.button?.radius ?? '999')), 10);
      config.widget.button = {
        ...config.widget.button,
        type: v(btnType, config.widget.button?.type || 'text'),
        text: v(btnText, config.widget.button?.text || 'Chat with us'),
        emoji: v(btnEmoji, config.widget.button?.emoji || 'üí¨'),
        textColor: v(btnTextColor, config.widget.button?.textColor || '#ffffff'),
        bgColor: v(btnBgColor, config.widget.button?.bgColor || config.widget.accentColor),
        radius: Math.max(0, Math.min(999, Number.isFinite(radiusParsed) ? radiusParsed : 999)),
        size: v(btnSize, config.widget.button?.size || 'md'),
        shadow: cb(btnShadow),
        imageUrl: v(btnImageUrl, config.widget.button?.imageUrl || '')
      };

      await saveConfig(config);
      if (configMsg) { configMsg.textContent = 'Widget configuration saved'; setTimeout(()=>{ if(configMsg) configMsg.textContent=''; },1200); }
      buildWidgetPreview(true);
    });

    // Save settings
    document.getElementById('saveSettings').addEventListener('click', async ()=>{
      config.botName = botName.value.trim() || 'Shop Assistant';
      config.botTone = botTone.value;
      config.welcomeMessage = welcomeMessage.value.trim() || 'Hi! How can I help you today?';
      // Voice features removed
      await saveConfig(config);
      settingsMsg.textContent = 'Settings saved';
      setTimeout(()=>settingsMsg.textContent='',1200);
      buildWidgetPreview(true);
    });

    // Deploy / Undeploy
    async function setDeployState(deploy){
      try{
        settingsMsg.textContent = deploy ? 'Deploying...' : 'Undeploying...';
        if (!seller){
          settingsMsg.textContent = 'Login as a seller to manage deployment';
          setTimeout(()=>settingsMsg.textContent='',1500);
          return;
        }
        let ok = false;
        const path = deploy ? 'deploy' : 'undeploy';
        let r = await fetch(`${API}/chatbots/${encodeURIComponent(seller)}/${path}`, { method: 'POST' });
        if (r.ok) ok = true;
        if (!ok){
          r = await fetch(`${API}/chatbots/${encodeURIComponent(seller)}/deploy`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: deploy ? 'deploy' : 'undeploy' })
          });
          if (r.ok) ok = true;
        }
        if (!ok){
          const cfg = { ...(normalizeConfig(config)), deployed: !!deploy };
          r = await fetch(`${API}/chatbots/${encodeURIComponent(seller)}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(cfg)
          });
          if (r.ok) ok = true;
        }
        if (!ok) throw new Error('All deploy endpoints failed');
        config.deployed = !!deploy;
        await saveConfig(config);
        statusDeployment.textContent = config.deployed ? 'Deployed' : 'Not Deployed';
        statusDeployment.className = `pill ${config.deployed ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}`;
        settingsMsg.textContent = deploy ? 'Deployed ‚úî' : 'Undeployed ‚úî';
        setTimeout(()=>settingsMsg.textContent='',1200);
      }catch(e){
        settingsMsg.textContent = 'Operation failed';
        setTimeout(()=>settingsMsg.textContent='',1500);
      }
    }

    document.getElementById('deployBot').addEventListener('click', ()=>setDeployState(true));
    document.getElementById('undeployBot').addEventListener('click', ()=>setDeployState(false));

    // Matching helper
    function firstMatching(pattern, match, input){
      const text = (input||'').trim();
      const tokens = (pattern||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
      try {
        if (match === 'contains') return tokens.some(t => text.toLowerCase().includes(t));
        if (match === 'exact') return tokens.some(t => text.toLowerCase() === t);
        if (match === 'regex') return tokens.some(t => new RegExp(t, 'i').test(text));
      } catch(_){/* ignore */}
      return false;
    }

    // Short-term memory of last shown products (for follow-ups)
    let Memory = {
      lastProducts: [],      // last displayed list
      lastPicked: null,      // last single product emphasized
    };



    function normalizeImage(img){
      if (!img || typeof img !== 'string') return '';
      let val = img.trim().replace(/\\\\/g,'/').replace(/\\/g,'/');
      if (/^https?:\/\//i.test(val) || val.startsWith('data:')) return val;
      // Support MongoDB-backed images and legacy uploads
      if (/^\/?images\//i.test(val)) {
        const clean = val.replace(/^\/?/,'/');
        return `${API}${clean}`; // e.g., /images/<id>
      }
      if (/^\/?uploads\//i.test(val)) {
        const up = val.replace(/^\/?uploads\//i,'');
        return `${API}/uploads/${up}`;
      }
      if (val.startsWith('/')) return `${API}${val}`; // absolute path
      return `${API}/uploads/${val}`; // fallback
    }

 

    function composeProductText(p, template){
      const map = {
        title: p.title || p.name || 'this product',
        price: (p.price!=null) ? p.price : (p.pricing?.price || ''),
        description: (p.description || p.details || p.summary || '').toString().slice(0, 300)
      };
      if (template){
        return template.replace(/\{\{\s*(title|price|description)\s*\}\}/g, (_,k)=> String(map[k] ?? '')) || `Here are details for ${map.title}.`;
      }
      return `Here are details for ${map.title}${map.price?` priced at ${CURRENCY}${map.price}`:''}. ${map.description?map.description:''}`;
    }

    // Widget preview UI
    function buildWidgetPreview(reset=false){
      // If preview modal iframe is open, render inside it as well for full-screen demo
      try {
        const frame = document.getElementById('previewFrame');
        if (frame && frame.contentWindow){
          const doc = frame.contentDocument || frame.contentWindow.document;
          doc.open();
          doc.write(`<!DOCTYPE html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
          <script src="https://cdn.tailwindcss.com"><\/script>
          <style>
            body{margin:0;}
            .widget-sim { position: relative; height: 100vh; }
            .widget-bubble { position: fixed; }
            .widget-panel { position: fixed; }
          </style>
          </head><body><div id="frameWidgetSim" class="widget-sim"></div></body></html>`);
          doc.close();
          // Build a temporary container and mount within iframe using same logic
          const target = doc.getElementById('frameWidgetSim');
          if (target){
            // Mirror of core logic to render bubble/panel quickly inside iframe
            const tmp = document.createElement('div');
            tmp.id = 'tmpMount';
            // reuse a simplified renderer by cloning node from main preview
            // We rebuild by calling an inner function that expects a container
          }
        }
      } catch(_){/* ignore iframe errors */}
      widgetSim.innerHTML = '';
      const theme = config.widget.theme;
      const accent = config.widget.accentColor || '#4f46e5';
      const posRight = config.widget.position !== 'left';

      // Bubble (launcher button) - text or image
      bubbleEl = document.createElement('button');
      bubbleEl.type = 'button';
      bubbleEl.className = 'widget-bubble';
      bubbleEl.style.bottom = '16px';
      bubbleEl.style[posRight ? 'right':'left'] = '16px';

      const btnCfg = config.widget.button || {};
      const btnSizePx = btnCfg.size==='lg' ? 72 : btnCfg.size==='sm' ? 48 : 56;
      bubbleEl.style.width = btnSizePx+'px';
      bubbleEl.style.height = btnSizePx+'px';
      bubbleEl.style.borderRadius = (btnCfg.radius!=null? btnCfg.radius : 999) + 'px';
      if (btnCfg.shadow) bubbleEl.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';

      if (btnCfg.type === 'image' && btnCfg.imageUrl){
        bubbleEl.style.background = 'transparent';
        // If data URL, use directly; else normalize to server path
        const src = /^data:image\//i.test(btnCfg.imageUrl) ? btnCfg.imageUrl : normalizeImage(btnCfg.imageUrl);
        bubbleEl.innerHTML = `<img src="${src}" alt="chat" style="width:100%;height:100%;object-fit:cover;border-radius:${btnCfg.radius||999}px;" />`;
        bubbleEl.title = btnCfg.text || 'Chat with us';
      } else {
        bubbleEl.style.backgroundColor = btnCfg.bgColor || accent;
        bubbleEl.style.color = btnCfg.textColor || '#fff';
        bubbleEl.textContent = (btnCfg.emoji || 'üí¨');
        if ((btnCfg.text||'').trim()) {
          // Create a small label next to icon if text provided
          const label = document.createElement('span');
          label.textContent = ' ' + btnCfg.text;
          label.style.fontSize = '12px';
          label.style.position = 'absolute';
          label.style.bottom = '4px';
          label.style[ posRight ? 'right' : 'left' ] = (btnSizePx+8)+'px';
          label.style.background = btnCfg.bgColor || accent;
          label.style.color = btnCfg.textColor || '#fff';
          label.style.padding = '6px 10px';
          label.style.borderRadius = '999px';
          label.style.boxShadow = btnCfg.shadow ? '0 6px 12px rgba(0,0,0,0.2)' : '';
          widgetSim.appendChild(label);
        }
      }

      // Panel
      panelEl = document.createElement('div');
      panelEl.className = 'widget-panel';
      panelEl.style.bottom = '80px';
      panelEl.style[posRight ? 'right':'left'] = '16px';
      panelEl.style.display = (config.widget.initialState === 'open' && !reset) ? 'flex' : 'none';

      const header = document.createElement('div');
      header.className = 'widget-header';
      // Header styles by widget.headerStyle
      if (config.widget.headerStyle === 'gradient') {
        header.style.background = `linear-gradient(135deg, ${accent}, #111827)`;
      } else if (config.widget.headerStyle === 'glass') {
        header.style.background = 'rgba(255,255,255,0.2)';
        header.style.backdropFilter = 'blur(8px)';
        header.style.color = '#111827';
      } else {
        header.style.backgroundColor = accent;
      }
      header.innerHTML = `<div class="flex items-center gap-2"><span>ü§ñ</span><span>${config.botName}</span></div><div class="flex items-center gap-2"><!-- Voice toggle removed --><button id="closeWidget" class="text-white/90 hover:text-white">‚úï</button></div>`;

      chatWindowEl = document.createElement('div');
      chatWindowEl.className = 'widget-body';

      const inputWrap = document.createElement('div');
      inputWrap.className = 'widget-input';
      chatInputEl = document.createElement('input');
      chatInputEl.className = 'input flex-1';
      chatInputEl.placeholder = 'Type a product name or message...';
      // Live search preloader and results inside panel
      const liveWrap = document.createElement('div');
      liveWrap.className = 'absolute left-3 right-3 bottom-[60px] z-10';
      liveWrap.innerHTML = `<div id="liveLoader" class="hidden text-xs text-gray-500">Searching...</div><div id="liveResults" class="mt-2 grid grid-cols-1 gap-2"></div>`;
      const liveLoader = liveWrap.querySelector('#liveLoader');
      const liveResults = liveWrap.querySelector('#liveResults');

      sendBtnEl = document.createElement('button');
      sendBtnEl.type = 'button';
      sendBtnEl.textContent = 'Send';
      sendBtnEl.className = 'widget-send';
      // Base styles
      sendBtnEl.style.padding = '10px 14px';
      const btnRadiusStyle = config.widget.bubbleStyle==='pill' ? '999px' : (config.widget.bubbleStyle==='square' ? '8px' : '12px');
      sendBtnEl.style.borderRadius = btnRadiusStyle;
      sendBtnEl.style.fontWeight = '600';
      sendBtnEl.style.border = 'none';
      sendBtnEl.style.cursor = 'pointer';
      sendBtnEl.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
      // Theme-aware styling
      const headerStyleBtn = (config.widget.headerStyle || 'solid').toLowerCase();
      if (headerStyleBtn === 'glass') {
        sendBtnEl.style.background = 'rgba(255,255,255,0.85)';
        sendBtnEl.style.color = '#111827';
        sendBtnEl.style.border = '1px solid rgba(17,24,39,0.1)';
      } else if (headerStyleBtn === 'gradient') {
        sendBtnEl.style.background = `linear-gradient(135deg, ${accent}, #111827)`;
        sendBtnEl.style.color = '#ffffff';
      } else {
        sendBtnEl.style.backgroundColor = accent;
        sendBtnEl.style.color = '#ffffff';
      }
      // Hover micro-interactions
      sendBtnEl.addEventListener('mouseenter', ()=>{ sendBtnEl.style.transform = 'translateY(-1px)'; sendBtnEl.style.boxShadow = '0 10px 16px rgba(0,0,0,0.2)'; });
      sendBtnEl.addEventListener('mouseleave', ()=>{ sendBtnEl.style.transform = 'translateY(0)'; sendBtnEl.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)'; });
      inputWrap.appendChild(chatInputEl);
      inputWrap.appendChild(sendBtnEl);

      panelEl.appendChild(header);
      panelEl.appendChild(chatWindowEl);
      panelEl.appendChild(inputWrap);
      panelEl.appendChild(liveWrap);

      // Debounced live search by name, tags, description
      let liveT;

      // Auto live rebuild of preview when editing button designer or widget controls
      const liveInputs = [widgetTheme, accentColor, headerStyleSel, bubbleStyleSel, userBg, userFg, botBg, botFg, botBorder, position, initialState, btnType, btnText, btnEmoji, btnTextColor, btnBgColor, btnRadius, btnSize, btnShadow, btnImageUrl];
      liveInputs.forEach(el=>{ if(!el) return; const evt = (el.tagName==='SELECT' || el.type==='checkbox')? 'change':'input'; el.addEventListener(evt, ()=> buildWidgetPreview(true)); });
      // Upload to data URL for instant preview
      if (btnUploadFile) {
        btnUploadFile.addEventListener('change', async ()=>{
          const f = btnUploadFile.files && btnUploadFile.files[0]; if (!f) return;
          try {
            // Upload to backend to store in MongoDB, get /images/:id URL back
            const fd = new FormData();
            fd.append('file', f);
            const r = await fetch(`${API}/images`, { method: 'POST', body: fd });
            if (!r.ok) throw new Error('upload failed');
            const js = await r.json();
            const url = js?.url || (js?.id ? `${API}/images/${js.id}` : '');
            if (btnImageUrl) btnImageUrl.value = url;
            config.widget.button = { ...(config.widget.button||{}), type: 'image', imageUrl: url };
            if (btnType) btnType.value = 'image';
            if (btnImagePreview) { btnImagePreview.src = url; btnImagePreview.classList.remove('hidden'); }
            await saveConfig(config);
            buildWidgetPreview(true);
          } catch (e) {
            // Fallback to local preview via data URL if server upload fails
            const reader = new FileReader();
            reader.onload = ()=>{
              const dataUrl = reader.result;
              if (btnImageUrl) btnImageUrl.value = dataUrl;
              config.widget.button = { ...(config.widget.button||{}), type: 'image', imageUrl: dataUrl };
              if (btnType) btnType.value = 'image';
              if (btnImagePreview) { btnImagePreview.src = dataUrl; btnImagePreview.classList.remove('hidden'); }
              buildWidgetPreview(true);
            };
            reader.readAsDataURL(f);
          }
        });
      }
      if (btnImageUrl) {
        const reflect = ()=>{
          const val = btnImageUrl.value.trim();
          if (btnImagePreview) { btnImagePreview.src = val || ''; btnImagePreview.classList.toggle('hidden', !val); }
          config.widget.button = { ...(config.widget.button||{}), imageUrl: val };
          buildWidgetPreview(true);
        };
        btnImageUrl.addEventListener('change', reflect);
        btnImageUrl.addEventListener('input', ()=>{ /* live preview without saving */ if (btnImagePreview){ const val = btnImageUrl.value.trim(); btnImagePreview.src = val || ''; btnImagePreview.classList.toggle('hidden', !val); } });
      }

      async function renderLive(q){
        if (!q || q.trim().length < 2){ liveResults.innerHTML=''; liveLoader.classList.add('hidden'); return; }
        liveLoader.classList.remove('hidden');
        const items = await fetchSellerProducts();
        const ql = q.toLowerCase();
        const hayMatch = (p)=>{
          const hay = [
            (p.title||p.name||'').toString().toLowerCase(),
            (p.description||p.details||p.summary||'').toString().toLowerCase(),
            ...(Array.isArray(p.tags)? p.tags.map(t=>String(t).toLowerCase()):[])
          ].join(' ');
          return hay.includes(ql);
        };
        const matches = applyTagPrefs(items.filter(hayMatch)).slice(0,5);
        if (matches.length){ Memory.lastProducts = matches; Memory.lastPicked = null; }
        liveResults.innerHTML = matches.length ? matches.map(productCard).join('') : '';
        liveLoader.classList.add('hidden');
      }
      chatInputEl.addEventListener('input', ()=>{ clearTimeout(liveT); liveT = setTimeout(()=>renderLive(chatInputEl.value), 250); });

      widgetSim.appendChild(bubbleEl);
      widgetSim.appendChild(panelEl);

      // Also mount into preview iframe if open
      try {
        const frame = document.getElementById('previewFrame');
        if (frame && frame.contentWindow){
          const doc = frame.contentDocument || frame.contentWindow.document;
          const container = doc.getElementById('frameWidgetSim');
          if (container){
            container.innerHTML = '';
            const iframeBubble = bubbleEl.cloneNode(true);
            const iframePanel = panelEl.cloneNode(true);
            container.appendChild(iframeBubble);
            container.appendChild(iframePanel);
            const headerClose = iframePanel.querySelector('#closeWidget');
            iframeBubble.addEventListener('click', ()=> iframePanel.style.display = 'flex');
            headerClose && headerClose.addEventListener('click', ()=> iframePanel.style.display = 'none');
          }
        }
      }catch(_){/* ignore */}

      const closeBtn = header.querySelector('#closeWidget');
      bubbleEl.addEventListener('click', ()=> panelEl.style.display = 'flex');
      closeBtn.addEventListener('click', ()=> panelEl.style.display = 'none');

      // Welcome message on build
      chatWindowEl.innerHTML = '';
      addMsg('bot', config.welcomeMessage || 'Hi!');

      // Bind send
      sendBtnEl.onclick = async () => {
        const val = (chatInputEl.value||'').trim();
        if (!val) return;
        addMsg('user', val);
        chatInputEl.value = '';
        const r = await botReply(val);
        if (r) addMsg('bot', r);
      };
      chatInputEl.onkeydown = (e)=>{ if (e.key==='Enter') sendBtnEl.click(); };

      // Gate voice toggle by training capability
      const voiceToggle = document.getElementById('voiceToggle');
      if (voiceToggle) {
        const trainingVoiceOn = !!config.training?.capabilities?.voice;
        voiceToggle.disabled = !trainingVoiceOn;
        // If training voice is off, force toggle off for safety
        if (!trainingVoiceOn) voiceToggle.checked = false;
      }
    }

    function addMsg(author, text) {
      const wrap = document.createElement('div');
      wrap.className = author === 'bot' ? 'flex items-start gap-2' : 'flex items-start gap-2 justify-end';
      const bubble = document.createElement('div');
      const userCfg = config.widget.userBubble || {}; const botCfg = config.widget.botBubble || {};
      const isBot = author==='bot';
      const bg = isBot ? (botCfg.bg||'#ffffff') : (userCfg.bg||'#4f46e5');
      const fg = isBot ? (botCfg.fg||'#111827') : (userCfg.fg||'#ffffff');
      const border = isBot && botCfg.border ? ' border' : '';
      const shape = config.widget.bubbleStyle==='pill' ? 'rounded-full' : (config.widget.bubbleStyle==='square' ? 'rounded-md' : 'rounded-xl');
      bubble.className = `max-w-[80%] px-3 py-2 ${shape} text-sm${border}`;
      bubble.style.background = bg; bubble.style.color = fg;
      bubble.textContent = text;
      wrap.appendChild(bubble);
      chatWindowEl.appendChild(wrap);
      chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
    }

    function addRichBotBlock(html){
      const wrap = document.createElement('div');
      wrap.className = 'flex items-start gap-2';
      const bubble = document.createElement('div');
      const botCfg = config.widget.botBubble || {};
      const shape = config.widget.bubbleStyle==='pill' ? 'rounded-full' : (config.widget.bubbleStyle==='square' ? 'rounded-md' : 'rounded-xl');
      bubble.className = `max-w-[80%] px-3 py-2 ${shape} text-sm`;
      bubble.style.background = botCfg.bg || '#ffffff';
      bubble.style.color = botCfg.fg || '#111827';
      if (botCfg.border) bubble.classList.add('border');
      bubble.innerHTML = html;
      wrap.appendChild(bubble);
      chatWindowEl.appendChild(wrap);
      chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
    }

    // Helpers for smarter intent understanding
    const STOPWORDS = new Set(['the','a','an','to','of','for','and','or','in','on','at','with','show','me','please','some','any','do','you','have','i','need','looking','search','find','want','give','tell']);
    const INTENT_WORDS = new Set(['cheapest','lowest','price','low','cost','budget','expensive','premium','luxury','costliest','trending','popular','bestselling','best','sellers','seller','new','latest','just','arrivals','arrival','sale','discount','deal','offer','promo','promotion','coupon','clearance','featured','recommended','hand','picked','editors','editor','pick','top','rated','rating','reviews','review','in','stock','available','ready','ship']);
    function normalizeText(s){ return (s||'').toString().toLowerCase().replace(/[^a-z0-9\s\.\-']/g,' ').replace(/\s+/g,' ').trim(); }
    function tokensOf(s){ return normalizeText(s).split(' ').filter(w=> w && !STOPWORDS.has(w)); }
    function tokensWithoutIntents(s){ return tokensOf(s).filter(w=> !INTENT_WORDS.has(w)); }
    function extractCount(s){ const m = s.match(/\b(\d{1,2})\b/); return m? Math.min(10, Math.max(1, parseInt(m[1],10))) : 3; }
    function extractPriceRange(s){
      const m1 = s.match(/under\s*([$‚Ç¶‚Çµ‚Ç¨¬£]?)(\d+(?:\.\d+)?)/i); if (m1) return {min:null, max: parseFloat(m1[2])};
      const m2 = s.match(/between\s*([$‚Ç¶‚Çµ‚Ç¨¬£]?)(\d+(?:\.\d+)?)\s*(and|to|-)\s*([$‚Ç¶‚Çµ‚Ç¨¬£]?)(\d+(?:\.\d+)?)/i); if (m2) return {min:parseFloat(m2[2]), max:parseFloat(m2[5])};
      const m3 = s.match(/(above|over|greater than)\s*([$‚Ç¶‚Çµ‚Ç¨¬£]?)(\d+(?:\.\d+)?)/i); if (m3) return {min:parseFloat(m3[3]), max:null};
      return null;
    }
    function productMatchesTokens(p, toks){
      const hay = [
        (p.title||p.name||'').toString().toLowerCase(),
        (p.description||p.details||p.summary||'').toString().toLowerCase(),
        ...(Array.isArray(p.tags)? p.tags.map(t=>String(t).toLowerCase()):[])
      ].join(' ');
      return toks.every(t=> hay.includes(t));
    }
    function resolvePronounQuery(s){ return /(it|that one|that|this|them|those)\b/i.test(s); }

    // Bot logic for preview (capabilities + keyword rules)
    async function botReply(userText){
      const text = (userText||'').trim();
      const caps = config.training.capabilities || {};

      // 1) Keyword rules (support @tag tokens)
      for (const r of (config.training.rules||[])){
        if (firstMatching(r.pattern, r.match, text)){
          // If response contains @tag(s), enrich with product cards
          const tags = (r.pattern||'').split(',').map(s=>s.trim()).filter(t=>t.startsWith('@')).map(t=>t.slice(1).toLowerCase());
          if (caps.products && tags.length){
            const products = await fetchSellerProducts();
            const picks = products.filter(p=>{
              const toks = tagsFromProduct(p);
              return tags.some(t=> toks.includes(t));
            }).slice(0,3);
            if (picks.length){
              Memory.lastProducts = picks; Memory.lastPicked = null;
              addMsg('bot', r.response || 'Here are some options:');
              addRichBotBlock(`<div class="space-y-2">${picks.map(productCard).join('')}</div>`);
              return '';
            }
          }
          return r.response || 'Okay.';
        }
      }

      // 2) Shop Q&A if enabled
      if (caps.shipping || caps.delivery || caps.payments){
        const low = text.toLowerCase();
        const u = await tryFetchJson(`${API}/find?collection=users&username=${encodeURIComponent(seller)}`);
        const sellerDoc = Array.isArray(u?.data) ? u.data[0] : Array.isArray(u) ? u[0] : u?.data;
        const shop = sellerDoc || {};
        const ss = shop.shopSettings || {};

        // Common ecommerce intents
        // Shipping fees
        if (caps.shipping && /(shipping|delivery fee|ship(ping)? cost|how much.*ship|shipping charges)/i.test(low)){
          const fees = (ss.deliveryRegions||[]).map(r=> `${r.country}${r.state?`, ${r.state}`:''}: ${CURRENCY}${r.fee||0}`);
          if (fees.length){ return `Shipping fees: ${fees.join(' | ')}`; }
        }
        // Delivery locations / service areas
        if (caps.delivery && /(deliver(y)?|ship) to|available in|locations?|where.*deliver|service areas|coverage/i.test(low)){
          const locs = (ss.deliveryRegions||[]).map(r=> `${r.country}${r.state?` (${r.state})`:''}`);
          if (locs.length){ return `We deliver to: ${locs.join(', ')}`; }
        }
        // Payment gateways / methods
        if (caps.payments && /(payment|pay|checkout|gateway|methods|cards?|mobile money|bank transfer|cash on delivery|cod)/i.test(low)){
          const list = (ss.paymentSystems||[]).map(x=> String(x)).join(', ');
          if (list){ return `Accepted payment methods: ${list}`; }
        }
        // Store hours
        if (/(opening|business|store) hours|when.*open|hours of operation/i.test(low)){
          const hours = shop.businessHours || ss.businessHours || '';
          if (hours) return `Opening hours: ${hours}`;
        }
        // Address / pickup
        if (/(address|location|where.*located|pickup|pick up)/i.test(low)){
          const addr = shop.address || ss.address || '';
          if (addr) return `Address: ${addr}`;
          const pickup = ss.pickupLocation || '';
          if (pickup) return `Pickup location: ${pickup}`;
        }
        // Contact
        if (/(contact|phone|email|reach you)/i.test(low)){
          const phone = shop.phone || ss.phone || '';
          const email = shop.email || ss.email || '';
          if (phone || email) return `Contact: ${[phone,email].filter(Boolean).join(' | ')}`;
        }
        // Returns / refunds / warranty
        if (/(return|refund|exchange|warranty|guarantee|replacement)/i.test(low)){
          const policy = shop.returnPolicy || ss.returnPolicy || shop.policy || ss.policy || '';
          if (policy) return `Policy: ${policy}`;
        }
      }

      // 3) Product queries if enabled
      if (caps.products){
        const low = text.toLowerCase();
        const tokens = tokensOf(text);
        const products = await fetchSellerProducts(true); // ensure fresh data in preview

        // Follow-ups using memory (referencing last results with pronouns)
        if (resolvePronounQuery(text) && (Memory.lastPicked || (Memory.lastProducts && Memory.lastProducts.length))){
          const target = Memory.lastPicked || Memory.lastProducts?.[0];
          if (target){
            if (/price|cost|how much/i.test(low)){
              const price = (target.price!=null)? target.price : (target.pricing?.price);
              return price!=null ? `The price for "${target.title||target.name}" is ${CURRENCY}${price}.` : `I don't have a price listed for "${target.title||target.name}".`;
            }
            if (/categor(y|ies)/i.test(low)) return target.category ? `Category: ${target.category}` : 'No category info.';
            if (/tags?/i.test(low)) return Array.isArray(target.tags) && target.tags.length ? `Tags: ${target.tags.join(', ')}` : 'No tags available.';
            if (/details?|description|about/i.test(low)){
              const d = (target.description || target.details || target.summary || '').toString();
              return d ? d : 'No details available.';
            }
          }
        }

        // Extract explicit intents
        const count = extractCount(text);
        const priceRange = extractPriceRange(text);
        const wantCheapest = /(cheapest|lowest price|min(imum)? price|lowest\-cost|low cost|budget)\b/i.test(low);
        const wantPremium = /(expensive|premium|luxury|high(ly)? priced|costliest|most expensive)\b/i.test(low);
        const wantTrending = /(best\s*sell(ers|ing)|top\s*sellers?|popular|trending|best\s*sellers?|bestselling)\b/i.test(low);
        const wantNew = /(new( products?)?|latest|just in|new arrivals?)\b/i.test(low);
        const wantSale = /(on sale|discount(ed)?|deal|offer|promo|promotion|coupon|clearance)\b/i.test(low);
        const wantFeatured = /(featured|recommended|hand\s*picked|editor'?s\s*pick)/i.test(low);
        const wantTopRated = /(top\s*rated|best\s*rated|highest\s*rated|rating|reviews?)\b/i.test(low);
        const wantInStock = /(in\s*stock|available\s*(now|today)|ready\s*stock|ready\s*to\s*ship|in\-stock)/i.test(low);

        // Name-quoted price question
        {
          const mQuoted = userText.match(/price\s*(for|of)?\s*\"([^\"]+)\"/i) || userText.match(/\"([^\"]+)\".*price/i);
          const mPlain  = userText.match(/price\s*(for|of)?\s*([\w'\-\s]{3,})/i);
          let name = null; if (mQuoted && mQuoted[2]) name = mQuoted[2].trim(); else if (mPlain && mPlain[2]) name = mPlain[2].trim();
          if (name){
            const target = products.find(p => ((p.title||p.name||'').toString().toLowerCase() === name.toLowerCase()));
            if (target){
              const price = (target.price!=null)? target.price : (target.pricing?.price);
              const displayName = target.title||target.name||name;
              return price!=null ? `The price for "${displayName}" is ${CURRENCY}${price}.` : `I don't have a price listed for "${displayName}".`;
            }
          }
        }

        // Filter by tokens (semantic-ish AND match across fields)
        // Ignore intent words for semantic filtering to focus on nouns/brands/categories
        const baseTokens = tokensWithoutIntents(text);
        let matches = baseTokens.length ? products.filter(p => productMatchesTokens(p, baseTokens)) : products;
        // If semantic match yields nothing but we have price intent, fallback to all
        if ((!matches || matches.length===0) && (wantCheapest || wantPremium || wantTrending || wantNew || wantSale || wantFeatured || wantTopRated || wantInStock)){
          matches = products;
        }
        if (priceRange){
          matches = matches.filter(p=>{
            const price = (p.price!=null)? p.price : (p.pricing?.price);
            if (price==null) return false;
            if (priceRange.min!=null && price < priceRange.min) return false;
            if (priceRange.max!=null && price > priceRange.max) return false;
            return true;
          });
        }

        if (wantCheapest){
          const cheap = findCheapestProduct(matches.filter(p=> p?.price!=null || p?.pricing?.price!=null));
          if (cheap){
            Memory.lastPicked = cheap; Memory.lastProducts = [cheap];
            const price = getPrice(cheap);
            const title = cheap.title || cheap.name || 'product';
            addMsg('bot', `The cheapest option is "${title}" at ${CURRENCY}${price}.`);
            addRichBotBlock(productCard(cheap));
            return '';
          }
        }
        if (wantPremium){
          const sorted = [...matches].filter(p=> (p?.price!=null || p?.pricing?.price!=null)).sort((a,b)=> ((b.price??b.pricing?.price??0)-(a.price??a.pricing?.price??0))).slice(0,Math.max(1,count));
          if (sorted.length){
            Memory.lastProducts = sorted; Memory.lastPicked = null;
            addMsg('bot', 'Here are premium picks:');
            addRichBotBlock(`<div class=\"space-y-2\">${sorted.map(productCard).join('')}</div>`);
            return '';
          }
        }
        if (wantTrending){
          const bySales = [...matches].sort((a,b)=> (b.sales||b.orderCount||b.views||0) - (a.sales||a.orderCount||a.views||0)).slice(0,Math.max(1,count));
          if (bySales.length){
            Memory.lastProducts = bySales; Memory.lastPicked = null;
            addMsg('bot', 'Trending now:');
            addRichBotBlock(`<div class=\"space-y-2\">${bySales.map(productCard).join('')}</div>`);
            return '';
          }
        }
        if (wantNew){
          const byNew = [...matches].sort((a,b)=> new Date(b.createdAt||0) - new Date(a.createdAt||0)).slice(0,Math.max(1,count));
          if (byNew.length){
            Memory.lastProducts = byNew; Memory.lastPicked = null;
            addMsg('bot', 'Latest arrivals:');
            addRichBotBlock(`<div class=\"space-y-2\">${byNew.map(productCard).join('')}</div>`);
            return '';
          }
        }

        // If we still have matches, return top N
        // Feature-specific slices: sale/featured/top rated/in-stock
        let working = matches;
        if (wantSale){ working = working.filter(p=> (p.strikeThroughPrice!=null && p.price!=null && p.price < p.strikeThroughPrice)); }
        if (wantFeatured){ working = working.filter(p=> !!p.featured); }
        if (wantTopRated){ working = working.sort((a,b)=> (b.rating||b.reviews||b.views||0) - (a.rating||a.reviews||a.views||0)); }
        if (wantInStock){ working = working.filter(p=> (p.inventory==null ? true : p.inventory > 0)); }

        if (working.length){
          const list = applyTagPrefs(working).slice(0, Math.max(1, count));
          Memory.lastProducts = list; Memory.lastPicked = null;
          const label = wantSale? 'On sale' : wantFeatured? 'Featured' : wantTopRated? 'Top rated' : wantInStock? 'In stock' : 'Here is what I found';
          if (list.length === 1){
            addMsg('bot', `${label}:`);
            addRichBotBlock(productCard(list[0]));
          } else {
            addMsg('bot', `${label}: showing top ${list.length}${matches?.length?` of ${matches.length}`:''}`);
            addRichBotBlock(`<div class=\"space-y-2\">${list.map(productCard).join('')}</div>`);
          }
          return '';
        }
      }

      // 4) Fallback
      // Try a smarter fallback using tokens to suggest a search
      const toks = tokensOf(text);
      if ((config.training.capabilities||{}).products && toks.length){
        const products = await fetchSellerProducts();
        const matches = products.filter(p => productMatchesTokens(p, toks)).slice(0,3);
        if (matches.length){
          addMsg('bot', 'I think you might be looking for these:');
          addRichBotBlock(`<div class="space-y-2">${matches.map(productCard).join('')}</div>`);
          Memory.lastProducts = matches; Memory.lastPicked = null;
          return '';
        }
      }
      const base = {
        friendly: "Got it! I'll help you with that.",
        professional: "Understood. I will assist with your request.",
        playful: "Roger that! Let's sort this out üòé",
        concise: "OK."
      }[config.botTone] || 'Okay.';
      return base;
    }

    // Initial renders
    await resolveCurrency();
    renderKeywordRules();
    buildWidgetPreview();

    // End script
  </script>
</body>
</html>