<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Details ‚Äì ShopRight</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‚úÖ Paystack -->
  <script src="https://js.paystack.co/v1/inline.js"></script>

  <!-- ‚úÖ Stripe -->
  <script src="https://js.stripe.com/v3/"></script>

  <!-- ‚úÖ Flutterwave -->
  <script src="https://checkout.flutterwave.com/v3.js"></script>

  <!-- ‚úÖ Razorpay -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  
  <!-- ‚úÖ Square (Optional, server setup needed too) -->
  <script type="text/javascript" src="https://sandbox.web.squarecdn.com/v1/square.js"></script>

<style>
.animate-fade-in-up {
  animation: fadeInUp 0.3s ease-out;
}
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Cool Preloader Styles */
.order-preloader {
  backdrop-filter: blur(10px);
  background: rgba(0, 0, 0, 0.8);
}

.preloader-content {
  animation: bounceIn 0.6s ease-out;
}

@keyframes bounceIn {
  0% {
    transform: scale(0.3) translateY(-50px);
    opacity: 0;
  }
  50% {
    transform: scale(1.05) translateY(0);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid rgba(99, 102, 241, 0.2);
  border-top: 6px solid #6366f1;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.pulse-text {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Success Notification Styles */
.success-modal {
  backdrop-filter: blur(15px);
  background: rgba(0, 0, 0, 0.7);
}

.success-content {
  animation: successBounce 0.8s ease-out;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

@keyframes successBounce {
  0% {
    transform: scale(0.1) rotate(-10deg);
    opacity: 0;
  }
  50% {
    transform: scale(1.1) rotate(5deg);
  }
  100% {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }
}

.success-checkmark {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(45deg, #4ade80, #22c55e);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
  animation: checkmarkPop 0.6s ease-out 0.3s both;
}

@keyframes checkmarkPop {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  50% {
    transform: scale(1.2);
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.checkmark-icon {
  font-size: 2.5rem;
  color: white;
  animation: checkmarkDraw 0.3s ease-out 0.6s both;
}

@keyframes checkmarkDraw {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.success-confetti {
  position: absolute;
  width: 100%;
  height: 100%;
  overflow: hidden;
  pointer-events: none;
}

.confetti-piece {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #fbbf24;
  animation: confettiFall 3s ease-out infinite;
}

@keyframes confettiFall {
  0% {
    transform: translateY(-100vh) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg);
    opacity: 0;
  }
}

.success-text {
  animation: slideInUp 0.6s ease-out 0.4s both;
}

@keyframes slideInUp {
  0% {
    transform: translateY(30px);
    opacity: 0;
  }
  100% {
    transform: translateY(0);
    opacity: 1;
  }
}

.glow-effect {
  box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
  animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
  from {
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
  }
  to {
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.8), 0 0 40px rgba(99, 102, 241, 0.3);
  }
}
</style>
  <style>
    /* Remove @apply, use Tailwind classes directly in HTML */
    .carousel img {
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
<!-- Header -->
<header class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-6">

    <!-- üè¨ Shop Logo & Name -->
    <div id="shopHeader" class="flex items-center gap-3 flex-shrink-0">
      <!-- Dynamically Filled by JS -->
    </div>

    <!-- Desktop actions -->
    <div class="hidden md:flex items-center gap-4">

<!-- üõí Cart Dropdown -->
<div class="relative">
  <button 
    onclick="toggleCartDropdown()" 
    class="relative flex items-center gap-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm rounded shadow-sm transition"
    aria-label="View Cart"
  >
    üõí Cart
    <span 
      id="cartCount" 
      class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow"
    >0</span>
  </button>

  <div 
    id="cartDropdown" 
    class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-lg shadow-xl z-50 p-4 space-y-3 animate-fadeIn"
  >
    <div id="cartItems" class="space-y-3 text-sm text-gray-800 max-h-80 overflow-auto">
      <p class="text-gray-500 italic">üõí Cart is empty.</p>
    </div>

    <!-- üíµ Cart Total -->
    <div class="flex justify-between items-center text-sm font-medium text-gray-700 border-t pt-2">
      <span>Total:</span>
      <span id="cartTotal">$0.00</span>
    </div>

    <!-- ‚úÖ Checkout -->
    <div class="text-right">
      <button 
        onclick="proceedToCheckout(0)" 
        class="mt-3 w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition"
      >
        ‚úÖ Proceed to Checkout
      </button>
    </div>
  </div>
</div>


      <!-- üîÅ Return Menu -->
      <div class="relative">
        <button 
          onclick="toggleReturnMenu()" 
          class="flex items-center gap-1 text-sm px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded shadow-sm transition"
          aria-haspopup="true"
        >
          üîÅ Return To
        </button>

        <div 
          id="returnMenu" 
          class="absolute top-12 right-0 bg-white border border-gray-200 rounded-lg shadow-lg px-4 py-3 space-y-2 opacity-0 pointer-events-none transform scale-95 transition-all duration-200 ease-out z-50"
        >
          <a 
            id="visitStoreBtn" 
            href="#" 
            class="block text-sm px-3 py-2 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition"
          >
            üè¨ Visit Store
          </a>
          <a 
            href="products.html" 
            class="block text-sm px-3 py-2 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition"
          >
            ‚Ü©Ô∏è Return to Marketplace
          </a>
        </div>
      </div>

      <!-- Mobile hamburger -->
      <button id="mobileMenuBtn" class="md:hidden px-3 py-2 border rounded text-gray-700" aria-label="Open menu">‚ò∞</button>
      
      <!-- Mobile dropdown -->
      <div id="mobileMenu" class="absolute right-4 top-[64px] bg-white border rounded-lg shadow-xl p-3 w-64 hidden md:hidden">
        <div class="mb-2 text-xs font-semibold text-gray-500">Menu</div>
        <a id="mobileVisitStore" href="#" class="block px-3 py-2 rounded hover:bg-gray-100">üè¨ Visit Store</a>
        <a href="products.html" class="block px-3 py-2 rounded hover:bg-gray-100">‚Ü©Ô∏è Return to Marketplace</a>
        <button onclick="showSizeGuide()" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100">üìè Size Guide</button>
        <div class="mt-2 border-t pt-2">
          <button onclick="proceedToCheckout(0)" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">‚úÖ Checkout</button>
        </div>
      </div>

    </div>
  </div>
</header>

<!-- Product Section -->
<main class="flex-grow">
<!-- üîó Breadcrumb -->
<div class="max-w-7xl mx-auto px-4 py-2 text-sm text-gray-600">
  <nav class="flex items-center gap-2">
    <a id="breadcrumbShopLink" href="#" class="text-indigo-600 hover:underline">All Products</a>
    <span>/</span>
    <span id="breadcrumbProduct" class="font-medium text-gray-800"></span>
  </nav>
</div>


  <!-- Main Product Display -->
  <section class="max-w-5xl mx-auto px-4 py-10 grid grid-cols-1 md:grid-cols-2 gap-10 items-start" id="productSection">
    <!-- Injected by JS -->
  </section>

  <!-- Related Products -->
  <section class="max-w-7xl mx-auto px-4 py-12 hidden" id="relatedSection">
    <h3 class="text-xl font-semibold mb-4">Related Products</h3>
    <div id="relatedGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
  </section>

  <!-- Store Products -->
  <section class="max-w-7xl mx-auto px-4 py-12 hidden" id="storeSection">
    <h3 class="text-xl font-semibold mb-4">More From This Store</h3>
    <div id="storeGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
  <!-- Size Guide Drawer (right side) -->
  <div id="sizeGuideModal" class="fixed inset-0 bg-black/60 z-50 hidden">
    <!-- click outside to close -->
    <div class="absolute inset-0" onclick="hideSizeGuide()"></div>
    <aside id="sizeGuidePanel" class="absolute right-0 top-0 h-full w-full sm:w-[560px] bg-white shadow-2xl p-6 sm:p-8 transform translate-x-full transition-transform duration-300">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl sm:text-2xl font-extrabold text-gray-900">TOPS & DRESSES SIZE GUIDE</h3>
        <button onclick="hideSizeGuide()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>

      <!-- Unit toggle -->
      <div class="mb-5">
        <div class="inline-flex bg-gray-100 rounded-full p-1">
          <button id="tabIn" class="px-3 py-1.5 text-sm font-medium rounded-full bg-white shadow" onclick="setSizeGuideUnit('in')">in.</button>
          <button id="tabCm" class="px-3 py-1.5 text-sm font-medium rounded-full text-gray-600" onclick="setSizeGuideUnit('cm')">cm</button>
        </div>
      </div>

      <!-- Table -->
      <div id="sizeGuideTable" class="overflow-auto">
        <!-- injected by JS -->
      </div>
    </aside>
  </div>

<!-- Checkout Modal -->
<div id="checkoutModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-end z-50 hidden">
  <div class="bg-white w-full max-w-md h-full shadow-lg overflow-auto relative transform translate-x-full transition-all duration-300 ease-in-out rounded-l-lg">

    <!-- Close Button -->
    <button onclick="hideCheckoutModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 text-xl">‚úñ</button>

    <!-- Header -->
    <div class="flex items-center justify-between gap-3 p-6 border-b">
      <div class="flex items-center gap-3">
        <img id="checkoutSellerLogo" src="" class="w-8 h-8 rounded-full object-cover border" alt="Seller Logo" />
        <h2 class="text-lg font-bold text-gray-800">Order Details</h2>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="p-6 space-y-4 pb-24 relative">

      <!-- Buyer Info -->
      <div class="space-y-3 text-sm text-gray-700" id="checkoutBuyerInfo"></div>

<!-- Selected Variant & Color Summary -->
<div class="text-sm text-gray-700 space-y-1 border-t pt-4">
  <div id="checkoutSelectedVariant" class="hidden">
    <strong>Selected Variant:</strong> <span></span>
  </div>
  <div id="checkoutSelectedColor" class="hidden">
    <strong>Selected Color:</strong> <span></span>
  </div>
</div>

      <!-- Extra Delivery Notes -->
      <div>
        <label for="buyerNotes" class="block text-sm font-medium text-gray-600">Extra Delivery Info <span class="text-red-500">*</span></label>
        <textarea id="buyerNotes" class="w-full mt-1 border rounded p-2 text-sm text-gray-700" rows="3" placeholder="e.g. gate code, delivery instructions..." required></textarea>
      </div>

      <!-- Delivery Locations -->
      <div id="checkoutDelivery" class="space-y-3 text-sm text-gray-800 border-t pt-4"></div>

      <!-- Coupon Section in Checkout -->
      <div class="border-t pt-4">
        <h4 class="font-semibold text-gray-700 mb-2">üé´ Apply Coupon</h4>
        <div class="flex gap-2">
          <input type="text" id="checkoutCouponCode" placeholder="Enter coupon code" class="flex-1 border rounded px-3 py-2 text-sm" />
          <button onclick="applyCheckoutCoupon()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-sm">Apply</button>
        </div>
        <div id="checkoutCouponMessage" class="mt-2 text-sm"></div>
      </div>

      <!-- Pricing Summary -->
      <div class="text-sm text-gray-800 space-y-1 border-t pt-4">
        <p><strong>Subtotal:</strong> <span id="checkoutSubtotal">$0.00</span></p>
        <p id="couponDiscountRow" class="text-green-600 hidden"><strong>Coupon Discount:</strong> -<span id="couponDiscount">$0.00</span></p>
        <p><strong>Delivery Fee:</strong> <span id="deliveryFee">$0.00</span></p>
        <p class="font-semibold text-lg mt-2 border-t pt-2">Total: <span id="totalPrice" class="text-indigo-700 font-bold">$0.00</span></p>
      </div>

      <!-- Confirm Order Button -->
      <button id="placeOrderBtn" onclick="placeOrder()" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
        üßæ Confirm Order
      </button>

    </div>
  </div>
</div>

<!-- Gateway Selector Modal -->
<div id="gatewayModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl p-6 w-full max-w-sm mx-auto space-y-5 shadow-xl border border-indigo-100 animate-fade-in-up">

    <!-- Title -->
    <h2 class="text-2xl font-semibold text-indigo-700 text-center flex items-center justify-center gap-2">
      <span>üí≥</span> Choose Payment Method
    </h2>

    <!-- Order Summary -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <p class="text-sm text-gray-600 mb-1">Order Total:</p>
      <p class="text-xl font-bold text-indigo-700" id="gatewayOrderTotal">$0.00</p>
    </div>

    <!-- üí≥ Gateway Selection Buttons -->
    <div id="gatewayOptions" class="space-y-3">
      <!-- Injected buttons (PayPal, Stripe, etc) go here -->
    </div>

    <!-- üîÅ Dynamic Payment UI Area (PayPal, Square, etc) -->
    <div id="gatewayPaymentContainer" class="hidden pt-4 border-t mt-2">
      <!-- Example Containers -->
      <div id="paypal-button-container" class="mt-4"></div>
      <div id="square-container" class="mt-4"></div>
      <div id="stripe-container" class="mt-4"></div>
      <!-- You can dynamically target these inside JS -->
    </div>

    <!-- ‚ùå Cancel Button -->
    <button onclick="hideGatewayPopup()" class="block mx-auto text-sm text-gray-400 hover:text-red-500 transition">
      ‚úñ Cancel
    </button>

  </div>
</div>

<!-- Delivery Method Choice Modal -->
<div id="deliveryMethodModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl p-6 w-full max-w-sm mx-auto space-y-5 shadow-xl border border-indigo-100 animate-fade-in-up">
    <!-- Title -->
    <h2 class="text-xl font-semibold text-indigo-700 text-center">üöö Choose Payment Method</h2>
    
    <!-- Description -->
    <p class="text-sm text-gray-600 text-center">Select how you'd like to pay for your order.</p>
    
    <!-- Options -->
    <div class="space-y-3">
      <button 
        id="methodDelivery" 
        class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition"
      >
        <div class="font-semibold text-gray-800">Pay on Delivery</div>
        <div class="text-xs text-gray-500">Pay cash when your order arrives</div>
      </button>
      
      <button 
        id="methodOnline" 
        class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition"
      >
        <div class="font-semibold text-gray-800">Pay Online Now</div>
        <div class="text-xs text-gray-500">Secure payment on the shop</div>
      </button>
    </div>
    
    <!-- Cancel Button -->
    <button 
      onclick="hideDeliveryMethodModal()" 
      class="block mx-auto text-sm text-gray-400 hover:text-red-500 transition"
    >
      ‚úñ Cancel
    </button>
  </div>
</div>

<!-- Cool Order Preloader -->
<div id="orderPreloader" class="fixed inset-0 order-preloader z-[100] hidden items-center justify-center">
  <div class="preloader-content bg-white rounded-2xl p-8 shadow-2xl text-center max-w-sm mx-auto glow-effect">
    <div class="spinner mx-auto mb-6"></div>
    <h3 id="preloaderTitle" class="text-xl font-bold text-indigo-700 mb-2">Processing Your Order</h3>
    <p id="preloaderMessage" class="text-gray-600 pulse-text">Please wait while we place your order...</p>
    <div class="mt-4 flex justify-center space-x-1">
      <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
      <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
      <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
    </div>
  </div>
</div>

<!-- Cool Success Modal -->
<div id="successModal" class="fixed inset-0 success-modal z-[100] hidden items-center justify-center">
  <div class="success-content rounded-3xl p-8 shadow-2xl text-center max-w-md mx-auto text-white relative overflow-hidden">
    <!-- Confetti Animation -->
    <div class="success-confetti"></div>
    
    <!-- Success Checkmark -->
    <div class="success-checkmark mx-auto mb-6">
      <span class="checkmark-icon">‚úì</span>
    </div>
    
    <!-- Success Text -->
    <div class="success-text">
      <h2 class="text-3xl font-bold mb-3">üéâ Order Placed Successfully!</h2>
      <p id="successMessage" class="text-lg mb-6 opacity-90">Your order has been confirmed and saved!</p>
      
      <!-- Order Details -->
      <div id="successOrderDetails" class="bg-white bg-opacity-20 rounded-xl p-4 mb-6 text-sm">
        <div class="flex justify-between items-center mb-2">
          <span>Order ID:</span>
          <span id="successOrderId" class="font-mono font-bold"></span>
        </div>
        <div class="flex justify-between items-center mb-2">
          <span>Total:</span>
          <span id="successOrderTotal" class="font-bold"></span>
        </div>
        <div class="flex justify-between items-center">
          <span>Payment:</span>
          <span id="successPaymentMethod" class="font-bold"></span>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="space-y-3">
        <button onclick="closeSuccessModal()" class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-200 backdrop-blur-sm">
          üõçÔ∏è Continue Shopping
        </button>
        <button onclick="goToDashboard()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-3 px-6 rounded-xl font-semibold transition-all duration-200">
          üìã Track Order
        </button>
      </div>
    </div>
  </div>
</div>

</main>

<script>
const API = "https://shop-stp5.onrender.com";
const params = new URLSearchParams(window.location.search);
const productId = params.get("id");

const productSection = document.getElementById("productSection");
const relatedSection = document.getElementById("relatedSection");
const relatedGrid = document.getElementById("relatedGrid");

const storeSection = document.getElementById("storeSection");
const storeGrid = document.getElementById("storeGrid");

const breadcrumbProduct = document.getElementById("breadcrumbProduct");
const shopHeader = document.getElementById("shopHeader");

const user = JSON.parse(localStorage.getItem("user"));

// Global variables for coupon tracking
window.appliedCoupon = null;

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function resolveUrl(path) {
  return path?.startsWith("http") ? path : `${API}${path}`;
}

function showAuthModal() {
  alert("üîê Please log in to continue.");
}
async function loadStoreProducts(seller, currentProductId, currencyCode = "USD") {
  const storeGrid = document.getElementById("storeGrid");
  const storeSection = document.getElementById("storeSection");
  
  if (!storeGrid || !storeSection) {
    console.warn("Store section or grid elements missing in DOM");
    return;
  }

  const currencySymbol = getCurrencySymbol(currencyCode);

  try {
    const res = await fetch(`${API}/find?collection=products&seller=${encodeURIComponent(seller)}`);
    const response = await res.json();
    const allProducts = response.success && response.data ? response.data : [];

    // Filter out current product and take up to 4 others
    const storeProducts = allProducts
      .filter(p => p.id !== currentProductId)
      .slice(0, 4);

    if (storeProducts.length > 0) {
      let html = "";
      storeProducts.forEach(p => {
        const img = resolveUrl(p.image);
        html += `
          <a href="product-detail.html?id=${p.id}" class="bg-white shadow-sm hover:shadow-md rounded-lg p-3 transition-all duration-200 hover:scale-[1.02] block">
            ${img ? `<div class="bg-gray-50 rounded overflow-hidden mb-2">
              <img src="${img}" class="w-full max-h-56 mx-auto object-contain" />
            </div>` : ""}
            <h4 class="text-md font-semibold text-indigo-700 truncate">${p.name}</h4>
            <p class="text-gray-800 font-bold mt-1">${currencySymbol}${parseFloat(p.price || 0).toFixed(2)}</p>
          </a>
        `;
      });
      storeGrid.innerHTML = html;
      storeSection.style.display = "block"; // Show the section
    } else {
      storeSection.style.display = "none"; // Hide if no products
    }
  } catch (err) {
    console.error("‚ùå Failed to load store products:", err);
    storeSection.style.display = "none";
  }
}
async function loadProduct() {
  if (!productId) {
    productSection.innerHTML = "<p class='text-red-500'>‚ùå No product ID provided.</p>";
    return;
  }

  try {
    const res = await fetch(`${API}/find?collection=products&id=${productId}`);
    const response = await res.json();
    const product = response.success && response.data && response.data[0] ? response.data[0] : null;
    if (!product) {
      productSection.innerHTML = "<p class='text-red-500'>‚ùå Product not found.</p>";
      return;
    }

    const shopRes = await fetch(`${API}/find?collection=users&username=${encodeURIComponent(product.seller)}`);
    const shopResponse = await shopRes.json();
    const seller = shopResponse.success && shopResponse.data && shopResponse.data[0] ? shopResponse.data[0] : null;

    // Fill mobile visit store link
    const mobileVisit = document.getElementById('mobileVisitStore');
    if (mobileVisit) mobileVisit.href = `../shop?seller=${encodeURIComponent(product.seller)}`;

    await fetch("https://shop-stp5.onrender.com/api/track-view", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ productId: product.id, seller: product.seller })
    });

    product.shopSettings = seller?.shopSettings || {};
    product.sellerLogo = seller?.customTheme?.logo || "https://placehold.co/40x40";
    product.sellerSettings = product.shopSettings;

    const currencyCode = product.shopSettings.storeCurrency || "USD";
    const currencySymbol = getCurrencySymbol(currencyCode);

    window.currentProduct = product;

    document.getElementById("visitStoreBtn").href = `shop.html?seller=${encodeURIComponent(product.seller)}`;
    document.getElementById("breadcrumbProduct").textContent = product.name;
    document.getElementById("breadcrumbShopLink").href = `products.html?seller=${encodeURIComponent(product.seller)}`;
    document.getElementById("breadcrumbShopLink").textContent = "All Products";

    const shopName = seller?.customTheme?.title || seller?.username || "Shop";
    shopHeader.innerHTML = `
      <a href="../shop?seller=${encodeURIComponent(product.seller)}" class="flex items-center gap-2 hover:underline">
        <img src="${product.sellerLogo}" alt="${shopName}" class="w-8 h-8 rounded-full border object-cover" />
        <span class="font-semibold text-indigo-700">${shopName}</span>
      </a>
    `;

    const images = [product.image, ...(product.gallery || [])].filter(Boolean).map(resolveUrl);
    window.productImages = images;
    window.currentImageIndex = 0;

    const variantHTML = (product.variants || []).map((v, i) => `
      <label class="block mb-1">
        <input type="radio" name="productVariant" value="${i}" class="mr-2" />
        ${v.name} (+${currencySymbol}${(v.price || product.price || 0).toFixed(2)})
      </label>
    `).join("");

    const colorHTML = (product.colorVariants || []).map((c, i) => `
      <label class="block mb-1">
        <input type="radio" name="productColor" value="${i}" class="mr-2" />
        <span class="inline-flex items-center gap-1">
          <div class="w-4 h-4 rounded-full border" style="background:${c.name}"></div>
          ${capitalize(c.name)} (+${currencySymbol}${(c.price || 0).toFixed(2)})
        </span>
      </label>
    `).join("");

    const thumbnails = images.map((src, i) => `
      <img src="${src}" class="w-16 h-16 object-cover rounded border cursor-pointer ${i === 0 ? 'ring-2 ring-indigo-500' : ''}" onclick="switchImage(${i})" />
    `).join("");

    const deliveryRegions = product.shopSettings.deliveryRegions || [];
    const countryFlags = [...new Set(deliveryRegions.map(r => r.country))].map(c => `
      <span class="inline-flex items-center gap-1 text-sm bg-gray-100 px-2 py-1 rounded">
        <img src="https://flagcdn.com/16x12/${c.toLowerCase()}.png" class="inline w-4 h-3 border rounded" />
        <span>${c}</span>
      </span>
    `).join(" ") || "<span class='text-sm text-gray-500'>No delivery regions available.</span>";

    const paymentSystems = product.shopSettings.paymentSystems || [];
    const gatewayIcons = {
      paypal: "https://www.paypalobjects.com/webstatic/icon/pp258.png",
      stripe: "https://img.icons8.com/color/48/stripe.png",
      paystack: "https://upload.wikimedia.org/wikipedia/commons/2/20/Paystack_Logo.png",
      flutterwave: "https://flutterwave.com/favicon.png",
      razorpay: "https://razorpay.com/favicon.png",
      square: "https://squareup.com/favicon.ico",
      shopright: "https://placehold.co/24x24?text=S",
      iyonicpay: "https://i.imgur.com/YAPRefp.png",
      khalti: "https://seeklogo.com/images/K/khalti-logo-962A1A4174-seeklogo.com.png",
      instamojo: "https://assets.instamojo.com/logo/full-logo-dark.png",
      wise: "https://wise.com/favicon.ico",
      revolut: "https://www.revolut.com/favicon.ico",
      iyzipay: "https://www.iyzico.com/favicon.ico"
    };
    const paymentHTML = paymentSystems.map(p => {
      return `
        <img src="${gatewayIcons[p] || 'https://placehold.co/24x24'}" alt="${p}" title="${capitalize(p)}"
          class="inline w-6 h-6 rounded border bg-white p-1" />
      `;
    }).join(" ") || "<span class='text-sm text-gray-500'>No payment gateways available.</span>";

    // Show Size Guide button always, not just for variants
    let sizeGuideButton = `
      <button onclick="showSizeGuide()" class="text-sm text-blue-600 hover:underline">üìè Size Guide</button>
    `;

    productSection.innerHTML = `
      <div class="space-y-4">
        <div class="relative carousel">
          <img id="mainImage" src="${images[0]}" class="w-full rounded-lg shadow object-contain max-h-[450px]" />
          <button onclick="navigateImage(-1)" class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-white p-2 rounded-full shadow hover:bg-indigo-100">&#8592;</button>
          <button onclick="navigateImage(1)" class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-white p-2 rounded-full shadow hover:bg-indigo-100">&#8594;</button>
        </div>
        <div class="flex gap-2 overflow-x-auto">${thumbnails}</div>
      </div>

      <div class="space-y-4">
        <h2 class="text-3xl font-bold text-indigo-700">${product.name}</h2>
        <p class="text-gray-600">${product.description || "No description available."}</p>
        <p class="text-2xl font-bold text-gray-800">${currencySymbol}${(product.price || 0).toFixed(2)}</p>

        <div class="flex flex-wrap gap-2 mt-3">
          ${product.category ? `<span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs">${capitalize(product.category)}</span>` : ""}
          ${(product.tags || []).map(t => `<span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs">#${capitalize(t)}</span>`).join("")}
        </div>

        ${variantHTML ? `
          <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-gray-700">Available Sizes/Variants</h4>
              ${sizeGuideButton}
            </div>
            ${variantHTML}
          </div>` : ""}

        ${colorHTML ? `
          <div class="mt-4">
            <h4 class="font-semibold text-gray-700 mb-2">Available Colors</h4>
            ${colorHTML}
          </div>` : ""}

        <!-- Always show Size Guide button if no variants -->
        ${!variantHTML ? `
          <div class="mt-2">
            ${sizeGuideButton}
          </div>
        ` : ""}

        <div class="text-sm text-gray-600 mt-2">
          <strong>Shipping Info:</strong> ${product.shipping || "Ships within 2-3 days"}
        </div>

        <!-- Payment Method Information -->
        <div class="text-sm text-gray-600 mt-2">
          <strong>Payment Method:</strong>
          <span class="inline-flex items-center gap-1">
            ${getPaymentMethodDisplay(product.shopSettings?.paymentMethod || "delivery")}
          </span>
        </div>

        <div class="mt-6 space-y-2">
          <div>
            <h4 class="font-semibold text-gray-700 mb-1">üåç Delivery Regions</h4>
            <div class="flex flex-wrap gap-2">${countryFlags}</div>
          </div>
          <div>
            <h4 class="font-semibold text-gray-700 mb-1">üí≥ Payment Gateways</h4>
            <div class="flex flex-wrap gap-3 items-center">${paymentHTML}</div>
          </div>
        </div>

        <!-- Coupon Section -->
        <div class="mt-6">
          <h4 class="font-semibold text-gray-700 mb-2">üé´ Apply Coupon</h4>
          <div class="flex gap-2">
            <input type="text" id="couponCode" placeholder="Enter coupon code" class="flex-1 border rounded px-3 py-2 text-sm" />
            <button onclick="applyCoupon()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-sm">Apply</button>
          </div>
          <div id="couponMessage" class="mt-2 text-sm"></div>
        </div>

        <div class="flex flex-wrap gap-4 mt-6 items-center">
          <button onclick="handleBuy('${product.id}')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Buy Now</button>
          <button onclick="handleCart('${product.id}')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Add to Cart</button>
          <button onclick="handleWishlist('${product.id}')" class="bg-pink-100 text-pink-700 px-4 py-2 rounded hover:bg-pink-200">üíñ Wishlist</button>
          <button onclick="navigator.clipboard.writeText(location.href);this.textContent='‚úî Copied!';setTimeout(()=>this.textContent='üîó Share Product',2000)" class="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200">üîó Share Product</button>
        </div>
      </div>
    `;

    // ‚úÖ Pass correct currencyCode here
    loadRelated(product, currencyCode);
    loadStoreProducts(product.seller, product.id, currencyCode);

    renderCartDropdown();

  } catch (err) {
    console.error(err);
    productSection.innerHTML = "<p class='text-red-500'>‚ö†Ô∏è Error loading product.</p>";
  }
}

function getCurrencySymbol(code) {
  const map = {
    USD: "$", EUR: "‚Ç¨", GBP: "¬£", NGN: "‚Ç¶", INR: "‚Çπ", KES: "KSh", ZAR: "R"
  };
  return map[code] || code;
}

function switchImage(index) {
  const main = document.getElementById("mainImage");
  if (!window.productImages || index < 0 || index >= window.productImages.length) return;
  main.src = window.productImages[index];
  window.currentImageIndex = index;
  document.querySelectorAll("#productSection .carousel + div img").forEach((thumb, i) => {
    thumb.classList.toggle("ring-2", i === index);
    thumb.classList.toggle("ring-indigo-500", i === index);
  });
}

function navigateImage(step) {
  const nextIndex = (window.currentImageIndex + step + window.productImages.length) % window.productImages.length;
  switchImage(nextIndex);
}

loadProduct();

function getPaymentMethodDisplay(paymentMethod) {
  switch(paymentMethod) {
    case "delivery":
      return "üöö Pay on Delivery";
    case "online":
      return "üí≥ Pay on Shop";
    case "both":
      return "üîÑ Pay on Delivery or Online";
    default:
      return "üöö Pay on Delivery";
  }
}

async function loadRelated(product, currencyCode = "USD") {
  if (!product?.category || !product?.seller) return;

  const relatedGrid = document.getElementById("relatedGrid");
  const relatedSection = document.getElementById("relatedSection");
  if (!relatedGrid || !relatedSection) {
    console.warn("Related section or grid elements missing in DOM");
    return;
  }

  const currencySymbol = getCurrencySymbol(currencyCode);

  try {
    const res = await fetch(`${API}/find?collection=products&seller=${encodeURIComponent(product.seller)}`);
    const response = await res.json();
    const all = response.success && response.data ? response.data : [];

    const filtered = all
      .filter(p => p.id !== product.id && p.category?.toLowerCase() === product.category.toLowerCase())
      .slice(0, 4);

    if (filtered.length > 0) {
      let html = "";

      filtered.forEach(p => {
        const img = resolveUrl(p.image);
        html += `
          <a href="../detail?id=${p.id}" class="bg-white shadow-sm hover:shadow-md rounded-lg p-3 transition-all duration-200 hover:scale-[1.02] block">
            ${img ? `<div class="bg-gray-50 rounded overflow-hidden mb-2">
              <img src="${img}" class="w-full max-h-56 mx-auto object-contain" />
            </div>` : ""}
            <h4 class="text-md font-semibold text-indigo-700 truncate">${p.name}</h4>
            <p class="text-gray-800 font-bold mt-1">${currencySymbol}${parseFloat(p.price || 0).toFixed(2)}</p>
          </a>
        `;
      });

      storeSection.style.display = "block";
    }
  } catch (err) {
    console.error("‚ùå Store products failed", err);
  }
}




let cart = JSON.parse(localStorage.getItem("cart")) || [];

function resolveImage(src) {
  if (!src) return "https://placehold.co/64x64";
  if (src.startsWith("http://") || src.startsWith("https://")) return src;
  return resolveUrl(src); // keep this if you're using relative paths
}

function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCartDropdown();
}

function updateCartCount() {
  const count = cart.reduce((sum, item) => sum + (item.qty || 0), 0);
  document.getElementById("cartCount").textContent = count;
}

function toggleCartDropdown() {
  document.getElementById("cartDropdown").classList.toggle("hidden");
}

// Mobile menu toggle
(function(){
  const btn = document.getElementById('mobileMenuBtn');
  const menu = document.getElementById('mobileMenu');
  if(!btn || !menu) return;
  btn.addEventListener('click', ()=>{
    menu.classList.toggle('hidden');
  });
  // close on outside click
  document.addEventListener('click', (e)=>{
    if(!menu.classList.contains('hidden')){
      const withinMenu = menu.contains(e.target);
      const onBtn = btn.contains(e.target);
      if(!withinMenu && !onBtn){ menu.classList.add('hidden'); }
    }
  });
  // close on escape
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){ menu.classList.add('hidden'); }
  });
})();

function renderCartDropdown() {
  const container = document.getElementById("cartItems");
  container.innerHTML = "";

  if (!cart.length) {
    container.innerHTML = `<p class="text-gray-500 italic">üõí Cart is empty.</p>`;
    updateCartCount();
    document.getElementById("cartTotal").innerText = "$0.00";
    return;
  }

  let total = 0;

  cart.forEach((item, index) => {
    let basePrice = item.price || 0;
    let variantLabel = "";
    let colorLabel = "";
    let itemTotal = 0;

    if (item.variant?.price) {
      basePrice = item.variant.price;
      variantLabel = `<div class="text-xs text-gray-500">Variant: ${item.variant.name}</div>`;
    }

    if (item.color?.price) {
      basePrice += item.color.price;
      colorLabel = `<div class="text-xs text-gray-500">Color: ${item.color.name}</div>`;
    }

    itemTotal = basePrice * item.qty;
    total += itemTotal;

    const currencyCode = item.shopSettings?.storeCurrency || "USD";
    const currencySymbol = getCurrencySymbol(currencyCode);

    container.innerHTML += `
      <div class="flex items-start gap-3 mb-4">
        <img src="${resolveImage(item.image)}" class="w-16 h-16 object-cover rounded border" />
        <div class="flex-1">
          <h4 class="font-semibold">${item.name}</h4>
          ${variantLabel}
          ${colorLabel}
          <p class="text-sm text-gray-500">${currencySymbol}${basePrice.toFixed(2)} √ó ${item.qty}</p>
          <div class="flex gap-2 mt-2 items-center">
            <button onclick="changeQty(${index}, -1)" class="px-2 py-1 border rounded text-sm">‚àí</button>
            <button onclick="changeQty(${index}, 1)" class="px-2 py-1 border rounded text-sm">+</button>
            <button onclick="removeFromCart(${index})" class="px-2 py-1 text-red-500 hover:underline text-sm ml-auto">üóë Remove</button>
          </div>
        </div>
      </div>
    `;
  });

  // Use first item's currency for total display
  const firstCurrencyCode = cart[0]?.shopSettings?.storeCurrency || "USD";
  const symbol = getCurrencySymbol(firstCurrencyCode);

  updateCartCount();
  document.getElementById("cartTotal").innerText = `${symbol}${total.toFixed(2)}`;
}

function changeQty(index, delta) {
  if (!cart[index]) return;
  cart[index].qty += delta;
  if (cart[index].qty <= 0) cart.splice(index, 1);
  saveCart();
}

function removeFromCart(index) {
  if (!cart[index]) return;
  cart.splice(index, 1);
  saveCart();
}

function proceedToCheckout(index = 0) {
  if (!cart.length) return alert("üõí Your cart is empty.");

  const item = cart[index];
  if (!item) return alert("‚ùå Invalid cart item selected.");

  const product = {
    id: item.id,
    name: item.name,
    image: item.image,
    price: item.price,
    qty: item.qty,
    variant: item.variant || null,
    color: item.color || null,
    variants: item.variants || [],
    colorVariants: item.colorVariants || [],
    sellerLogo: item.sellerLogo || "",
    shopSettings: item.shopSettings || {}
  };

  toggleCartDropdown();
  showCheckoutModal(product, item.qty);
}

function handleCart(productId) {
  const product = window.currentProduct;
  if (!product) return alert("‚ùå Product not loaded.");

  const selectedVariant = document.querySelector('input[name="productVariant"]:checked');
  const selectedColor = document.querySelector('input[name="productColor"]:checked');

  if (product.variants?.length && !selectedVariant)
    return alert("‚ö†Ô∏è Please select a size or variant first.");
  if (product.colorVariants?.length && !selectedColor)
    return alert("‚ö†Ô∏è Please select a color first.");

  const variant = selectedVariant ? product.variants[selectedVariant.value] : null;
  const color = selectedColor ? product.colorVariants[selectedColor.value] : null;

  const cartItem = {
    id: product.id,
    name: product.name,
    image: product.image,
    price: product.price,
    variant,
    color,
    qty: 1,
    seller: product.seller,
    sellerLogo: product.sellerLogo || "",
    shopSettings: product.shopSettings || {},      // ‚úÖ Include shop settings with currency
    buyer: window.currentUser?.email || "anonymous",
    createdAt: Date.now()
  };

  cart.push(cartItem);
  saveCart();

  fetch("https://shop-stp5.onrender.com/add-cart", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(cartItem)
  })
    .then(res => res.json())
    .then(data => {
      alert("‚úÖ Added to cart!");
    })
    .catch(err => {
      console.error("‚ùå Cart saving failed", err);
      alert("‚ùå Failed to add to cart.");
    });
}

async function handleWishlist(productId) {
  if (!user?.email) return showLoginModal();

  try {
    const res = await fetch(`${API}/add-wishlist`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        buyer: user.email,
        productId
      })
    });

    if (!res.ok) {
      const err = await res.json();
      alert("‚ùå Failed to add to wishlist: " + (err.message || "Unknown error"));
      return;
    }

    alert("üíñ Added to wishlist!");
  } catch (e) {
    console.error("Wishlist Error:", e);
    alert("‚ùå Network error while adding to wishlist.");
  }
}


function showLoginModal() {
  const modal = document.createElement("div");
  modal.className = "fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-lg p-6 w-96 relative">
      <button onclick="this.parentElement.parentElement.remove()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500">‚úñ</button>
      <h2 class="text-lg font-semibold mb-4 text-indigo-700">You need to log in</h2>
      <p class="mb-4 text-sm text-gray-600">To use the wishlist, please log in or create an account.</p>
      <div class="flex justify-between gap-4">
        <a href="../login" class="w-full bg-indigo-600 text-white py-2 rounded text-center hover:bg-indigo-700">Log In</a>
        <a href="../signup" class="w-full bg-gray-200 text-gray-800 py-2 rounded text-center hover:bg-gray-300">Sign Up</a>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}
function toggleReturnMenu() {
  const menu = document.getElementById("returnMenu");
  const isVisible = menu.classList.contains("opacity-100");

  if (isVisible) {
    menu.classList.remove("opacity-100", "translate-x-0", "pointer-events-auto");
    menu.classList.add("opacity-0", "-translate-x-8", "pointer-events-none");
  } else {
    menu.classList.remove("opacity-0", "-translate-x-8", "pointer-events-none");
    menu.classList.add("opacity-100", "translate-x-0", "pointer-events-auto");
  }
}
// --- Size Guide Drawer Logic ---
let sizeGuideUnit = 'in';
function setSizeGuideUnit(unit){
  sizeGuideUnit = unit;
  document.getElementById('tabIn').classList.toggle('bg-white', unit==='in');
  document.getElementById('tabIn').classList.toggle('text-gray-900', unit==='in');
  document.getElementById('tabIn').classList.toggle('text-gray-600', unit!=='in');
  document.getElementById('tabCm').classList.toggle('bg-white', unit==='cm');
  document.getElementById('tabCm').classList.toggle('text-gray-900', unit==='cm');
  document.getElementById('tabCm').classList.toggle('text-gray-600', unit!=='cm');
  renderSizeGuideTable();
}

function showSizeGuide(){
  const modal = document.getElementById('sizeGuideModal');
  const panel = document.getElementById('sizeGuidePanel');
  modal.classList.remove('hidden');
  requestAnimationFrame(()=>{ panel.classList.remove('translate-x-full'); });
  renderSizeGuideTable();
}

function hideSizeGuide(){
  const modal = document.getElementById('sizeGuideModal');
  const panel = document.getElementById('sizeGuidePanel');
  panel.classList.add('translate-x-full');
  setTimeout(()=>{ modal.classList.add('hidden'); }, 250);
}

function toCm(val){
  return Math.round(val * 2.54 * 10) / 10;
}

function renderSizeGuideTable(){
  const tableWrap = document.getElementById('sizeGuideTable');
  const guide = (window.currentProduct?.shopSettings?.sizeGuide) || {};

  // Fallbacks by category type if shop has presets
  const category = (window.currentProduct?.category || '').toLowerCase();
  const isShoes = category.includes('shoe') || guide.type === 'shoes';
  const isBottoms = category.includes('jean') || category.includes('bottom') || guide.type === 'bottoms';

  // If seller saved a custom table: expect an array of rows with arbitrary columns
  if (Array.isArray(guide.table) && Array.isArray(guide.columns)) {
    const cols = guide.columns; // e.g., ['Size','Bust','Waist','Hips','US/CAN'] or ['Size','US/CAN','UK','EU','AUS']
    const header = `
      <div class="mb-3 text-sm text-gray-600">${guide.title || ''}</div>
      <table class="w-full text-sm border-separate border-spacing-0">
        <thead>
          <tr class="bg-gray-100 text-gray-700">
            ${cols.map(c => `<th class='text-left py-2 px-3 font-semibold'>${c}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
    `;

    function convertText(val){
      if(sizeGuideUnit==='in') return val;
      // convert any numeric inches we find to cm
      return String(val).replace(/\d+(?:\.\d+)?/g, (m)=> (Math.round(parseFloat(m)*2.54*10)/10).toString());
    }

    const body = guide.table.map(row => `
      <tr class="border-b">
        ${cols.map(c => `<td class='py-2 px-3'>${convertText(row[c] ?? '')}</td>`).join('')}
      </tr>
    `).join('');

    tableWrap.innerHTML = header + body + '</tbody></table>';
    return;
  }

  // Default presets (if seller did not save a custom table)
  const topsRows = [
    { size:'XS', bust:'32-33', waist:'24-25', hips:'35-36', us:'0/1' },
    { size:'S',  bust:'34-35', waist:'26-27', hips:'37-38', us:'3/5' },
    { size:'M',  bust:'36-37', waist:'28-29', hips:'39-40', us:'7/9' },
    { size:'L',  bust:'38.5-40', waist:'30.5-32', hips:'41.5-43', us:'11/13' },
    { size:'XL', bust:'41.5', waist:'33-34', hips:'44-45', us:'15' },
    { size:'1X', bust:'44-45.5', waist:'37-38.5', hips:'47-48.5', us:'14/16' },
    { size:'2X', bust:'47-49', waist:'40-42', hips:'50-52', us:'18/20' },
    { size:'3X', bust:'51-53', waist:'44-46', hips:'54-56', us:'22/24' },
  ];
  const bottomsRows = [
    { size:'XS', waist:'24-25', hips:'35-36', us:'0/1' },
    { size:'S',  waist:'26-27', hips:'37-38', us:'3/5' },
    { size:'M',  waist:'28-29', hips:'39-40', us:'7/9' },
    { size:'L',  waist:'30.5-32', hips:'41.5-43', us:'11/13' },
    { size:'XL', waist:'33 1/2', hips:'44 1/2', us:'15' },
    { size:'1X', waist:'37-38.5', hips:'47-48.5', us:'14/16' },
    { size:'2X', waist:'40-42', hips:'50-52', us:'18/20' },
    { size:'3X', waist:'44-46', hips:'54-56', us:'22/24' },
  ];
  const shoesRows = [
    { size:'5',  'US/CAN':'5',  UK:'3',   EU:'35-36', AUS:'5' },
    { size:'5.5','US/CAN':'5.5',UK:'3.5', EU:'36',    AUS:'5.5' },
    { size:'6',  'US/CAN':'6',  UK:'4',   EU:'36-37', AUS:'6' },
    { size:'6.5','US/CAN':'6.5',UK:'4.5', EU:'37',    AUS:'6.5' },
    { size:'7',  'US/CAN':'7',  UK:'5',   EU:'37-38', AUS:'7' },
    { size:'7.5','US/CAN':'7.5',UK:'5.5', EU:'38',    AUS:'7.5' },
    { size:'8',  'US/CAN':'8',  UK:'6',   EU:'38-39', AUS:'8' },
    { size:'8.5','US/CAN':'8.5',UK:'6.5', EU:'39',    AUS:'8.5' },
    { size:'9',  'US/CAN':'9',  UK:'7',   EU:'39-40', AUS:'9' },
    { size:'10', 'US/CAN':'10', UK:'7.5', EU:'40-41', AUS:'10' },
    { size:'11', 'US/CAN':'11', UK:'8',   EU:'41-42', AUS:'11' },
  ];

  function convertRange(text){
    if(sizeGuideUnit==='in') return text;
    return String(text).replace(/\d+(?:\.\d+)?/g, (m)=> (Math.round(parseFloat(m)*2.54*10)/10).toString());
  }

  if (isShoes) {
    const cols = ['Size','US/CAN','UK','EU','AUS'];
    const header = `
      <div class="mb-3 text-sm text-gray-600">${guide.title || "Women's Shoes Size Guide"}</div>
      <table class="w-full text-sm border-separate border-spacing-0">
        <thead>
          <tr class="bg-gray-100 text-gray-700">${cols.map(c=>`<th class='text-left py-2 px-3 font-semibold'>${c}</th>`).join('')}</tr>
        </thead>
        <tbody>
    `;
    const body = shoesRows.map(r => `
      <tr class="border-b">
        ${cols.map(c => `<td class='py-2 px-3'>${r[c] || ''}</td>`).join('')}
      </tr>
    `).join('');
    tableWrap.innerHTML = header + body + '</tbody></table>';
    return;
  }

  if (isBottoms) {
    const cols = ['Size','Waist','Hips','US/CAN'];
    const header = `
      <div class="mb-3 text-sm text-gray-600">${guide.title || 'Jeans & Bottoms Size Guide'}</div>
      <table class="w-full text-sm border-separate border-spacing-0">
        <thead>
          <tr class="bg-gray-100 text-gray-700">${cols.map(c=>`<th class='text-left py-2 px-3 font-semibold'>${c}</th>`).join('')}</tr>
        </thead>
        <tbody>
    `;
    const body = bottomsRows.map(r => `
      <tr class="border-b">
        <td class='py-2 px-3'>${r.size}</td>
        <td class='py-2 px-3'>${convertRange(r.waist)}</td>
        <td class='py-2 px-3'>${convertRange(r.hips)}</td>
        <td class='py-2 px-3'>${r.us}</td>
      </tr>
    `).join('');
    tableWrap.innerHTML = header + body + '</tbody></table>';
    return;
  }

  // Tops & dresses default
  const cols = ['Size','Bust','Waist','Hips','US/CAN'];
  const header = `
    <div class="mb-3 text-sm text-gray-600">${guide.title || 'Tops & Dresses Size Guide'}</div>
    <table class="w-full text-sm border-separate border-spacing-0">
      <thead>
        <tr class="bg-gray-100 text-gray-700">${cols.map(c=>`<th class='text-left py-2 px-3 font-semibold'>${c}</th>`).join('')}</tr>
      </thead>
      <tbody>
  `;
  const body = topsRows.map(r => `
    <tr class="border-b">
      <td class='py-2 px-3'>${r.size}</td>
      <td class='py-2 px-3'>${convertRange(r.bust)}</td>
      <td class='py-2 px-3'>${convertRange(r.waist)}</td>
      <td class='py-2 px-3'>${convertRange(r.hips)}</td>
      <td class='py-2 px-3'>${r.us}</td>
    </tr>
  `).join('');
  tableWrap.innerHTML = header + body + '</tbody></table>';
}


function handleBuy(productId) {
  if (!user) return showLoginModal();

  const product = window.currentProduct;
  if (!product) return alert("‚ùå Product not loaded.");

  const selectedVariant = document.querySelector('input[name="productVariant"]:checked');
  const selectedColor = document.querySelector('input[name="productColor"]:checked');

  if (product.variants?.length && !selectedVariant)
    return alert("‚ö†Ô∏è Please select a size or variant first.");
  if (product.colorVariants?.length && !selectedColor)
    return alert("‚ö†Ô∏è Please select a color first.");

  const shopLogo = shopHeader.querySelector("img")?.src || "";
  const shopName = shopHeader.querySelector("span")?.textContent || "Shop";

  showCheckoutModal({
    ...product,
    selectedVariantIndex: selectedVariant?.value,
    selectedColorIndex: selectedColor?.value,
    sellerLogo: shopLogo,
    sellerName: shopName,
    shopSettings: product.shopSettings || product.sellerSettings || {}
  });
}

function showCheckoutModal(product, qty = 1) {
  if (!user) return showLoginModal();

  const variantInput = document.querySelector('input[name="productVariant"]:checked');
  const colorInput = document.querySelector('input[name="productColor"]:checked');

  if (product.variants?.length && !variantInput)
    return alert("Please select a product variant before proceeding.");
  if (product.colorVariants?.length && !colorInput)
    return alert("Please select a color before proceeding.");

  const selectedVariant = product.variants?.[variantInput?.value] || null;
  const selectedColor = product.colorVariants?.[colorInput?.value] || null;

  window.currentProduct = product;
  window.currentCartQty = qty;
  window.selectedVariant = selectedVariant;
  window.selectedColor = selectedColor;
  
  // Clear any applied coupon when opening checkout
  window.appliedCoupon = null;

  const modal = document.getElementById("checkoutModal");
  modal.classList.remove("hidden");
  setTimeout(() => modal.querySelector("div").classList.remove("translate-x-full"), 10);

  document.getElementById("checkoutSellerLogo").src = product.sellerLogo || "";

  const buyerName = user.username || user.name || "";
  const buyerFields = ['Name', 'Email', 'Phone', 'Address'].map(field => {
    const id = `input${field}`;
    const type = field === 'Email' ? 'email' : field === 'Phone' ? 'tel' : 'text';
    const value = field === 'Name' ? buyerName : user[field.toLowerCase()] || '';
    return `
      <label class="block">
        <span class="text-sm font-medium text-gray-700">${field} <span class="text-red-500">*</span></span>
        <input type="${type}" id="${id}" class="w-full mt-1 border rounded px-3 py-2 text-sm" value="${value}" required />
      </label>
    `;
  }).join("");

  document.getElementById("checkoutBuyerInfo").innerHTML = `
    <p class="text-sm text-gray-700 font-medium mb-2">üõí Quantity: <strong>${qty}</strong></p>
    ${buyerFields}
  `;

  const vBox = document.getElementById("checkoutSelectedVariant");
  const cBox = document.getElementById("checkoutSelectedColor");

  if (selectedVariant) {
    vBox.querySelector("span").textContent = selectedVariant.name;
    vBox.classList.remove("hidden");
  } else {
    vBox.classList.add("hidden");
  }

  if (selectedColor) {
    cBox.querySelector("span").textContent = capitalize(selectedColor.name);
    cBox.classList.remove("hidden");
  } else {
    cBox.classList.add("hidden");
  }

  const dBox = document.getElementById("checkoutDelivery");
  dBox.innerHTML = "";

  const deliveryRegions = product.shopSettings?.deliveryRegions || [];
  const currencySymbol = getCurrencySymbol(product.shopSettings?.storeCurrency || "USD");

  if (!deliveryRegions.length) {
    dBox.innerHTML = `<p class="text-sm text-gray-500 italic">This shop has no delivery regions defined.</p>`;
  } else {
    const grouped = deliveryRegions.reduce((acc, r) => {
      acc[r.country] = acc[r.country] || [];
      acc[r.country].push(r);
      return acc;
    }, {});

    let deliveryHTML = `<label class="block font-semibold text-gray-700 mb-1">üìç Select Delivery Location</label><div class="space-y-2">`;
    for (const [country, regions] of Object.entries(grouped)) {
      deliveryHTML += `<div class="border border-gray-200 rounded p-2"><div class="text-sm font-semibold text-indigo-700 mb-1">${country}</div>`;
      regions.forEach(r => {
        deliveryHTML += `
          <label class="block ml-2">
            <input type="radio" name="deliveryLocation" data-country="${country}" data-state="${r.state}" value="${r.fee}" class="mr-2" onchange="updateCheckoutTotal()" />
            ${r.state} - ${currencySymbol}${parseFloat(r.fee).toFixed(2)}
          </label>
        `;
        r.subcounties?.forEach(s => {
          deliveryHTML += `
            <label class="block ml-6">
              <input type="radio" name="deliveryLocation" data-country="${country}" data-state="${r.state}" data-subcounty="${s.subcounty}" value="${s.fee}" class="mr-2" onchange="updateCheckoutTotal()" />
              ${s.subcounty} - ${currencySymbol}${parseFloat(s.fee).toFixed(2)}
            </label>
          `;
        });
      });
      deliveryHTML += `</div>`;
    }
    deliveryHTML += `</div>`;
    dBox.innerHTML = deliveryHTML;
  }

  // Clear coupon fields
  document.getElementById("checkoutCouponCode").value = "";
  document.getElementById("checkoutCouponMessage").innerHTML = "";
  document.getElementById("couponDiscountRow").classList.add("hidden");

  // Reset price displays with correct symbol
  document.getElementById("checkoutSubtotal").textContent = `${currencySymbol}0.00`;
  document.getElementById("couponDiscount").textContent = `${currencySymbol}0.00`;
  document.getElementById("deliveryFee").textContent = `${currencySymbol}0.00`;
  document.getElementById("totalPrice").textContent = `${currencySymbol}0.00`;

  updateCheckoutTotal();
}

function updateCheckoutTotal() {
  const product = window.currentProduct;
  if (!product) return;
  
  const qty = parseInt(window.currentCartQty || 1);
  const currencySymbol = getCurrencySymbol(product.shopSettings?.storeCurrency || "USD");

  let unitPrice = product.price;
  const selectedVariant = window.selectedVariant;
  const selectedColor = window.selectedColor;

  if (selectedVariant?.price) unitPrice = selectedVariant.price;
  if (selectedColor?.price) unitPrice += selectedColor.price;

  const deliveryInput = document.querySelector('input[name="deliveryLocation"]:checked');
  const deliveryFee = deliveryInput ? parseFloat(deliveryInput.value || "0") : 0;

  let subtotal = unitPrice * qty;
  let discount = 0;
  
  // Apply coupon discount if available
  if (window.appliedCoupon) {
    discount = window.appliedCoupon.discountAmount;
    subtotal = Math.max(0, subtotal - discount); // Don't let subtotal go negative
  }
  
  const total = subtotal + deliveryFee;

  // Update display
  const originalSubtotal = unitPrice * qty;
  document.getElementById("checkoutSubtotal").textContent = `${currencySymbol}${originalSubtotal.toFixed(2)}`;
  document.getElementById("deliveryFee").textContent = `${currencySymbol}${deliveryFee.toFixed(2)}`;
  document.getElementById("totalPrice").textContent = `${currencySymbol}${total.toFixed(2)}`;
  
  // Show/hide coupon discount row
  if (discount > 0) {
    document.getElementById("couponDiscount").textContent = `${currencySymbol}${discount.toFixed(2)}`;
    document.getElementById("couponDiscountRow").classList.remove("hidden");
  } else {
    document.getElementById("couponDiscountRow").classList.add("hidden");
  }
}

function hideCheckoutModal() {
  const modal = document.getElementById("checkoutModal");
  modal.querySelector("div").classList.add("translate-x-full");
  setTimeout(() => modal.classList.add("hidden"), 300);
  
  // Clear applied coupon when closing
  window.appliedCoupon = null;
}

// Coupon functionality for checkout modal
async function applyCheckoutCoupon() {
  const couponCode = document.getElementById("checkoutCouponCode").value.trim().toUpperCase();
  const messageEl = document.getElementById("checkoutCouponMessage");
  
  if (!couponCode) {
    messageEl.innerHTML = '<span class="text-red-500">Please enter a coupon code.</span>';
    return;
  }
  
  try {
    const product = window.currentProduct;
    if (!product) {
      messageEl.innerHTML = '<span class="text-red-500">Product not loaded.</span>';
      return;
    }
    
    // Get current price calculation
    let unitPrice = product.price;
    const selectedVariant = window.selectedVariant;
    const selectedColor = window.selectedColor;
    
    if (selectedVariant?.price) unitPrice = selectedVariant.price;
    if (selectedColor?.price) unitPrice += selectedColor.price;
    
    const qty = parseInt(window.currentCartQty || 1);
    const subtotal = unitPrice * qty;
    
    // Validate coupon with server
    const res = await fetch(`${API}/validate-coupon`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        code: couponCode,
        seller: product.seller,
        orderTotal: subtotal,
        productIds: [product.id]
      })
    });
    
    const result = await res.json();
    const data = result.data || result; // support both {success,data} and direct payload
    
    if (!data.valid) {
      messageEl.innerHTML = `<span class="text-red-500">${data.error || "Invalid coupon code."}</span>`;
      window.appliedCoupon = null;
      updateCheckoutTotal();
      return;
    }
    
    // Apply coupon
    const discountAmount = data.discountAmount;
    
    messageEl.innerHTML = `
      <span class="text-green-600">
        ‚úÖ Coupon applied! You save ${getCurrencySymbol(product.shopSettings?.storeCurrency || "USD")}${discountAmount.toFixed(2)}
      </span>
    `;
    
    // Store coupon data
    window.appliedCoupon = {
      id: data.coupon.id,
      code: data.coupon.code,
      discountAmount: discountAmount
    };
    
    updateCheckoutTotal();
    
  } catch (err) {
    console.error("Coupon error:", err);
    messageEl.innerHTML = '<span class="text-red-500">Error applying coupon. Please try again.</span>';
    window.appliedCoupon = null;
    updateCheckoutTotal();
  }
}

async function placeOrder() {
  const product = window.currentProduct;
  const shopSettings = product.shopSettings || {};
  const paymentMethodConfig = shopSettings.paymentMethod || "delivery"; // "delivery", "online", or "both"
  const gateways = shopSettings.paymentSystems || [];
  const gatewayConfigs = shopSettings.gatewayConfigs || {};
  const storeCurrency = shopSettings.storeCurrency || "USD";
  const currencySymbol = getCurrencySymbol(storeCurrency);

  // üßç Buyer Info
  const name = document.getElementById("inputName")?.value.trim();
  const email = document.getElementById("inputEmail")?.value.trim();
  const phone = document.getElementById("inputPhone")?.value.trim();
  const address = document.getElementById("inputAddress")?.value.trim();
  const notes = document.getElementById("buyerNotes")?.value.trim();
  const delivery = document.querySelector('input[name="deliveryLocation"]:checked');

  if (!name || !email || !phone || !address || !notes) {
    alert("‚ö†Ô∏è Please fill in all required fields.");
    return;
  }
  if (!delivery) {
    alert("Please select a delivery location.");
    return;
  }

  const qty = parseInt(window.currentCartQty || 1);
  if (isNaN(qty) || qty <= 0) {
    alert("Invalid quantity.");
    return;
  }

  const variant = window.selectedVariant || null;
  const color = window.selectedColor || null;
  let unitPrice = product.price;
  if (variant?.price) unitPrice = variant.price;
  if (color?.price) unitPrice += color.price;
  let subtotal = unitPrice * qty;
  const deliveryFee = parseFloat(delivery.value || "0");

  // Apply coupon discount
  let discount = 0;
  if (window.appliedCoupon) {
    discount = window.appliedCoupon.discountAmount;
    subtotal = Math.max(0, subtotal - discount);
  }
  const total = subtotal + deliveryFee;

  const orderData = {
    orderId: "ORD-" + Date.now(),
    productId: product.id,
    productName: product.name,
    productImage: product.image || product.images?.[0] || "",
    quantity: qty,
    buyer: { name, email, phone, address, notes },
    seller: product.seller,
    delivery: {
      country: delivery.dataset.country,
      state: delivery.dataset.state,
      subcounty: delivery.dataset.subcounty || null,
      fee: deliveryFee
    },
    variant,
    color,
    coupon: window.appliedCoupon || null,
    discount: discount,
    subtotal: (unitPrice * qty).toFixed(2),
    total: total.toFixed(2),
    currency: storeCurrency,
    currencySymbol,
    status: "pending",
    createdAt: new Date().toISOString()
  };

  const btn = document.getElementById("placeOrderBtn");
  btn.disabled = true;
  btn.textContent = "Processing...";

  try {
    // Handle payment method selection
    const proceedWithMethod = async (selectedMethod) => {
      orderData.paymentMethod = selectedMethod;

      if (selectedMethod === "delivery") {
        // Show cool preloader for delivery orders
        showOrderPreloader("üöö Placing Order on Delivery", "Your order is being processed for cash on delivery...");
        
        try {
          const res = await fetch(`${API}/place-order`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData)
          });
          
          if (!res.ok) throw new Error("Failed to save order.");
          const result = await res.json();
          
          // Hide preloader
          hideOrderPreloader();
          
          // If a coupon was applied, increment its usage
          if (window.appliedCoupon?.id) {
            try {
              await fetch(`${API}/apply-coupon`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  couponId: window.appliedCoupon.id,
                  discountAmount: window.appliedCoupon.discountAmount || 0
                })
              });
            } catch (e) {
              console.warn("Failed to increment coupon usage (delivery order)", e);
            }
          }

          // Show success modal with order details
          showSuccessModal({
            paymentMethod: 'delivery',
            orderId: result.data?.order?.orderId || 'ORD-' + Date.now(),
            total: total,
            currency: storeCurrency
          });
          
          // Clean up cart
          cart = cart.filter(item => item.id !== product.id);
          saveCart();
          hideCheckoutModal();
        } catch (error) {
          hideOrderPreloader();
          throw error;
        }
      } else if (selectedMethod === "online") {
        if (!gateways.length) {
          alert("‚ùå No online payment gateways configured.");
          return;
        }
        
        // Store minimal data for redirect-based payments (like Stripe)
        localStorage.setItem('lastOrderTotal', total.toString());
        localStorage.setItem('lastOrderCurrency', storeCurrency);
        localStorage.setItem('pendingOrderData', JSON.stringify(orderData));
        
        hideCheckoutModal();
        showOrderPreloader("üí≥ Redirecting to Payment", "Please complete your payment to confirm the order...");
        
        // Show payment gateway after a brief delay
        setTimeout(() => {
          console.log("Gateways being passed to showGatewayPopup:", gateways); // Debug log
          showGatewayPopup(gateways, total, orderData, gatewayConfigs, email, product, storeCurrency);
        }, 1500);
      }
    };

    // Decision logic
    if (paymentMethodConfig === "both") {
      // Show choice modal
      showDeliveryMethodChoice(proceedWithMethod);
    } else {
      // Proceed directly
      await proceedWithMethod(paymentMethodConfig);
    }
  } catch (err) {
    console.error("‚ùå Order error:", err);
    hideOrderPreloader(); // Hide preloader on error
    alert("‚ùå Order failed: " + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "üßæ Confirm Order";
  }
}
function showGatewayPopup(gateways, total, orderData, gatewayConfigs, email, product, storeCurrency) {
  const modal = document.getElementById("gatewayModal");
  const container = document.getElementById("gatewayOptions");

  // Hide the preloader when payment gateway opens
  hideOrderPreloader();
  
  modal.classList.remove("hidden");
  modal.classList.add("flex");
  container.innerHTML = "";
  
  // Update order total display
  const currencySymbol = getCurrencySymbol(storeCurrency);
  document.getElementById("gatewayOrderTotal").textContent = `${currencySymbol}${total.toFixed(2)}`;

  const gatewayLabels = {
    paypal: "PayPal",
    paystack: "Paystack",
    flutterwave: "Flutterwave",
    razorpay: "Razorpay",
    square: "Square",
    iyonicpay: "IyonicPay",
    khalti: "Khalti",
    instamojo: "Instamojo",
    shopright: "ShopRight Pay",
    stripe: "Stripe",
    wise: "Wise Business",
    revolut: "Revolut Business",
    iyzipay: "Iyzipay"
  };

  const icons = {
    paypal: "https://www.paypalobjects.com/webstatic/icon/pp258.png",
    paystack: "https://upload.wikimedia.org/wikipedia/commons/2/20/Paystack_Logo.png",
    flutterwave: "https://checkout.flutterwave.com/assets/images/favicon.png",
    razorpay: "https://razorpay.com/favicon.png",
    square: "https://img.icons8.com/color/48/square.png",
    iyonicpay: "https://i.imgur.com/YAPRefp.png",
    khalti: "https://seeklogo.com/images/K/khalti-logo-962A1A4174-seeklogo.com.png",
    instamojo: "https://assets.instamojo.com/logo/full-logo-dark.png",
    shopright: "https://placehold.co/32x32?text=SR",
    stripe: "https://img.icons8.com/color/48/stripe.png",
    wise: "https://wise.com/favicon.ico",
    revolut: "https://www.revolut.com/favicon.ico",
    iyzipay: "https://www.iyzico.com/favicon.ico"
  };

  gateways.forEach(g => {
    console.log("Processing gateway:", g); // Debug log
    const label = gatewayLabels[g] || capitalize(g);
    container.innerHTML += `
      <button onclick="selectGateway('${g}', ${total}, '${email}')" class="flex items-center gap-3 w-full border p-3 rounded-lg hover:bg-indigo-50 transition-all hover:border-indigo-300">
        <img src="${icons[g] || 'https://placehold.co/32x32'}" class="w-8 h-8 rounded" />
        <span class="text-sm font-medium text-gray-700">${label}</span>
      </button>
    `;
  });

  window.selectGateway = function (gateway, total, email) {
    processPayment(gateway, total, orderData, gatewayConfigs, email, product, storeCurrency);
  };
}

function hideGatewayPopup() {
  const modal = document.getElementById("gatewayModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");

  // Clear dynamic payment containers
  const dynamicContainer = document.getElementById("gatewayPaymentContainer");
  if (dynamicContainer) {
    dynamicContainer.classList.add("hidden");
    dynamicContainer.querySelectorAll("div").forEach(div => div.innerHTML = "");
  }
}

async function processPayment(gateway, total, orderData, configs, email, product, storeCurrency) {
  const productName = product.name;
  const sellerLogo = product.sellerLogo;
  const currencySymbol = getCurrencySymbol(storeCurrency);

  const saveOrderAfterPayment = async (paymentDetails = {}) => {
    // üéØ IMMEDIATELY show preloader after payment completion
    showOrderPreloader("‚úÖ Payment Successful!", "Processing your order and sending confirmation...");
    hideGatewayPopup(); // Hide payment gateway modal
    
    try {
      orderData.paymentDetails = paymentDetails;
      orderData.status = "paid";
      orderData.paymentMethod = "online";
      
      const res = await fetch(`${API}/place-order`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(orderData)
      });

      if (!res.ok) throw new Error("Failed to save order.");
      
      const result = await res.json();
      
      // Hide preloader
      hideOrderPreloader();

      // If a coupon was applied, increment its usage
      if (window.appliedCoupon?.id) {
        try {
          await fetch(`${API}/apply-coupon`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              couponId: window.appliedCoupon.id,
              discountAmount: window.appliedCoupon.discountAmount || 0
            })
          });
        } catch (e) {
          console.warn("Failed to increment coupon usage (online order)", e);
        }
      }
      
      // Show success modal after a brief delay for better UX
      setTimeout(() => {
        showSuccessModal({
          paymentMethod: 'online',
          orderId: result.data?.order?.orderId || 'ORD-' + Date.now(),
          total: total,
          currency: storeCurrency
        });
      }, 500);
      
      // Clean up cart
      cart = cart.filter(item => item.id !== product.id);
      saveCart();
      
    } catch (err) {
      console.error("‚ùå Order saving failed:", err);
      hideOrderPreloader();
      
      // Even if saving fails, payment was successful so show partial success
      setTimeout(() => {
        showSuccessModal({
          paymentMethod: 'online',
          orderId: 'ORD-' + Date.now(),
          total: total,
          currency: storeCurrency
        });
      }, 500);
      
      // Show additional error message
      setTimeout(() => {
        alert("‚ö†Ô∏è Payment processed successfully but there was an issue saving your order details. Please contact support with your payment confirmation.");
      }, 2000);
    }
  };

  if (gateway === "iyonicpay") {
    let url = configs.iyonicpayUrl;
    if (!url) return alert("‚ùå IyonicPay URL is not configured by seller.");
    
    const name = encodeURIComponent(orderData.buyer.name);
    const buyerEmail = encodeURIComponent(email);
    const amount = encodeURIComponent(total.toFixed(2));
    const delimiter = url.includes("?") ? "&" : "?";
    url += `${delimiter}amount=${amount}&name=${name}&email=${buyerEmail}&currency=${storeCurrency}`;
    
    const paymentContainer = document.getElementById("gatewayPaymentContainer");
    paymentContainer.innerHTML = `
      <iframe 
        src="${url}" 
        style="width:100%; height:600px; border:0; border-radius:12px; box-shadow:0 0 10px rgba(0,0,0,0.1);" 
        loading="lazy"
        allow="payment *"
      ></iframe>
      <button onclick="confirmIyonicPayment()" class="mt-4 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
        ‚úÖ I've Completed Payment
      </button>
    `;
    paymentContainer.classList.remove("hidden");
    
    window.confirmIyonicPayment = () => saveOrderAfterPayment({ gateway: "iyonicpay", reference: "IYONIC-" + Date.now() });
  }

  else if (gateway === "paystack") {
    const key = configs.paystackPublicKey;
    if (!window.PaystackPop || !key) return alert("‚ùå Paystack not configured.");
    
    PaystackPop.setup({
      key,
      email,
      amount: total * 100,
      currency: storeCurrency,
      ref: "ORD" + Date.now(),
      callback: (res) => {
        saveOrderAfterPayment({ gateway: "paystack", reference: res.reference });
      },
      onClose: () => {
        alert("‚ùå Payment cancelled.");
      }
    }).openIframe();
  }

  else if (gateway === "shopright") {
    const key = "pk_test_232531a5c927ef2cc67ed1b85af3f26e3b8ed2f2";
    if (!window.PaystackPop) return alert("‚ùå ShopRight payment not configured.");
    
    PaystackPop.setup({
      key,
      email,
      amount: total * 100,
      currency: storeCurrency,
      ref: "SHOPRIGHT-" + Date.now(),
      label: "ShopRight Payment",
      metadata: {
        custom_fields: [
          { display_name: "Buyer Email", variable_name: "buyer_email", value: email },
          { display_name: "Product", variable_name: "product_name", value: productName }
        ]
      },
      callback: (res) => {
        saveOrderAfterPayment({ gateway: "shopright", reference: res.reference });
      },
      onClose: () => {
        alert("‚ùå ShopRight payment was cancelled.");
      }
    }).openIframe();
  }

  else if (gateway === "instamojo") {
    const url = configs.instamojoUrl;
    if (!url) return alert("‚ùå Instamojo URL not configured by seller.");
    
    const name = encodeURIComponent(orderData.buyer.name);
    const amount = encodeURIComponent(total.toFixed(2));
    const emailEncoded = encodeURIComponent(email);
    const paymentUrl = `${url}?name=${name}&email=${emailEncoded}&amount=${amount}&currency=${storeCurrency}`;
    
    window.open(paymentUrl, "_blank");
    
    // Show confirmation button
    const paymentContainer = document.getElementById("gatewayPaymentContainer");
    paymentContainer.innerHTML = `
      <div class="text-center">
        <p class="text-sm text-gray-600 mb-4">Complete your payment in the new window, then click confirm below.</p>
        <button onclick="confirmInstamojoPayment()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
          ‚úÖ I've Completed Payment
        </button>
      </div>
    `;
    paymentContainer.classList.remove("hidden");
    
    window.confirmInstamojoPayment = () => saveOrderAfterPayment({ gateway: "instamojo", reference: "INSTAMOJO-" + Date.now() });
  }

  else if (gateway === "khalti") {
    const key = configs.khaltiPublicKey;
    if (!key) return alert("‚ùå Khalti not configured by seller.");
    
    const config = {
      publicKey: key,
      productIdentity: product.id,
      productName: productName,
      productUrl: window.location.href,
      eventHandler: {
        onSuccess(payload) {
          saveOrderAfterPayment({ gateway: "khalti", token: payload.token });
        },
        onError(error) {
          console.error(error);
          alert("‚ùå Khalti payment failed.");
        },
        onClose() {
          alert("‚ùå Khalti popup closed.");
        }
      }
    };
    
    const launch = () => new KhaltiCheckout(config).show({ amount: total * 100 });
    
    if (!window.KhaltiCheckout) {
      const script = document.createElement("script");
      script.src = "https://khalti.com/static/khalti-checkout.js";
      script.onload = launch;
      document.head.appendChild(script);
    } else {
      launch();
    }
  }

  else if (gateway === "paypal") {
    const clientId = configs.paypalClientId;
    if (!clientId) return alert("‚ùå PayPal client ID missing.");
    
    const paymentContainer = document.getElementById("gatewayPaymentContainer");
    const paypalContainer = document.getElementById("paypal-button-container");
    paymentContainer.classList.remove("hidden");
    paypalContainer.innerHTML = "";
    
    const render = () => {
      paypal.Buttons({
        style: { layout: 'vertical', color: 'blue', shape: 'pill', label: 'paypal' },
        createOrder: (data, actions) => actions.order.create({
          purchase_units: [{
            description: productName,
            amount: {
              value: total.toFixed(2),
              currency_code: storeCurrency
            }
          }]
        }),
        onApprove: (data, actions) => actions.order.capture().then(details => {
          saveOrderAfterPayment({ 
            gateway: "paypal", 
            orderId: data.orderID, 
            payerId: details.payer.payer_id 
          });
        }),
        onCancel: () => {
          alert("‚ùå Payment cancelled.");
        },
        onError: err => {
          console.error(err);
          alert("‚ùå Payment error.");
        }
      }).render("#paypal-button-container");
    };
    
    if (!window.paypal) {
      const script = document.createElement("script");
      script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=${storeCurrency}`;
      script.onload = render;
      document.head.appendChild(script);
    } else {
      render();
    }
  }

  else if (gateway === "flutterwave") {
    const key = configs.flutterwavePublicKey;
    if (!key || !window.FlutterwaveCheckout) return alert("‚ùå Flutterwave not configured.");
    
    FlutterwaveCheckout({
      public_key: key,
      tx_ref: "ORD" + Date.now(),
      amount: total,
      currency: storeCurrency,
      customer: { email },
      callback: (data) => {
        saveOrderAfterPayment({ gateway: "flutterwave", txRef: data.tx_ref });
      },
      onclose: () => {
        alert("‚ùå Payment cancelled.");
      },
      customizations: {
        title: "Payment for " + productName,
        logo: sellerLogo || "https://placehold.co/48x48?text=Logo"
      }
    });
  }

  else if (gateway === "razorpay") {
    const key = configs.razorpayKey;
    if (!key || !window.Razorpay) return alert("‚ùå Razorpay not configured.");
    
    const options = {
      key,
      amount: total * 100,
      currency: storeCurrency,
      name: "Order Payment",
      description: productName,
      handler: (res) => {
        saveOrderAfterPayment({ gateway: "razorpay", paymentId: res.razorpay_payment_id });
      },
      prefill: { email, contact: orderData.buyer.phone }
    };
    
    const rzp = new Razorpay(options);
    rzp.open();
  }

  else if (gateway === "square") {
    const appId = configs.squareAppId;
    const locationId = configs.squareLocationId;
    if (!appId || !locationId) return alert("‚ùå Square not configured properly.");
    
    const formContainer = document.getElementById("gatewayPaymentContainer");
    formContainer.innerHTML = `
      <div id="card-container" class="mb-3 p-4 border rounded"></div>
      <button id="card-button" class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Pay ${currencySymbol}${total.toFixed(2)}</button>
    `;
    formContainer.classList.remove("hidden");
    
    const initSquare = (appId, locationId) => {
      const payments = Square.payments(appId, locationId);
      payments.card().then(card => {
        card.attach("#card-container");
        document.getElementById("card-button").onclick = async () => {
          const result = await card.tokenize();
          if (result.status === "OK") {
            saveOrderAfterPayment({ gateway: "square", token: result.token });
          } else {
            alert("‚ùå Card error: " + (result.errors?.[0]?.message || "Unknown"));
          }
        };
      });
    };
    
    if (!window.Square) {
      const script = document.createElement("script");
      script.src = "https://sandbox.web.squarecdn.com/v1/square.js";
      script.onload = () => initSquare(appId, locationId);
      document.head.appendChild(script);
    } else {
      initSquare(appId, locationId);
    }
  }

  else if (gateway === "stripe") {
    const key = configs.stripePublicKey;
    if (!key) return alert("‚ùå Stripe not configured.");
    
    // Validate Stripe.js is loaded
    if (typeof Stripe === 'undefined') {
      console.error("Stripe.js not loaded");
      return alert("‚ùå Stripe payment system not available. Please try again later.");
    }
    
    const stripe = Stripe(key);
    
    // Normalize currency code for Stripe (must be lowercase)
    const stripeCurrency = storeCurrency.toLowerCase();
    
    // Validate currency is supported by Stripe
    const supportedCurrencies = ['usd', 'eur', 'gbp', 'jpy', 'cad', 'aud', 'nzd', 'chf', 'dkk', 'nok', 'sek', 'zar', 'kes', 'ngn', 'inr'];
    if (!supportedCurrencies.includes(stripeCurrency)) {
      console.warn(`Currency ${storeCurrency} may not be supported by Stripe`);
    }
    
    try {
      // Create a Stripe checkout session using the correct method
      const sessionData = {
        lineItems: [{
          price_data: {
            currency: stripeCurrency,
            product_data: {
              name: productName,
            },
            unit_amount: Math.round(total * 100), // Convert to cents
          },
          quantity: 1,
        }],
        mode: 'payment',
        successUrl: window.location.href + '?payment=success',
        cancelUrl: window.location.href + '?payment=cancelled',
        clientReferenceId: "ORD" + Date.now()
      };
      
      // Use the correct Stripe.js method for client-only integration
      const { error } = await stripe.redirectToCheckout(sessionData);
      
      if (error) {
        console.error("Stripe error:", error);
        alert("‚ùå Payment failed: " + error.message);
      }
    } catch (err) {
      console.error("Stripe error:", err);
      alert("‚ùå Payment failed: " + err.message);
    }
  }
  else if (gateway === "wise") {
    // For Wise Business, we'll redirect to their payment page
    const wiseUrl = configs.wiseUrl;
    if (!wiseUrl) return alert("‚ùå Wise Business URL is not configured by seller.");
    
    const name = encodeURIComponent(orderData.buyer.name);
    const buyerEmail = encodeURIComponent(email);
    const amount = encodeURIComponent(total.toFixed(2));
    const delimiter = wiseUrl.includes("?") ? "&" : "?";
    const url = `${wiseUrl}${delimiter}amount=${amount}&name=${name}&email=${buyerEmail}&currency=${storeCurrency}`;
    
    window.open(url, "_blank");
    alert("Please complete your payment in the new window, then click the button below.");
    
    // Show confirmation button
    const paymentContainer = document.getElementById("gatewayPaymentContainer");
    paymentContainer.innerHTML = `
      <div class="text-center">
        <p class="text-sm text-gray-600 mb-4">Complete your payment in the new window, then click confirm below.</p>
        <button onclick="confirmWisePayment()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
          ‚úÖ I've Completed Payment
        </button>
      </div>
    `;
    paymentContainer.classList.remove("hidden");
    
    window.confirmWisePayment = () => saveOrderAfterPayment({ gateway: "wise", reference: "WISE-" + Date.now() });
  }
  else if (gateway === "revolut") {
    // For Revolut Business, we'll redirect to their payment page
    const revolutUrl = configs.revolutUrl;
    if (!revolutUrl) return alert("‚ùå Revolut Business URL is not configured by seller.");
    
    const name = encodeURIComponent(orderData.buyer.name);
    const buyerEmail = encodeURIComponent(email);
    const amount = encodeURIComponent(total.toFixed(2));
    const delimiter = revolutUrl.includes("?") ? "&" : "?";
    const url = `${revolutUrl}${delimiter}amount=${amount}&name=${name}&email=${buyerEmail}&currency=${storeCurrency}`;
    
    window.open(url, "_blank");
    alert("Please complete your payment in the new window, then click the button below.");
    
    // Show confirmation button
    const paymentContainer = document.getElementById("gatewayPaymentContainer");
    paymentContainer.innerHTML = `
      <div class="text-center">
        <p class="text-sm text-gray-600 mb-4">Complete your payment in the new window, then click confirm below.</p>
        <button onclick="confirmRevolutPayment()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
          ‚úÖ I've Completed Payment
        </button>
      </div>
    `;
    paymentContainer.classList.remove("hidden");
    
    window.confirmRevolutPayment = () => saveOrderAfterPayment({ gateway: "revolut", reference: "REVOLUT-" + Date.now() });
  }
  else if (gateway === "iyzipay") {
    // For Iyzipay, we'll redirect to their payment page
    const iyzipayUrl = configs.iyzipayUrl;
    if (!iyzipayUrl) return alert("‚ùå Iyzipay URL is not configured by seller.");
    
    const name = encodeURIComponent(orderData.buyer.name);
    const buyerEmail = encodeURIComponent(email);
    const amount = encodeURIComponent(total.toFixed(2));
    const delimiter = iyzipayUrl.includes("?") ? "&" : "?";
    const url = `${iyzipayUrl}${delimiter}amount=${amount}&name=${name}&email=${buyerEmail}&currency=${storeCurrency}`;
    
    window.open(url, "_blank");
    alert("Please complete your payment in the new window, then click the button below.");
    
    // Show confirmation button
    const paymentContainer = document.getElementById("gatewayPaymentContainer");
    paymentContainer.innerHTML = `
      <div class="text-center">
        <p class="text-sm text-gray-600 mb-4">Complete your payment in the new window, then click confirm below.</p>
        <button onclick="confirmIyzipayPayment()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
          ‚úÖ I've Completed Payment
        </button>
      </div>
    `;
    paymentContainer.classList.remove("hidden");
    
    window.confirmIyzipayPayment = () => saveOrderAfterPayment({ gateway: "iyzipay", reference: "IYZIPAY-" + Date.now() });
  }
  else {
    alert("‚ùå Gateway not supported: " + gateway);
  }
}

// Coupon functionality for product page
async function applyCoupon() {
  const couponCode = document.getElementById("couponCode").value.trim().toUpperCase();
  const messageEl = document.getElementById("couponMessage");
  
  if (!couponCode) {
    messageEl.innerHTML = '<span class="text-red-500">Please enter a coupon code.</span>';
    return;
  }
  
  try {
    // Get current product for price calculation
    const product = window.currentProduct;
    if (!product) {
      messageEl.innerHTML = '<span class="text-red-500">Product not loaded.</span>';
      return;
    }
    
    // Get selected variant and color prices
    let unitPrice = product.price;
    const selectedVariantInput = document.querySelector('input[name="productVariant"]:checked');
    const selectedColorInput = document.querySelector('input[name="productColor"]:checked');
    
    if (selectedVariantInput) {
      const variant = product.variants[selectedVariantInput.value];
      if (variant?.price) unitPrice = variant.price;
    }
    
    if (selectedColorInput) {
      const color = product.colorVariants[selectedColorInput.value];
      if (color?.price) unitPrice += color.price;
    }
    
    // Default quantity is 1 for product page
    const qty = 1;
    const subtotal = unitPrice * qty;
    
    // Validate coupon with server
    const res = await fetch(`${API}/validate-coupon`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        code: couponCode,
        seller: product.seller,
        orderTotal: subtotal,
        productIds: [product.id]
      })
    });
    
    const result = await res.json();
    const data = result.data || result; // support both {success,data} and direct payload
    
    if (!data.valid) {
      messageEl.innerHTML = `<span class="text-red-500">${data.error || "Invalid coupon code."}</span>`;
      return;
    }
    
    // Apply coupon discount
    const discountAmount = data.discountAmount;
    const finalTotal = Math.max(0, subtotal - discountAmount);
    
    messageEl.innerHTML = `
      <span class="text-green-600">
        ‚úÖ Coupon "${couponCode}" applied! You save ${getCurrencySymbol(product.shopSettings?.storeCurrency || "USD")}${discountAmount.toFixed(2)}
        <br><small>New price: ${getCurrencySymbol(product.shopSettings?.storeCurrency || "USD")}${finalTotal.toFixed(2)}</small>
      </span>
    `;
    
    // Store coupon data for when user proceeds to checkout
    window.appliedCoupon = {
      id: data.coupon.id,
      code: data.coupon.code,
      discountAmount: discountAmount
    };
  } catch (err) {
    console.error("Coupon error:", err);
    messageEl.innerHTML = '<span class="text-red-500">Error applying coupon. Please try again.</span>';
  }
}

function showDeliveryMethodChoice(onSelect) {
  const modal = document.getElementById("deliveryMethodModal");
  modal.classList.remove("hidden");
  modal.classList.add("flex");

  // Clear previous listeners
  document.getElementById("methodDelivery").onclick = () => {
    hideDeliveryMethodModal();
    onSelect("delivery");
  };
  document.getElementById("methodOnline").onclick = () => {
    hideDeliveryMethodModal();
    onSelect("online");
  };
}

function hideDeliveryMethodModal() {
  const modal = document.getElementById("deliveryMethodModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

// Cool Preloader Functions
function showOrderPreloader(title, message) {
  const preloader = document.getElementById("orderPreloader");
  const titleEl = document.getElementById("preloaderTitle");
  const messageEl = document.getElementById("preloaderMessage");
  
  titleEl.textContent = title || "Processing Your Order";
  messageEl.textContent = message || "Please wait while we process your request...";
  
  preloader.classList.remove("hidden");
  preloader.classList.add("flex");
  
  // Disable scrolling
  document.body.style.overflow = "hidden";
}

function hideOrderPreloader() {
  const preloader = document.getElementById("orderPreloader");
  preloader.classList.add("hidden");
  preloader.classList.remove("flex");
  
  // Re-enable scrolling
  document.body.style.overflow = "auto";
}

// Cool Success Modal Functions
function showSuccessModal(orderData) {
  const modal = document.getElementById("successModal");
  const successMessage = document.getElementById("successMessage");
  const orderIdEl = document.getElementById("successOrderId");
  const orderTotalEl = document.getElementById("successOrderTotal");
  const paymentMethodEl = document.getElementById("successPaymentMethod");
  const confettiContainer = document.querySelector(".success-confetti");
  
  // Update order details
  const currency = orderData.currency || "USD";
  const symbol = getCurrencySymbol(currency);
  
  successMessage.textContent = orderData.paymentMethod === "delivery" 
    ? "Your order will be delivered and you'll pay on arrival!" 
    : "Payment successful! Your order has been confirmed!";
    
  orderIdEl.textContent = orderData.orderId || "N/A";
  orderTotalEl.textContent = `${symbol}${(orderData.total || 0).toFixed(2)}`;
  paymentMethodEl.textContent = orderData.paymentMethod === "delivery" 
    ? "üíµ Pay on Delivery" 
    : "üí≥ Paid Online";
  
  // Create confetti animation
  createConfetti(confettiContainer);
  
  // Show modal
  modal.classList.remove("hidden");
  modal.classList.add("flex");
  
  // Auto-hide after 8 seconds
  setTimeout(() => {
    closeSuccessModal();
  }, 8000);
}

function closeSuccessModal() {
  const modal = document.getElementById("successModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
  
  // Re-enable scrolling
  document.body.style.overflow = "auto";
  
  // Clear confetti
  const confettiContainer = document.querySelector(".success-confetti");
  confettiContainer.innerHTML = "";
}

function goToDashboard() {
  const user = JSON.parse(localStorage.getItem("user"));
  if (user && user.email) {
    window.open(`https://api.iyonicorp.com/dashboard.html?email=${encodeURIComponent(user.email)}`, '_blank');
  } else {
    alert("Please log in to access your dashboard.");
  }
  closeSuccessModal();
}

function createConfetti(container) {
  const colors = ['#fbbf24', '#ef4444', '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b'];
  
  for (let i = 0; i < 30; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti-piece';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 3 + 's';
    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
    
    container.appendChild(confetti);
    
    // Remove confetti after animation
    setTimeout(() => {
      if (confetti.parentNode) {
        confetti.parentNode.removeChild(confetti);
      }
    }, 5000);
  }
}

// Check for payment success on page load (for redirect-based payment gateways like Stripe)
window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('payment') === 'success') {
    // Show preloader immediately for redirect-based payments
    showOrderPreloader("‚úÖ Payment Successful!", "Processing your order and sending confirmation...");
    
    // Process the successful payment
    setTimeout(async () => {
      try {
        const pendingOrderData = localStorage.getItem('pendingOrderData');
        if (pendingOrderData) {
          const orderData = JSON.parse(pendingOrderData);
          orderData.paymentMethod = 'online';
          orderData.status = 'paid';
          
          // Save the order to backend
          const res = await fetch(`${API}/place-order`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData)
          });
          
          const result = await res.json();
          
          // Hide preloader
          hideOrderPreloader();
          
          // Show success modal with actual order details
          setTimeout(() => {
            showSuccessModal({
              paymentMethod: 'online',
              orderId: result.data?.order?.orderId || 'ORD-' + Date.now(),
              total: parseFloat(localStorage.getItem('lastOrderTotal') || '0'),
              currency: localStorage.getItem('lastOrderCurrency') || 'USD'
            });
          }, 500);
          
          // Clean up cart  
          let localCart = JSON.parse(localStorage.getItem("cart") || "[]");
          localCart = localCart.filter(item => item.id !== orderData.productId);
          localStorage.setItem("cart", JSON.stringify(localCart));
          // Update global cart variable and re-render
          cart = localCart;
          renderCartDropdown();
          
        } else {
          // Fallback for missing order data - still show success
          hideOrderPreloader();
          setTimeout(() => {
            showSuccessModal({
              paymentMethod: 'online',
              orderId: 'ORD-' + Date.now(),
              total: parseFloat(localStorage.getItem('lastOrderTotal') || '0'),
              currency: localStorage.getItem('lastOrderCurrency') || 'USD'
            });
          }, 500);
        }
        
      } catch (error) {
        hideOrderPreloader();
        console.error('Error processing successful payment:', error);
        // Still show success since payment was successful
        setTimeout(() => {
          showSuccessModal({
            paymentMethod: 'online',
            orderId: 'ORD-' + Date.now(),
            total: parseFloat(localStorage.getItem('lastOrderTotal') || '0'),
            currency: localStorage.getItem('lastOrderCurrency') || 'USD'
          });
        }, 500);
      }
      
      // Clear stored order data
      localStorage.removeItem('lastOrderTotal');
      localStorage.removeItem('lastOrderCurrency');
      localStorage.removeItem('pendingOrderData');
      
      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/[?&]payment=success/, ''));
    }, 800);
  }
});
</script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6JSC6HT7EC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6JSC6HT7EC');
</script>
</body>
</html>