<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seller Products</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tag-btn.active, .main-tag-btn.active, .sub-tag-btn.active {
      background-color: #4f46e5;
      color: white;
      border-color: #4f46e5;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- Header -->
<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <!-- Seller Logo + Name -->
    <div id="sellerInfo" class="flex items-center gap-3">
      <!-- Filled by JS -->
    </div>

    <!-- Home Button -->
    <a id="sellerHomeBtn" href="#" class="text-sm px-4 py-2 rounded bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-500 transition">
      üè† Shop Home
    </a>
  </div>

  <!-- Categories -->
  <div class="bg-white border-t">
    <div class="max-w-7xl mx-auto px-4 py-2 overflow-x-auto scrollbar-hide">
      <nav id="categoryButtons" class="flex gap-2 w-max">
        <!-- Injected by JS -->
      </nav>
    </div>
  </div>

  <!-- Tags -->
  <div class="max-w-7xl mx-auto px-4 py-2 hidden" id="tagControls">
    <div class="mb-2" id="mainTagsContainer">
      <h4 class="text-sm font-medium text-gray-700 mb-1">Main Tags</h4>
      <nav id="mainTags" class="flex flex-wrap gap-2"></nav>
    </div>
    <div id="subTagsContainer">
      <h4 class="text-sm font-medium text-gray-700 mb-1">Other Tags</h4>
      <nav id="subTags" class="flex flex-wrap gap-2"></nav>
    </div>
  </div>
</header>

<!-- Search -->
<section class="max-w-7xl mx-auto px-4 py-6">
  <input
    type="text"
    id="searchInput"
    placeholder="Search for products..."
    class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-300 bg-white"
  />
</section>

<!-- Product Grid -->
<main class="max-w-7xl mx-auto px-4 py-8">
  <h2 id="pageTitle" class="text-2xl font-semibold mb-4">All Products</h2>
  <div id="productGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 min-h-[40vh]">
    <!-- Injected by JS -->
  </div>
</main>

<!-- Footer -->
<footer class="bg-white border-t py-8 mt-10">
  <div class="max-w-7xl mx-auto text-center">
    <p class="text-gray-500 text-sm">¬© 2025 ShopRight Marketplace. All rights reserved.</p>
  </div>
</footer>
<script>
const API = "http://10.2.0.2:3000";
const user = JSON.parse(localStorage.getItem("user") || "{}");
const urlParams = new URLSearchParams(window.location.search);
const seller = urlParams.get("seller");
const initialCategory = (urlParams.get("category") || "all").toLowerCase(); // ‚úÖ NEW

if (!seller) {
  document.getElementById("productGrid").innerHTML = `<p class="text-red-500">‚ùå No seller specified.</p>`;
  throw new Error("Missing seller parameter.");
}

let products = [];
let currentCategory = initialCategory; // ‚úÖ INIT with category param
let currentMainTag = null;
let currentSubTag = null;
let storeCurrency = "USD";

const grid = document.getElementById("productGrid");
const pageTitle = document.getElementById("pageTitle");
const searchInput = document.getElementById("searchInput");
const categoryButtons = document.getElementById("categoryButtons");
const tagControls = document.getElementById("tagControls");
const mainTags = document.getElementById("mainTags");
const subTags = document.getElementById("subTags");
const sellerInfo = document.getElementById("sellerInfo");
const sellerHomeBtn = document.getElementById("sellerHomeBtn");

function capitalize(str) {
  return str ? str.charAt(0).toUpperCase() + str.slice(1) : "";
}

function getCurrencySymbol(code) {
  const map = {
    USD: "$", EUR: "‚Ç¨", GBP: "¬£", NGN: "‚Ç¶", INR: "‚Çπ", KES: "KSh", ZAR: "R"
  };
  return map[code] || code;
}

async function loadSellerDetails() {
  sellerInfo.innerHTML = `<span class="text-gray-400 italic">Loading seller info...</span>`;

  try {
    const res = await fetch(`${API}/find?collection=users`);
    const users = await res.json();

    const sellerData = users.find(user =>
      (user.username || "").toLowerCase() === seller.toLowerCase()
    );

    if (!sellerData || !sellerData.customTheme) {
      sellerInfo.innerHTML = `<span class="text-gray-500">Unknown Seller</span>`;
      return;
    }

    const theme = sellerData.customTheme;
    const shopName = theme.title || seller;
    const rawLogo = theme.logo || "";
    storeCurrency = sellerData?.shopSettings?.storeCurrency || "USD";

    const resolveImage = (img) => {
      if (!img) return "https://placehold.co/40x40?text=üõçÔ∏è";
      if (img.startsWith("http") || img.startsWith("data:")) return img;
      if (img.startsWith("/uploads/")) return `${API}${img}`;
      return `${API}/uploads/${img}`;
    };

    const logoUrl = resolveImage(rawLogo);

    sellerInfo.innerHTML = `
      <a href="shop.html?seller=${encodeURIComponent(seller)}" class="flex items-center gap-2 hover:underline">
        <img src="${logoUrl}" alt="Shop Logo" class="w-10 h-10 object-cover rounded-full border"
             onerror="this.onerror=null;this.src='https://placehold.co/40x40?text=üõçÔ∏è';" />
        <span class="font-bold text-lg text-indigo-700">${shopName}</span>
      </a>
    `;

    sellerHomeBtn.href = `../shop?seller=${encodeURIComponent(seller)}`;
  } catch (err) {
    console.error("‚ùå Failed to load seller info", err);
    sellerInfo.innerHTML = `<span class="text-red-500">Error loading seller info</span>`;
  }
}

setInterval(loadSellerDetails, 5 * 60 * 1000);

async function fetchSellerProducts() {
  try {
    const res = await fetch(`${API}/find?collection=products`);
    const all = await res.json();
    products = all.filter(p => (p.seller || "").toLowerCase() === seller.toLowerCase());

    if (!products.length) {
      grid.innerHTML = `<p class="text-gray-500">No products found for this seller.</p>`;
      return;
    }

    buildCategories();
    activateCategory(currentCategory); // ‚úÖ Use param
    filterAndDisplay();
  } catch (err) {
    console.error("‚ùå Products fetch error:", err);
    grid.innerHTML = `<p class="text-red-500">Failed to load products.</p>`;
  }
}

function buildCategories() {
  const categories = new Set(products.map(p => (p.category || "others").toLowerCase()));
  const list = ["all", ...Array.from(categories)];

  categoryButtons.innerHTML = list.map(cat => `
    <button class="tag-btn whitespace-nowrap px-3 py-1 text-sm rounded-full border border-indigo-500 text-indigo-600 hover:bg-indigo-100 transition font-medium" data-category="${cat}">
      ${capitalize(cat)}
    </button>
  `).join("");

  document.querySelectorAll(".tag-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      currentCategory = btn.dataset.category;
      currentMainTag = null;
      currentSubTag = null;
      activateCategory(currentCategory);
      filterAndDisplay();

      // ‚úÖ Update URL
      const params = new URLSearchParams(window.location.search);
      params.set("category", currentCategory);
      window.history.replaceState({}, "", `${window.location.pathname}?${params.toString()}`);
    });
  });
}

function activateCategory(category) {
  document.querySelectorAll(".tag-btn").forEach(btn =>
    btn.classList.toggle("active", btn.dataset.category === category)
  );

  if (category === "all") {
    tagControls.classList.add("hidden");
  } else {
    tagControls.classList.remove("hidden");
    buildMainTags(category);
  }
}

function buildMainTags(category) {
  const tagSet = new Set();
  products.forEach(p => {
    if ((p.category || "others").toLowerCase() === category && Array.isArray(p.tags)) {
      tagSet.add(p.tags[0]?.toLowerCase());
    }
  });

  const tags = Array.from(tagSet).filter(Boolean);
  mainTags.innerHTML = tags.map(tag => `
    <button class="main-tag-btn px-3 py-1 text-sm rounded-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100 transition" data-main="${tag}">
      ${capitalize(tag)}
    </button>
  `).join("");

  subTags.innerHTML = "";

  document.querySelectorAll(".main-tag-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      currentMainTag = btn.dataset.main;
      currentSubTag = null;
      activateMainTag(currentMainTag);
      buildSubTags(category, currentMainTag);
      filterAndDisplay();
    });
  });
}

function buildSubTags(category, mainTag) {
  const tagSet = new Set();
  products.forEach(p => {
    if ((p.category || "others").toLowerCase() === category &&
        p.tags?.[0]?.toLowerCase() === mainTag) {
      (p.tags.slice(1) || []).forEach(tag => tagSet.add(tag.toLowerCase()));
    }
  });

  const tags = Array.from(tagSet).filter(Boolean);
  subTags.innerHTML = tags.map(tag => `
    <button class="sub-tag-btn px-3 py-1 text-xs rounded-full bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition" data-sub="${tag}">
      ${capitalize(tag)}
    </button>
  `).join("");

  document.querySelectorAll(".sub-tag-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      currentSubTag = btn.dataset.sub;
      activateSubTag(currentSubTag);
      filterAndDisplay();
    });
  });
}

function activateMainTag(tag) {
  document.querySelectorAll(".main-tag-btn").forEach(btn =>
    btn.classList.toggle("active", btn.dataset.main === tag)
  );
}

function activateSubTag(tag) {
  document.querySelectorAll(".sub-tag-btn").forEach(btn =>
    btn.classList.toggle("active", btn.dataset.sub === tag)
  );
}

function filterAndDisplay() {
  let filtered = [...products];

  if (currentCategory !== "all") {
    filtered = filtered.filter(p => (p.category || "others").toLowerCase() === currentCategory);
    pageTitle.textContent = `Category: ${capitalize(currentCategory)}`;
  } else {
    pageTitle.textContent = `All Products`;
  }

  if (currentMainTag) {
    filtered = filtered.filter(p => p.tags?.[0]?.toLowerCase() === currentMainTag);
  }

  if (currentSubTag) {
    filtered = filtered.filter(p =>
      Array.isArray(p.tags) && p.tags.slice(1).map(t => t.toLowerCase()).includes(currentSubTag)
    );
  }

  displayProducts(filtered);
}

function displayProducts(data) {
  grid.innerHTML = "";

  if (data.length === 0) {
    grid.innerHTML = "<p class='text-gray-500 col-span-full'>No matching products found.</p>";
    return;
  }

  data.forEach(p => {
    const imageUrl = p.image?.startsWith("http") ? p.image : `${API}${p.image}`;
    const card = document.createElement("div");
    card.className = "bg-white shadow-md rounded-xl overflow-hidden hover:shadow-lg transition flex flex-col";

    card.innerHTML = `
      ${p.image ? `<img src="${imageUrl}" class="w-full max-h-56 object-cover" alt="${p.name}" />` : ""}
      <div class="p-4 flex-1 flex flex-col gap-2">
        <h3 class="text-md font-semibold text-indigo-700">${p.name}</h3>
        <div class="flex justify-between items-center">
          <span class="text-lg font-bold text-gray-900">${getCurrencySymbol(storeCurrency)}${parseFloat(p.price).toFixed(2)}</span>
          ${p.category ? `<span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded">${capitalize(p.category)}</span>` : ""}
        </div>
      </div>
      <div class="flex gap-2 px-4 pb-4">
        <a href="product-detail.html?id=${p.id}" class="flex-1 bg-gray-100 text-gray-800 text-sm py-2 rounded hover:bg-gray-200 text-center">View</a>
        <button class="wishlist-btn flex-1 bg-pink-100 text-pink-700 text-sm py-2 rounded hover:bg-pink-200" data-id="${p.id}">
          ‚ù§Ô∏è Wishlist
        </button>
      </div>
    `;

    card.querySelector(".wishlist-btn").addEventListener("click", async () => {
      if (!user?.email) return alert("‚ö†Ô∏è Please log in.");
      try {
        const res = await fetch(`${API}/add-wishlist`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ buyer: user.email, productId: p.id })
        });
        const json = await res.json();
        if (res.ok) alert("‚úÖ Added to wishlist!");
        else alert("‚ùå Failed to add: " + (json.error || "Unknown error"));
      } catch (e) {
        console.error(e);
        alert("‚ùå Network error.");
      }
    });

    grid.appendChild(card);
  });
}

searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  const result = products.filter(p =>
    p.name?.toLowerCase().includes(q) ||
    (Array.isArray(p.tags) && p.tags.some(tag => tag.toLowerCase().includes(q)))
  );
  pageTitle.textContent = `Search: "${q}"`;
  displayProducts(result);
});

(async () => {
  await loadSellerDetails();
  await fetchSellerProducts();
})();
</script>

</body>
</html>
