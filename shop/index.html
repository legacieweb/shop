<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ShopRight Seller Storefront</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    @keyframes fadeInUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeInLeft {
      from { transform: translateX(-50px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeInRight {
      from { transform: translateX(50px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes subtleFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
    }
    @keyframes gentlePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    @keyframes morphGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(100, 116, 139, 0.15); }
      50% { box-shadow: 0 0 40px rgba(100, 116, 139, 0.25); }
    }
    @keyframes loaderSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes loaderPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.7; }
    }
    @keyframes dotWave {
      0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .fade-up { animation: fadeInUp 1s ease-out; }
    .fade-left { animation: fadeInLeft 1s ease-out; }
    .fade-right { animation: fadeInRight 1s ease-out; }
    .slide-up { animation: slideUp 0.8s ease-out; }
    .float { animation: subtleFloat 4s ease-in-out infinite; }
    .pulse { animation: gentlePulse 3s ease-in-out infinite; }
    .rotate { animation: rotate 20s linear infinite; }
    .morph-glow { animation: morphGlow 4s ease-in-out infinite; }
    .loader-spin { animation: loaderSpin 1s linear infinite; }
    .loader-pulse { animation: loaderPulse 2s ease-in-out infinite; }
    
    .minimal-gradient {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
    }
    .maintenance-gradient {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #cbd5e1 100%);
    }
    .coming-gradient {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
    }
    
    .glass {
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      background: rgba(248, 250, 252, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    
    .minimal-shadow {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
    }
    
    .hover-lift {
      transition: transform 0.4s ease, box-shadow 0.4s ease;
    }
    .hover-lift:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 35px 70px -15px rgba(0, 0, 0, 0.1);
    }

    .shimmer-effect::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    .text-gradient {
      background: linear-gradient(135deg, #334155 0%, #64748b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Loader Styles */
    .loader-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .loader-container.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loader-content {
      text-align: center;
    }

    .loader-ring {
      width: 80px;
      height: 80px;
      border: 3px solid rgba(148, 163, 184, 0.2);
      border-top: 3px solid #64748b;
      border-radius: 50%;
      margin: 0 auto 30px;
      animation: loaderSpin 1s linear infinite;
    }

    .loader-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 20px 0;
    }

    .loader-dot {
      width: 8px;
      height: 8px;
      background: #64748b;
      border-radius: 50%;
      animation: dotWave 1.4s ease-in-out infinite;
    }

    .loader-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .loader-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    .progress-bar {
      width: 200px;
      height: 2px;
      background: rgba(148, 163, 184, 0.3);
      border-radius: 1px;
      overflow: hidden;
      margin: 20px auto;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #64748b, #94a3b8);
      border-radius: 1px;
      width: 0%;
      animation: progressFill 3s ease-in-out;
    }

    @keyframes progressFill {
      0% { width: 0%; }
      20% { width: 30%; }
      60% { width: 70%; }
      100% { width: 100%; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-all duration-300">

  <!-- Loader -->
  <div id="loader" class="loader-container">
    <div class="loader-content">
      <div class="loader-ring"></div>
      <div class="loader-dots">
        <div class="loader-dot"></div>
        <div class="loader-dot"></div>
        <div class="loader-dot"></div>
      </div>
      <h2 class="text-2xl font-light text-slate-600 mb-2">Loading StoreFront</h2>
      <p class="text-slate-400 text-sm mb-4">Preparing your shopping experience</p>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
      <p class="text-xs text-slate-300 mt-4">Please wait while we set everything up</p>
    </div>
  </div>

  <div id="layoutContainer" class="min-h-screen"></div>

  <script>
    const DEFAULT_API = 'https://shop-stp5.onrender.com';
    const apiParam = new URLSearchParams(location.search).get('api');
    const storedApi = localStorage.getItem('API_BASE');
    const API = (apiParam || storedApi || DEFAULT_API).replace(/\/+$/,'');
    const sellerParam = new URLSearchParams(location.search).get("seller");
    const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
    const isOwner = currentUser?.role && currentUser.role.startsWith("seller") && currentUser.username === sellerParam;

    // Compatibility wrapper: normalize /find responses to arrays for legacy layout scripts
    // Also normalize product image URLs to absolute paths so layouts show images reliably
    (function patchFindResponseShape(){
      const origFetch = window.fetch.bind(window);

      function normalizeUploadUrl(img){
        if (!img || typeof img !== 'string') return '';
        let val = img.trim().replace(/\\\\/g, '/').replace(/\\/g, '/');
        // Absolute URLs or data URIs
        if (/^(https?:)?\/\//i.test(val) || val.startsWith('data:')) return val;
        // MongoDB images endpoint support: "/images/<id>" or bare ObjectId
        if (/^\/?images\//i.test(val) || val.toLowerCase().includes('/images/')) {
          const clean = val.split(/images\//i).pop();
          return `${API}/images/${clean.replace(/^\/+/, '')}`;
        }
        if (/^[a-f0-9]{24}$/i.test(val)) {
          return `${API}/images/${val}`;
        }
        // Legacy uploads
        const uploadsIdx = val.toLowerCase().lastIndexOf('/uploads/');
        const uploadsIdx2 = uploadsIdx === -1 ? val.toLowerCase().lastIndexOf('uploads/') : uploadsIdx;
        if (uploadsIdx2 !== -1) {
          const clean = val.slice(uploadsIdx2 + (val.toLowerCase().startsWith('/uploads/') ? 9 : (val.toLowerCase().indexOf('uploads/') >= 0 ? val.toLowerCase().indexOf('uploads/') + 8 : 0)));
          return `${API}/uploads/${clean.replace(/^\/+/, '')}`;
        }
        if (/^\/?uploads\//i.test(val)) {
          const clean = val.replace(/^\/?uploads\//i, '');
          return `${API}/uploads/${clean}`;
        }
        // Fallback
        return `${API}/uploads/${val.replace(/^\/+/, '')}`;
      }

      window.fetch = async function(...args){
        const resp = await origFetch(...args);
        try {
          const req = args[0];
          const url = typeof req === 'string' ? req : (req && req.url) || '';
          if (url.includes('/find')) {
            const origJson = resp.json.bind(resp);
            resp.json = async () => {
              let data = await origJson();
              // Normalize to array if API returned { data: [...] }
              if (data && typeof data === 'object' && Array.isArray(data.data)) data = data.data;

              // Fix product image URLs if this is a product query
              if (Array.isArray(data) && /collection=products/i.test(url)) {
                data = data.map(p => {
                  try {
                    const fixed = { ...p };
                    fixed.image = normalizeUploadUrl(p.image);
                    if (Array.isArray(p.gallery)) {
                      fixed.gallery = p.gallery.map(g => normalizeUploadUrl(g));
                    }
                    return fixed;
                  } catch { return p; }
                });
              }
              return data;
            };
          }
        } catch (_) {}
        return resp;
      };
    })();

    const ErrorPages = {
      shopNotFound: (sellerName) => `
        <div class="min-h-screen minimal-gradient flex items-center justify-center px-6 py-16">
          <div class="max-w-7xl mx-auto text-center">
            <div class="glass rounded-3xl p-20 minimal-shadow fade-up">
              <div class="w-32 h-32 mx-auto mb-12 bg-slate-100 rounded-full flex items-center justify-center float morph-glow">
                <svg class="w-16 h-16 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
              </div>
              
              <h1 class="text-6xl font-light text-gradient mb-8 fade-left">Shop Doesn't Exist</h1>
              <p class="text-2xl text-slate-600 mb-6 font-light fade-right">The merchant "${sellerName}" hasn't joined our network yet</p>
              <p class="text-lg text-slate-500 mb-20 font-light max-w-2xl mx-auto">Don't worry though - thousands of verified sellers are waiting to serve you with authentic products, fast shipping, and excellent customer service.</p>
              
              <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8 mb-16">
                <div class="glass rounded-xl p-8 hover-lift shimmer-effect relative overflow-hidden" style="animation-delay: 0.1s;">
                  <div class="w-16 h-16 mx-auto mb-6 bg-slate-100 rounded-lg flex items-center justify-center">
                    <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                  </div>
                  <h3 class="text-xl font-semibold text-slate-700 mb-4">Verified Excellence</h3>
                  <p class="text-slate-600 text-sm leading-relaxed mb-4">Every seller undergoes verification including business registration, product authenticity checks, and service standards.</p>
                  <div class="space-y-2 text-xs text-slate-500">
                    <div class="flex items-center space-x-2">
                      <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                      <span>Background verification</span>
                    </div>
                    <div class="flex items-center space-x-2">
                      <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                      <span>Product quality assurance</span>
                    </div>
                  </div>
                </div>
                
                <div class="glass rounded-xl p-8 hover-lift shimmer-effect relative overflow-hidden" style="animation-delay: 0.2s;">
                  <div class="w-16 h-16 mx-auto mb-6 bg-slate-100 rounded-lg flex items-center justify-center">
                    <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                  </div>
                  <h3 class="text-xl font-semibold text-slate-700 mb-4">Fast Delivery</h3>
                  <p class="text-slate-600 text-sm leading-relaxed mb-4">Reliable logistics network ensuring your orders reach you quickly with real-time tracking.</p>
                  <div class="space-y-2 text-xs text-slate-500">
                    <div class="flex items-center space-x-2">
                      <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                      <span>Same-day delivery available</span>
                    </div>
                    <div class="flex items-center space-x-2">
                      <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                      <span>Real-time tracking</span>
                    </div>
                  </div>
                </div>
                
                <div class="glass rounded-xl p-8 hover-lift shimmer-effect relative overflow-hidden" style="animation-delay: 0.3s;">
                  <div class="w-16 h-16 mx-auto mb-6 bg-slate-100 rounded-lg flex items-center justify-center">
                    <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                  </div>
                  <h3 class="text-xl font-semibold text-slate-700 mb-4">Secure Shopping</h3>
                  <p class="text-slate-600 text-sm leading-relaxed mb-4">Your transactions are protected by encryption and comprehensive buyer protection policies.</p>
                  <div class="space-y-2 text-xs text-slate-500">
                    <div class="flex items-center space-x-2">
                      <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                      <span>SSL encryption</span>
                    </div>
                    <div class="flex items-center space-x-2">
                      <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                      <span>Buyer guarantee</span>
                    </div>
                  </div>
                </div>
                
                <div class="glass rounded-xl p-8 hover-lift shimmer-effect relative overflow-hidden" style="animation-delay: 0.4s;">
                  <div class="w-16 h-16 mx-auto mb-6 bg-slate-100 rounded-lg flex items-center justify-center">
                    <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h3 class="text-xl font-semibold text-slate-700 mb-4">Global Marketplace</h3>
                  <p class="text-slate-600 text-sm leading-relaxed mb-4">Connect with sellers worldwide, accessing unique products and exclusive deals.</p>
                  <div class="space-y-2 text-xs text-slate-500">
                    <div class="flex items-center space-x-2">
                      <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                      <span>180+ countries served</span>
                    </div>
                    <div class="flex items-center space-x-2">
                      <div class="w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
                      <span>Multi-currency support</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="grid md:grid-cols-3 gap-8 mb-12">
                <div class="glass rounded-xl p-10 text-left fade-left">
                  <h3 class="text-2xl font-semibold text-slate-700 mb-6">Quality Experience</h3>
                  <p class="text-slate-600 mb-6">Join millions of satisfied customers who've discovered shopping the way it should be - simple, secure, and reliable.</p>
                  <div class="text-3xl font-bold text-slate-700 mb-2">4.9â˜…</div>
                  <div class="text-slate-500 text-sm">Average seller rating</div>
                </div>
                
                <div class="glass rounded-xl p-10 text-left">
                  <h3 class="text-2xl font-semibold text-slate-700 mb-6">Customer Support</h3>
                  <p class="text-slate-600 mb-6">Get help when you need it with our dedicated customer service team available around the clock.</p>
                  <div class="text-3xl font-bold text-slate-700 mb-2">24/7</div>
                  <div class="text-slate-500 text-sm">Customer support</div>
                </div>
                
                <div class="glass rounded-xl p-10 text-left fade-right">
                  <h3 class="text-2xl font-semibold text-slate-700 mb-6">Wide Selection</h3>
                  <p class="text-slate-600 mb-6">Browse millions of products from trusted sellers with competitive pricing and quality guarantees.</p>
                  <div class="text-3xl font-bold text-slate-700 mb-2">50M+</div>
                  <div class="text-slate-500 text-sm">Products available</div>
                </div>
              </div>
              
              <div class="text-slate-500 text-lg">
                Discover what shopping should be - <span class="text-slate-700 font-medium">start exploring</span>
              </div>
            </div>
          </div>
        </div>
      `,

      maintenanceMode: () => `
        <div class="min-h-screen maintenance-gradient flex items-center justify-center px-6 py-16">
          <div class="max-w-6xl mx-auto text-center">
            <div class="fade-up">
              <div class="w-40 h-40 mx-auto mb-16 relative">
                <div class="rotate">
                  <svg viewBox="0 0 100 100" class="w-full h-full text-slate-300">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="2"/>
                    <circle cx="50" cy="50" r="35" fill="none" stroke="currentColor" stroke-width="1"/>
                    <circle cx="50" cy="50" r="25" fill="none" stroke="currentColor" stroke-width="1"/>
                    <circle cx="50" cy="50" r="15" fill="none" stroke="currentColor" stroke-width="1"/>
                  </svg>
                </div>
                <div class="absolute inset-0 flex items-center justify-center">
                  <svg class="w-12 h-12 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </div>
              </div>
              
              <h1 class="text-6xl font-light text-gradient mb-8 fade-left">System Maintenance</h1>
              <p class="text-2xl text-slate-600 mb-6 font-light fade-right">We're improving your shopping experience</p>
              <p class="text-lg text-slate-500 mb-20 font-light max-w-3xl mx-auto">Our team is implementing updates to deliver better performance, enhanced security, and new features.</p>
              
              <div class="glass rounded-2xl p-16 mb-16 minimal-shadow">
                <div class="grid lg:grid-cols-2 gap-16 items-center">
                  <div class="text-left space-y-8">
                    <h2 class="text-3xl font-semibold text-slate-700">Update Progress</h2>
                    <div class="space-y-6">
                      <div class="flex items-center space-x-6">
                        <div class="w-3 h-3 bg-slate-400 rounded-full pulse morph-glow"></div>
                        <div class="flex-1">
                          <div class="text-slate-700 font-medium mb-1">Server Infrastructure</div>
                          <div class="text-slate-500 text-sm">Optimizing cloud architecture for faster response times</div>
                          <div class="w-full bg-slate-200 rounded-full h-2 mt-2">
                            <div class="bg-slate-500 h-2 rounded-full w-4/5"></div>
                          </div>
                        </div>
                      </div>
                      <div class="flex items-center space-x-6">
                        <div class="w-3 h-3 bg-slate-400 rounded-full pulse morph-glow" style="animation-delay: 0.5s;"></div>
                        <div class="flex-1">
                          <div class="text-slate-700 font-medium mb-1">Security Protocols</div>
                          <div class="text-slate-500 text-sm">Implementing enhanced encryption systems</div>
                          <div class="w-full bg-slate-200 rounded-full h-2 mt-2">
                            <div class="bg-slate-500 h-2 rounded-full w-3/4"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="space-y-8">
                    <div class="glass rounded-xl p-8 text-center morph-glow">
                      <div class="w-20 h-20 mx-auto mb-6 bg-slate-100 rounded-full flex items-center justify-center">
                        <svg class="w-10 h-10 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </div>
                      <p class="text-slate-600 mb-4 text-lg">Estimated completion</p>
                      <p class="text-4xl font-light text-slate-700 mb-2">15-30</p>
                      <p class="text-slate-500">minutes remaining</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="text-slate-500 text-lg">
                Thank you for your patience - <span class="text-slate-700 font-medium">we'll be back soon</span>
              </div>
            </div>
          </div>
        </div>
      `,

      noLayout: (sellerName) => `
        <div class="min-h-screen coming-gradient flex items-center justify-center px-6 py-16">
          <div class="max-w-7xl mx-auto text-center">
            <div class="fade-up">
              <div class="w-32 h-32 mx-auto mb-12 bg-slate-100 rounded-full flex items-center justify-center float morph-glow">
                <svg class="w-16 h-16 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a4 4 0 004-4V5z"></path>
                </svg>
              </div>
              
              <h1 class="text-6xl font-light text-gradient mb-8 fade-left">Storefront Coming Soon</h1>
              <p class="text-2xl text-slate-600 mb-6 font-light fade-right">${sellerName} is preparing their digital store</p>
              <p class="text-lg text-slate-500 mb-20 font-light max-w-4xl mx-auto">A dedicated team is crafting a shopping experience that will showcase products beautifully and make purchasing simple and secure.</p>
              
              <div class="glass rounded-2xl p-16 mb-20 minimal-shadow">
                <h2 class="text-3xl font-semibold text-slate-700 mb-16">What's Being Built</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-10">
                  <div class="text-center hover-lift shimmer-effect relative overflow-hidden">
                    <div class="w-20 h-20 mx-auto mb-8 bg-slate-100 rounded-xl flex items-center justify-center morph-glow">
                      <svg class="w-10 h-10 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                      </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Clean Design</h3>
                    <p class="text-slate-600 text-sm mb-4">A beautiful, minimalist interface that puts products first and makes shopping effortless.</p>
                  </div>
                  
                  <div class="text-center hover-lift shimmer-effect relative overflow-hidden">
                    <div class="w-20 h-20 mx-auto mb-8 bg-slate-100 rounded-xl flex items-center justify-center morph-glow">
                      <svg class="w-10 h-10 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                      </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Mobile First</h3>
                    <p class="text-slate-600 text-sm mb-4">Optimized for all devices with smooth performance on phones, tablets, and desktops.</p>
                  </div>
                  
                  <div class="text-center hover-lift shimmer-effect relative overflow-hidden">
                    <div class="w-20 h-20 mx-auto mb-8 bg-slate-100 rounded-xl flex items-center justify-center morph-glow">
                      <svg class="w-10 h-10 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                      </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Secure Shopping</h3>
                    <p class="text-slate-600 text-sm mb-4">Protected checkout with multiple payment options and buyer protection policies.</p>
                  </div>
                </div>
              </div>
              
              <div class="grid md:grid-cols-2 gap-12 mb-20">
                <div class="glass rounded-xl p-12 text-left fade-left">
                  <h3 class="text-2xl font-semibold text-slate-700 mb-8">Development Progress</h3>
                  <div class="space-y-6">
                    <div>
                      <div class="flex items-center justify-between mb-3">
                        <span class="text-slate-700 font-medium">Design System</span>
                        <span class="text-slate-500 text-sm">85%</span>
                      </div>
                      <div class="w-full bg-slate-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-slate-400 to-slate-500 h-3 rounded-full w-[85%]"></div>
                      </div>
                    </div>
                    
                    <div>
                      <div class="flex items-center justify-between mb-3">
                        <span class="text-slate-700 font-medium">Product Catalog</span>
                        <span class="text-slate-500 text-sm">70%</span>
                      </div>
                      <div class="w-full bg-slate-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-slate-400 to-slate-500 h-3 rounded-full w-[70%]"></div>
                      </div>
                    </div>
                    
                    <div>
                      <div class="flex items-center justify-between mb-3">
                        <span class="text-slate-700 font-medium">Checkout System</span>
                        <span class="text-slate-500 text-sm">60%</span>
                      </div>
                      <div class="w-full bg-slate-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-slate-400 to-slate-500 h-3 rounded-full w-[60%]"></div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="glass rounded-xl p-12 fade-right">
                  <h3 class="text-2xl font-semibold text-slate-700 mb-8">Key Features</h3>
                  <div class="space-y-6">
                    <div class="flex items-start space-x-4">
                      <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                        <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4"></path>
                        </svg>
                      </div>
                      <div>
                        <h4 class="text-slate-700 font-semibold mb-1">Fast Search</h4>
                        <p class="text-slate-500 text-sm">Quick product discovery with smart filters and sorting options.</p>
                      </div>
                    </div>
                    
                    <div class="flex items-start space-x-4">
                      <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                        <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4"></path>
                        </svg>
                      </div>
                      <div>
                        <h4 class="text-slate-700 font-semibold mb-1">Easy Checkout</h4>
                        <p class="text-slate-500 text-sm">Streamlined purchase process with guest checkout options.</p>
                      </div>
                    </div>
                    
                    <div class="flex items-start space-x-4">
                      <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                        <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4"></path>
                        </svg>
                      </div>
                      <div>
                        <h4 class="text-slate-700 font-semibold mb-1">Order Tracking</h4>
                        <p class="text-slate-500 text-sm">Real-time updates on your order status and delivery progress.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="text-slate-500 text-lg">
                Something great is coming - <span class="text-slate-700 font-medium">stay tuned</span>
              </div>
            </div>
          </div>
        </div>
      `
    };

    function hideLoader() {
      const loader = document.getElementById("loader");
      if (loader) {
        loader.classList.add("hidden");
        setTimeout(() => {
          loader.remove();
        }, 500);
      }
    }

    async function loadLayoutAndTheme() {
      // Show loader for at least 2 seconds for a good user experience
      const startTime = Date.now();
      const minLoadTime = 2000;

      try {
        const userRes = await fetch(`${API}/find?collection=users&username=${encodeURIComponent(sellerParam)}`);
        const userData = await userRes.json();
        const seller = Array.isArray(userData) ? userData[0] : userData?.data?.[0];

        const container = document.getElementById("layoutContainer");

        // Ensure minimum load time
        const elapsed = Date.now() - startTime;
        const remainingTime = Math.max(0, minLoadTime - elapsed);
        
        await new Promise(resolve => setTimeout(resolve, remainingTime));

        if (!seller) {
          hideLoader();
          setTimeout(() => {
            container.innerHTML = ErrorPages.shopNotFound(sellerParam);
          }, 300);
          return;
        }

        const isSeller = seller.role && (
          seller.role === "seller" || 
          seller.role.startsWith("seller") || 
          seller.role === "seller1" || 
          seller.role === "seller2" || 
          seller.role === "seller3"
        );

        if (!isSeller) {
          hideLoader();
          setTimeout(() => {
            container.innerHTML = ErrorPages.shopNotFound(sellerParam);
          }, 300);
          return;
        }

        let layoutHTML = seller.layoutHTML;
        const theme = seller.customTheme || {};
        // Fallback: if the raw HTML is not stored, but layout name is, fetch it from server
        if (!layoutHTML && seller.layoutTheme) {
          try {
            const layoutRes = await fetch(`${API}/layouts/${seller.layoutTheme}`);
            if (layoutRes.ok) {
              const layoutJson = await layoutRes.json();
              layoutHTML = layoutJson?.data?.html || "";
            }
          } catch (e) {
            console.warn("Failed to fetch layout by name:", e);
          }
        }

        if (!layoutHTML) {
          hideLoader();
          setTimeout(() => {
            container.innerHTML = ErrorPages.noLayout(sellerParam);
          }, 300);
          return;
        }

        window.__SHOP_DATA__ = {
          sellerParam,
          isOwner,
          API,
          theme,
          actualSeller: sellerParam
        };

        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = layoutHTML;

        const scripts = Array.from(tempDiv.querySelectorAll("script"));
        scripts.forEach(s => s.remove());

        hideLoader();
        
        setTimeout(() => {
          container.innerHTML = tempDiv.innerHTML;

          scripts.forEach(script => {
            const newScript = document.createElement("script");
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            for (const attr of script.attributes) {
              newScript.setAttribute(attr.name, attr.value);
            }
            document.body.appendChild(newScript);
          });
        }, 300);

      } catch (err) {
        console.error("Failed to load layout or theme:", err);
        
        // Ensure minimum load time even on error
        const elapsed = Date.now() - startTime;
        const remainingTime = Math.max(0, minLoadTime - elapsed);
        
        await new Promise(resolve => setTimeout(resolve, remainingTime));
        
        hideLoader();
        
        setTimeout(() => {
          const container = document.getElementById("layoutContainer");
          container.innerHTML = ErrorPages.maintenanceMode();
        }, 300);
        
        setTimeout(() => {
          window.location.reload();
        }, 30000);
      }
    }

    window.addEventListener("DOMContentLoaded", loadLayoutAndTheme);
  </script>

  <script>
    // Auto-load deployed chatbot if enabled for this seller
    (async function(){
      try {
        const seller = new URLSearchParams(location.search).get('seller');
        if (!seller) return;
        const r = await fetch(`${API}/chatbots/${encodeURIComponent(seller)}`);
        if (!r.ok) return;
        const j = await r.json();
        const cfg = j && j.data;
        if (!cfg || cfg.enabled !== true) return;

        // Helpers
        const accent = (cfg.widget && cfg.widget.accentColor) || '#4f46e5';
        function normalizeImage(img){
          if (!img || typeof img !== 'string') return '';
          let val = img.trim().replace(/\\\\/g,'/').replace(/\\/g,'/');
          if (/^https?:\/\//i.test(val) || val.startsWith('data:')) return val;
          if (/^\/?images\//i.test(val)) return `${API}${val.startsWith('/')?val:'/'.concat(val)}`;
          if (/^[a-f0-9]{24}$/i.test(val)) return `${API}/images/${val}`;
          if (/^\/?uploads\//i.test(val)) return `${API}/uploads/${val.replace(/^\/?uploads\//i,'')}`;
          if (val.startsWith('/')) return `${API}${val}`;
          return `${API}/uploads/${val}`;
        }
        async function tryFetchJson(url, opts){ try{ const rr = await fetch(url, opts); if (!rr.ok) return null; return await rr.json(); }catch{ return null; } }

        // Currency
        let CURRENCY = '$';
        try {
          const u = await tryFetchJson(`${API}/find?collection=users&username=${encodeURIComponent(seller)}`);
          const doc = Array.isArray(u?.data) ? u.data[0] : Array.isArray(u) ? u[0] : u?.data;
          const ss = doc?.shopSettings || {};
          const code = (ss.storeCurrency || ss.currency || ss.currencyCode || '').toString().toUpperCase();
          const symFromSettings = (ss.currencySymbol || '').toString();
          const SYMBOLS = { USD:'$', NGN:'â‚¦', GHS:'â‚µ', EUR:'â‚¬', GBP:'Â£', INR:'â‚¹', KES:'KSh', ZAR:'R', CAD:'C$', AUD:'A$', JPY:'Â¥' };
          CURRENCY = symFromSettings || SYMBOLS[code] || '$';
        } catch {}

        // Root container
        const root = document.createElement('div');
        root.id = 'shopright-bot-root';
        root.style.position = 'fixed';
        root.style.zIndex = '99999';
        root.style[cfg.widget?.position === 'left' ? 'left' : 'right'] = '16px';
        root.style.bottom = '16px';

        // Bubble (launcher)
        const bubble = document.createElement('button');
        bubble.type = 'button';
        bubble.className = 'widget-bubble';
        const btnCfg = cfg.widget?.button || {};
        const btnSizePx = btnCfg.size==='lg'?72:btnCfg.size==='sm'?48:56;
        bubble.style.width = btnSizePx+'px';
        bubble.style.height = btnSizePx+'px';
        bubble.style.borderRadius = (btnCfg.radius!=null?btnCfg.radius:999)+'px';
        if (btnCfg.shadow!==false) bubble.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';
        if (btnCfg.type==='image' && btnCfg.imageUrl){
          bubble.style.background='transparent';
          const src = /^data:image\//i.test(btnCfg.imageUrl) ? btnCfg.imageUrl : normalizeImage(btnCfg.imageUrl);
          bubble.innerHTML = `<img src="${src}" alt="chat" style="width:100%;height:100%;object-fit:cover;border-radius:${btnCfg.radius||999}px;" />`;
          bubble.title = btnCfg.text || 'Chat with us';
        } else {
          bubble.style.backgroundColor = btnCfg.bgColor || accent;
          bubble.style.color = btnCfg.textColor || '#fff';
          bubble.textContent = (btnCfg.emoji || 'ðŸ’¬');
        }

        // Panel
        const panel = document.createElement('div');
        panel.style.width = '360px';
        panel.style.height = '520px';
        panel.style.border = '1px solid #e5e7eb';
        panel.style.borderRadius = '16px';
        panel.style.overflow = 'hidden';
        panel.style.background = '#fff';
        panel.style.boxShadow = '0 12px 30px rgba(0,0,0,0.2)';
        panel.style.display = (cfg.widget?.initialState==='open') ? 'flex' : 'none';
        panel.style.flexDirection = 'column';
        panel.style.marginBottom = '10px';

        const header = document.createElement('div');
        header.style.display='flex';
        header.style.alignItems='center';
        header.style.justifyContent='space-between';
        header.style.padding='10px 12px';
        const headerStyle = (cfg.widget?.headerStyle||'solid').toLowerCase();
        if (headerStyle==='gradient') header.style.background = `linear-gradient(135deg, ${accent}, #111827)`;
        else if (headerStyle==='glass'){ header.style.background='rgba(255,255,255,0.2)'; header.style.backdropFilter='blur(8px)'; header.style.color='#111827'; }
        else header.style.background = accent;
        if (headerStyle!=='glass') header.style.color='#fff';
        header.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><span>ðŸ¤–</span><span>${cfg.botName||'Assistant'}</span></div>`;
        const closeBtn = document.createElement('button');
        closeBtn.textContent='âœ•';
        closeBtn.style.background='transparent'; closeBtn.style.border='0';
        closeBtn.style.color= headerStyle==='glass' ? '#111827' : '#fff';
        closeBtn.style.cursor='pointer';
        header.appendChild(closeBtn);

        const chatWindow = document.createElement('div');
        chatWindow.style.flex='1';
        chatWindow.style.padding='10px';
        chatWindow.style.overflow='auto';
        chatWindow.style.background='#f8fafc';

        const inputWrap = document.createElement('div');
        inputWrap.style.display='flex'; inputWrap.style.gap='8px';
        inputWrap.style.padding='8px'; inputWrap.style.borderTop='1px solid #e5e7eb';
        const chatInput = document.createElement('input');
        chatInput.placeholder='Type a product name or message...';
        chatInput.style.flex='1'; chatInput.style.border='1px solid #e5e7eb'; chatInput.style.borderRadius='10px'; chatInput.style.padding='10px';
        const sendBtn = document.createElement('button');
        sendBtn.type='button'; sendBtn.textContent='Send';
        // Theme-aware send button styling
        const btnRadiusStyle = (cfg.widget?.bubbleStyle==='pill')? '999px' : (cfg.widget?.bubbleStyle==='square' ? '8px' : '12px');
        sendBtn.style.border='0'; sendBtn.style.borderRadius=btnRadiusStyle; sendBtn.style.fontWeight='700'; sendBtn.style.cursor='pointer'; sendBtn.style.padding='10px 12px';
        if (headerStyle==='glass'){ sendBtn.style.background='rgba(255,255,255,0.85)'; sendBtn.style.color='#111827'; sendBtn.style.border='1px solid rgba(17,24,39,0.1)'; }
        else if (headerStyle==='gradient'){ sendBtn.style.background=`linear-gradient(135deg, ${accent}, #111827)`; sendBtn.style.color='#fff'; }
        else { sendBtn.style.background=accent; sendBtn.style.color='#fff'; }
        sendBtn.addEventListener('mouseenter', ()=>{ sendBtn.style.transform='translateY(-1px)'; sendBtn.style.boxShadow='0 10px 16px rgba(0,0,0,0.2)'; });
        sendBtn.addEventListener('mouseleave', ()=>{ sendBtn.style.transform='translateY(0)'; sendBtn.style.boxShadow=''; });
        inputWrap.appendChild(chatInput); inputWrap.appendChild(sendBtn);

        panel.appendChild(header); panel.appendChild(chatWindow); panel.appendChild(inputWrap);

        // Toggle
        bubble.addEventListener('click', ()=> panel.style.display='flex');
        closeBtn.addEventListener('click', ()=> panel.style.display='none');

        // Message helpers
        function addMsg(author, text){
          const wrap = document.createElement('div');
          wrap.style.display='flex'; wrap.style.gap='8px';
          if (author!=='bot') wrap.style.justifyContent='flex-end';
          const b = document.createElement('div');
          const userCfg = cfg.widget?.userBubble || {}; const botCfg = cfg.widget?.botBubble || {};
          const isBot = (author==='bot');
          const bg = isBot ? (botCfg.bg||'#ffffff') : (userCfg.bg||accent);
          const fg = isBot ? (botCfg.fg||'#111827') : (userCfg.fg||'#ffffff');
          const shape = cfg.widget?.bubbleStyle==='pill' ? '999px' : (cfg.widget?.bubbleStyle==='square' ? '8px' : '12px');
          b.style.maxWidth='80%'; b.style.padding='8px 10px'; b.style.borderRadius=shape; b.style.fontSize='14px'; b.style.background=bg; b.style.color=fg;
          if (isBot && botCfg.border) b.style.border='1px solid #e5e7eb';
          b.textContent = text;
          wrap.appendChild(b); chatWindow.appendChild(wrap); chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        function addRichBot(html){
          const wrap = document.createElement('div');
          wrap.style.display='flex'; wrap.style.gap='8px';
          const b = document.createElement('div');
          const botCfg = cfg.widget?.botBubble || {};
          const shape = cfg.widget?.bubbleStyle==='pill' ? '999px' : (cfg.widget?.bubbleStyle==='square' ? '8px' : '12px');
          b.style.maxWidth='80%'; b.style.padding='8px 10px'; b.style.borderRadius=shape; b.style.fontSize='14px';
          b.style.background = botCfg.bg || '#ffffff'; b.style.color = botCfg.fg || '#111827';
          if (botCfg.border) b.style.border='1px solid #e5e7eb';
          b.innerHTML = html; wrap.appendChild(b); chatWindow.appendChild(wrap); chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Product helpers
        function getPrice(p){ const v = (p && (p.price!=null ? p.price : (p.pricing?.price))); const n = typeof v === 'string' ? parseFloat(v) : v; return Number.isFinite(n) ? n : null; }
        function productIdOf(p){
          if (!p) return '';
          const direct = (p.id!=null) ? String(p.id) : (typeof p._id === 'string' ? p._id : null);
          if (direct) return direct;
          if (p._id && typeof p._id === 'object'){
            if (typeof p._id.$oid === 'string') return p._id.$oid;
            // Some drivers embed under _id._id
            if (typeof p._id._id === 'string') return p._id._id;
            const s = String(p._id);
            if (/^[a-f0-9]{24}$/i.test(s)) return s;
          }
          return '';
        }
        function productCard(p){
          const title = p.title || p.name || 'Product';
          const id = productIdOf(p);
          const href = id ? `/detail/index.html?id=${encodeURIComponent(id)}` : 'javascript:void(0)';
          const img = normalizeImage(p.image || (Array.isArray(p.gallery) ? p.gallery[0] : ''));
          return `<a href="${href}" style="display:block;border:1px solid #e5e7eb;border-radius:12px;padding:8px;background:#fff;text-decoration:none">
            ${img?`<img src="${img}" alt="${title}" style="width:100%;height:112px;object-fit:cover;border-radius:10px;margin-bottom:6px;background:#f1f5f9"/>`:''}
            <div style="font-weight:600;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${title}</div>
          </a>`;
        }

        // Cache seller products
        let _sellerProducts = null;
        async function fetchSellerProducts(force=false){
          if (!force && Array.isArray(_sellerProducts)) return _sellerProducts;
          const j = await tryFetchJson(`${API}/find?collection=products&seller=${encodeURIComponent(seller)}`);
          _sellerProducts = (Array.isArray(j) ? j : (Array.isArray(j?.data) ? j.data : [])) || [];
          return _sellerProducts;
        }

        // Live search helpers (mirror dashboard)
        function tokensOf(s){ return (s||'').toLowerCase().replace(/[^a-z0-9\s\.\-']/g,' ').replace(/\s+/g,' ').trim().split(' ').filter(Boolean); }
        function tagsFromProduct(p){
          const arr = [];
          if (Array.isArray(p?.tags)) arr.push(...p.tags.map(t=>String(t).toLowerCase()));
          if (p?.category) arr.push(String(p.category).toLowerCase());
          const name = (p?.title || p?.name || '').toString().toLowerCase();
          name.split(/[^a-z0-9]+/i).forEach(w=>{ if (w && w.length>2) arr.push(w); });
          const desc = (p?.description || p?.details || p?.summary || '').toString().toLowerCase();
          desc.split(/[^a-z0-9]+/i).forEach(w=>{ if (w && w.length>2) arr.push(w); });
          ['cheapest','premium','luxury','budget','new','latest','popular','trending','discount','sale'].forEach(t=>arr.push(t));
          return Array.from(new Set(arr.filter(Boolean)));
        }
        function applyTagPrefs(products){
          const allow = Array.isArray(cfg?.training?.allowedTags) ? cfg.training.allowedTags.map(t=>t.toLowerCase()) : [];
          const block = Array.isArray(cfg?.training?.blockedTags) ? cfg.training.blockedTags.map(t=>t.toLowerCase()) : [];
          let out = Array.isArray(products) ? [...products] : [];
          if (block.length){ out = out.filter(p=>{ const toks = tagsFromProduct(p); return !block.some(b=> toks.includes(b)); }); }
          if (allow.length){ out = out.filter(p=>{ const toks = tagsFromProduct(p); return allow.some(a=> toks.includes(a)); }); }
          return out;
        }

        // Basic intent/rules
        function firstMatching(pattern, match, input){
          const text = (input||'').trim();
          const tokens = (pattern||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean);
          try {
            if (match === 'contains') return tokens.some(t => text.toLowerCase().includes(t));
            if (match === 'exact') return tokens.some(t => text.toLowerCase() === t);
            if (match === 'regex') return tokens.some(t => new RegExp(t, 'i').test(text));
          } catch{}
          return false;
        }

        async function botReply(userText){
          const text = (userText||'').trim();
          const caps = cfg.training?.capabilities || {};

          // 1) Keyword rules
          for (const r of (cfg.training?.rules||[])){
            if (firstMatching(r.pattern, r.match, text)) return r.response || 'Okay.';
          }

          // 2) Shop Q&A
          if (caps.shipping || caps.delivery || caps.payments){
            const low = text.toLowerCase();
            const u = await tryFetchJson(`${API}/find?collection=users&username=${encodeURIComponent(seller)}`);
            const sellerDoc = Array.isArray(u?.data) ? u.data[0] : Array.isArray(u) ? u[0] : u?.data;
            const shop = sellerDoc || {}; const ss = shop.shopSettings || {};
            if (caps.shipping && /(shipping|delivery fee|ship(ping)? cost|how much.*ship)/i.test(low)){
              const fees = (ss.deliveryRegions||[]).map(r=> `${r.country}${r.state?`, ${r.state}`:''}: ${CURRENCY}${r.fee||0}`);
              if (fees.length) return `Shipping fees: ${fees.join(' | ')}`;
            }
            if (caps.delivery && /(deliver(y)?|ship) to|available in|locations?|service areas|coverage/i.test(low)){
              const locs = (ss.deliveryRegions||[]).map(r=> `${r.country}${r.state?` (${r.state})`:''}`);
              if (locs.length) return `We deliver to: ${locs.join(', ')}`;
            }
            if (caps.payments && /(payment|pay|checkout|gateway|methods|cards?|mobile money|bank transfer|cash on delivery|cod)/i.test(low)){
              const list = (ss.paymentSystems||[]).map(x=> String(x)).join(', ');
              if (list) return `Accepted payment methods: ${list}`;
            }
          }

          // 3) Product queries
          if (caps.products){
            const low = text.toLowerCase();
            const products = await fetchSellerProducts();
            const wantCheapest = /(cheapest|lowest price|min(imum)? price|budget)/i.test(low);
            const wantPremium = /(expensive|premium|luxury|costliest|most expensive)/i.test(low);
            const wantTrending = /(popular|trending|best\s*sellers?|bestselling|top\s*sellers?)/i.test(low);
            const wantNew = /(latest|new( products?)?|new arrivals?)/i.test(low);
            let matches = products;
            if (!wantCheapest && !wantPremium && !wantTrending && !wantNew){
              const toks = tokensOf(text); matches = products.filter(p=>{
                const hay = [ (p.title||p.name||'').toString().toLowerCase(), (p.description||p.details||p.summary||'').toString().toLowerCase(), ...(Array.isArray(p.tags)? p.tags.map(t=>String(t).toLowerCase()):[]) ].join(' ');
                return toks.every(t=> hay.includes(t));
              });
            }
            if (wantCheapest){
              const cheap = [...products].filter(p=> (p?.price!=null || p?.pricing?.price!=null)).sort((a,b)=> (getPrice(a)??1e9) - (getPrice(b)??1e9))[0];
              if (cheap){ addMsg('bot', `Cheapest option: ${cheap.title||cheap.name}`); addRichBot(productCard(cheap)); return ''; }
            }
            if (wantPremium){
              const prem = [...products].filter(p=> (p?.price!=null || p?.pricing?.price!=null)).sort((a,b)=> (getPrice(b)??0) - (getPrice(a)??0)).slice(0,3);
              if (prem.length){ addMsg('bot','Premium picks:'); addRichBot(`<div>${prem.map(productCard).join('')}</div>`); return ''; }
            }
            if (wantTrending){
              const tr = [...products].sort((a,b)=> (b.sales||b.orderCount||b.views||0)-(a.sales||a.orderCount||a.views||0)).slice(0,3);
              if (tr.length){ addMsg('bot','Trending now:'); addRichBot(`<div>${tr.map(productCard).join('')}</div>`); return ''; }
            }
            if (wantNew){
              const nw = [...products].sort((a,b)=> new Date(b.createdAt||0) - new Date(a.createdAt||0)).slice(0,3);
              if (nw.length){ addMsg('bot','Latest arrivals:'); addRichBot(`<div>${nw.map(productCard).join('')}</div>`); return ''; }
            }
            if (matches.length){ addMsg('bot', `Here are some options:`); addRichBot(`<div>${matches.slice(0,3).map(productCard).join('')}</div>`); return ''; }
          }
          return "I'm here to help with products, shipping, delivery, and payments. Try asking for cheapest phones under a price, popular items, or delivery regions.";
        }

        // Welcome + interactions
        chatWindow.innerHTML='';
        addMsg('bot', cfg.welcomeMessage || 'Hi!');
        // Live suggestions (like dashboard)
        const liveWrap = document.createElement('div');
        liveWrap.style.position='absolute'; liveWrap.style.left='8px'; liveWrap.style.right='8px'; liveWrap.style.bottom='60px'; liveWrap.style.zIndex='10';
        liveWrap.innerHTML = `<div id="liveLoader" style="display:none;font-size:12px;color:#6b7280">Searching...</div><div id="liveResults" style="margin-top:6px;display:grid;grid-template-columns:1fr;gap:8px"></div>`;
        const liveLoader = liveWrap.querySelector('#liveLoader');
        const liveResults = liveWrap.querySelector('#liveResults');
        panel.appendChild(liveWrap);
        let liveT;
        async function renderLive(q){
          const v = (q||'').trim(); if (!v || v.length<2){ liveResults.innerHTML=''; liveLoader.style.display='none'; return; }
          liveLoader.style.display='block';
          const items = await fetchSellerProducts();
          const ql = v.toLowerCase();
          const hayMatch = (p)=>{
            const hay = [ (p.title||p.name||'').toString().toLowerCase(), (p.description||p.details||p.summary||'').toString().toLowerCase(), ...(Array.isArray(p.tags)? p.tags.map(t=>String(t).toLowerCase()):[]) ].join(' ');
            return hay.includes(ql);
          };
          const matches = applyTagPrefs(items.filter(hayMatch)).slice(0,5);
          liveResults.innerHTML = matches.length ? matches.map(productCard).join('') : '';
          liveLoader.style.display='none';
        }
        chatInput.addEventListener('input', ()=>{ clearTimeout(liveT); liveT = setTimeout(()=>renderLive(chatInput.value), 250); });
        sendBtn.onclick = async ()=>{
          const v = (chatInput.value||'').trim(); if (!v) return;
          addMsg('user', v); chatInput.value='';
          const rText = await botReply(v); if (rText) addMsg('bot', rText);
        };
        chatInput.onkeydown = (e)=>{ if (e.key==='Enter') sendBtn.click(); };

        // Attach
        root.appendChild(panel); root.appendChild(bubble); document.body.appendChild(root);
      } catch (_) {}
    })();
  </script>

</body>
</html>