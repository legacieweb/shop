<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ShopRight Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .tag-button.active {
      background-color: #4f46e5;
      color: white;
      border-color: #4f46e5;
    }
    .category-button.active {
      background-color: #4f46e5;
      color: white;
      border-color: #4f46e5;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

<!-- üîù Header -->
<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <a href="index.html" class="text-xl font-bold text-indigo-600 flex items-center gap-2">
      <span class="text-2xl">üõí</span> ShopRight Marketplace
    </a>
    <a href="login.html" class="text-sm text-indigo-600 hover:underline">Login</a>
  </div>
</header>

<!-- üîç Search Bar -->
<section class="max-w-7xl mx-auto px-4 py-4">
  <input
    type="text"
    id="searchInput"
    placeholder="Search products..."
    class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-300 bg-white"
  />
</section>

<!-- üß≠ Horizontal Category Nav -->
<nav id="categoryNav" class="max-w-7xl mx-auto px-4 py-2 overflow-x-auto scrollbar-hide">
  <div class="flex gap-2 w-max">
    <button class="category-button active px-4 py-2 border rounded-full text-sm font-medium text-indigo-700 hover:bg-indigo-100 transition" data-cat="">All</button>
    <!-- JS injects more here -->
  </div>
</nav>

<!-- üîñ Tag Filters -->
<section id="tagButtons" class="max-w-7xl mx-auto px-4 pt-2 pb-4 overflow-x-auto scrollbar-hide">
  <div class="flex gap-2 w-max">
    <!-- JS injects tags -->
  </div>
</section>

<!-- üõçÔ∏è Product Grid -->
<main class="max-w-7xl mx-auto px-4 pb-12">
  <h2 id="resultTitle" class="text-xl font-semibold mb-4">All Products</h2>
  <div id="marketGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 min-h-[50vh]">
    <!-- JS injects product cards -->
  </div>
</main>

<!-- üë£ Footer -->
<footer class="bg-white border-t py-6 text-center text-sm text-gray-500">
  ¬© 2025 ShopRight ‚Äî All Sellers. All Rights Reserved.
</footer>

<script>
const API = "http://192.168.0.103:3000";
const grid = document.getElementById("marketGrid");
const searchInput = document.getElementById("searchInput");
const resultTitle = document.getElementById("resultTitle");
const tagButtons = document.getElementById("tagButtons").querySelector("div");
const categoryNav = document.getElementById("categoryNav").querySelector("div");

let allProducts = [];
let activeCategory = "";
let activeMainTag = "";
let activeSubTag = "";
let categoryTagMap = {};

function capitalize(str) {
  return str ? str.charAt(0).toUpperCase() + str.slice(1) : "";
}

async function fetchMarketplace() {
  try {
    const res = await fetch(`${API}/find?collection=products`);
    allProducts = await res.json();

    const categories = new Set();

    categoryTagMap = {};
    allProducts.forEach(p => {
      const cat = p.category || "Uncategorized";
      categories.add(cat);

      if (!Array.isArray(p.tags) || p.tags.length < 1) return;
      const main = p.tags[0]?.toLowerCase();
      const subs = p.tags.slice(1).map(t => t.toLowerCase());

      if (!categoryTagMap[cat]) categoryTagMap[cat] = {};
      if (!categoryTagMap[cat][main]) categoryTagMap[cat][main] = new Set();
      subs.forEach(tag => categoryTagMap[cat][main].add(tag));
    });

    categories.forEach(cat => {
      const btn = document.createElement("button");
      btn.className = "category-button px-4 py-2 border rounded-full text-sm font-medium text-indigo-700 hover:bg-indigo-100 transition";
      btn.textContent = capitalize(cat);
      btn.dataset.cat = cat;
      btn.addEventListener("click", () => {
        document.querySelectorAll(".category-button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        activeCategory = cat;
        activeMainTag = "";
        activeSubTag = "";
        resultTitle.textContent = `Category: ${capitalize(cat)}`;
        renderMainTags(cat);
        applyFilters();
      });
      categoryNav.appendChild(btn);
    });

    document.querySelector(".category-button[data-cat='']").addEventListener("click", () => {
      document.querySelectorAll(".category-button").forEach(b => b.classList.remove("active"));
      event.target.classList.add("active");

      activeCategory = "";
      activeMainTag = "";
      activeSubTag = "";
      tagButtons.innerHTML = "";
      resultTitle.textContent = "All Products";
      applyFilters();
    });

    displayProducts(allProducts);
  } catch (err) {
    console.error("‚ùå Fetch error:", err);
    grid.innerHTML = `<p class="text-red-500 col-span-full text-center">Failed to load products.</p>`;
  }
}

function renderMainTags(category) {
  tagButtons.innerHTML = "";

  const mainTagMap = categoryTagMap[category] || {};
  const mainTags = Object.keys(mainTagMap);

  mainTags.forEach(main => {
    const wrapper = document.createElement("div");
    wrapper.className = "flex flex-col gap-1";

    const btn = document.createElement("button");
    btn.className = "tag-button px-3 py-1 border border-indigo-500 text-indigo-700 text-sm rounded-full hover:bg-indigo-100 transition";
    btn.textContent = `#${capitalize(main)}`;
    btn.dataset.tag = main;

    btn.addEventListener("click", () => {
      const isActive = btn.classList.contains("active");
      document.querySelectorAll(".tag-button").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".subtag-container").forEach(el => el.remove());

      if (isActive) {
        activeMainTag = "";
        activeSubTag = "";
        applyFilters();
        return;
      }

      btn.classList.add("active");
      activeMainTag = main;
      activeSubTag = "";
      renderSubTags(wrapper, category, main);
      applyFilters();
    });

    wrapper.appendChild(btn);
    tagButtons.appendChild(wrapper);
  });
}

function renderSubTags(parentWrapper, category, mainTag) {
  const subTagSet = categoryTagMap[category]?.[mainTag] || new Set();
  if (!subTagSet.size) return;

  const subWrapper = document.createElement("div");
  subWrapper.className = "subtag-container flex gap-2 pl-4 mt-1 flex-wrap";

  [...subTagSet].forEach(sub => {
    const btn = document.createElement("button");
    btn.className = "tag-button px-3 py-1 border border-indigo-300 text-indigo-600 text-xs rounded-full hover:bg-indigo-100 transition";
    btn.textContent = `#${capitalize(sub)}`;
    btn.dataset.sub = sub;

    btn.addEventListener("click", () => {
      const isActive = btn.classList.contains("active");
      document.querySelectorAll(".tag-button[data-sub]").forEach(b => b.classList.remove("active"));
      activeSubTag = isActive ? "" : sub;
      if (!isActive) btn.classList.add("active");
      applyFilters();
    });

    subWrapper.appendChild(btn);
  });

  parentWrapper.appendChild(subWrapper);
}

function applyFilters() {
  const q = searchInput.value.toLowerCase();

  const filtered = allProducts.filter(p => {
    const matchesName = p.name?.toLowerCase().includes(q);
    const matchesCat = !activeCategory || (p.category?.toLowerCase() === activeCategory.toLowerCase());
    let matchesMain = true, matchesSub = true;

    if (activeMainTag) {
      matchesMain = p.tags?.[0]?.toLowerCase() === activeMainTag;
    }

    if (activeSubTag) {
      matchesSub = Array.isArray(p.tags) && p.tags.slice(1).map(t => t.toLowerCase()).includes(activeSubTag);
    }

    return matchesName && matchesCat && matchesMain && matchesSub;
  });

  resultTitle.textContent = `Results (${filtered.length})`;
  displayProducts(filtered);
}

function displayProducts(products) {
  grid.innerHTML = "";

  if (!products.length) {
    grid.innerHTML = `<p class="text-gray-500 col-span-full text-center">No products found.</p>`;
    return;
  }

  products.forEach(p => {
    const imageUrl = p.image?.startsWith("http") ? p.image : `${API}${p.image}`;
    const card = document.createElement("div");
    card.className = "flex flex-col items-center";

    card.innerHTML = `
      <img src="${imageUrl}" alt="${p.name}" class="w-full max-h-52 object-contain bg-white mb-2" />

      <div class="bg-white w-full rounded-xl shadow-md px-4 py-3 flex flex-col gap-2">
        <h3 class="text-md font-semibold text-indigo-700 truncate">${p.name}</h3>
        <p class="text-sm text-gray-600">$${p.price}</p>
        <div class="text-xs text-gray-500">Seller: ${capitalize(p.seller)}</div>
        <div class="flex flex-wrap gap-1 mt-1">
          ${(p.tags || []).map(t =>
            `<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full text-xs">#${capitalize(t)}</span>`
          ).join("")}
        </div>
        <a href="product-detail.html?id=${p.id}"
           class="mt-2 bg-indigo-100 text-center text-indigo-700 text-sm py-2 rounded hover:bg-indigo-200 transition">
          View Product
        </a>
      </div>
    `;

    grid.appendChild(card);
  });
}

searchInput.addEventListener("input", applyFilters);
fetchMarketplace();
</script>
</body>
</html>
