<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promotion Center ‚Äì Iyonicorp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const DEFAULT_API = 'https://shop-stp5.onrender.com';
    const apiParam = new URLSearchParams(location.search).get('api');
    const storedApi = localStorage.getItem('API_BASE');
    const API = (apiParam || storedApi || DEFAULT_API).replace(/\/+$/,'');
  </script>
  <style>
    .glass { backdrop-filter: blur(10px); background: linear-gradient(135deg, rgba(99,102,241,0.06), rgba(255,255,255,0.75)); }
  </style>
</head>
<body class="bg-gradient-to-b from-indigo-50 via-white to-white text-gray-800 min-h-screen">
  <!-- Mobile Navbar -->
  <div class="md:hidden flex justify-between items-center px-4 py-3 bg-white/80 glass border-b sticky top-0 z-50 h-[64px]">
    <h1 class="text-lg font-bold text-indigo-700">Promotion Center</h1>
    <button id="hamburgerBtn" class="text-indigo-600 text-2xl font-bold">&#9776;</button>
  </div>

  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white/80 glass shadow-md fixed top-[64px] left-0 h-[calc(100%-64px)] z-40 transform -translate-x-full transition-transform duration-300 md:relative md:top-0 md:h-auto md:translate-x-0 md:block hidden">
      <div class="p-6 border-b hidden md:block">
        <h1 class="text-xl font-bold text-indigo-700">Promotion Center</h1>
        <p class="text-sm text-gray-500 mt-1">Grow your store</p>
      </div>
      <nav class="mt-6 space-y-1">
        <a href="#" data-section="campaigns" class="sidebar-link block px-6 py-3 text-gray-700 hover:bg-indigo-50">üì¢ Campaigns</a>
        <a href="#" data-section="promotions" class="sidebar-link block px-6 py-3 text-gray-700 hover:bg-indigo-50">üéØ Promotions</a>
        <a href="#" data-section="performance" class="sidebar-link block px-6 py-3 text-gray-700 hover:bg-indigo-50">üìà Performance</a>
        <a href="#" data-section="billing" class="sidebar-link block px-6 py-3 text-gray-700 hover:bg-indigo-50">üí≥ Billing</a>
    <a id="backDashboard" href="../dashboard" class="block px-6 py-3 text-indigo-600 hover:bg-indigo-50 font-semibold">‚Üê Back to Dashboard</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-x-hidden px-4 sm:px-6 lg:px-8 pt-6">
      <div class="mb-6">
        <h2 class="text-2xl sm:text-3xl font-extrabold text-indigo-700">Promotion Center</h2>
        <p id="sellerBadge" class="text-sm text-gray-600 mt-1">‚Äî</p>
      </div>

      <!-- Campaigns Section -->
      <section id="section-campaigns" class="section">
        <div class="bg-white rounded-2xl shadow p-6 space-y-6 border border-indigo-50">
          <div>
            <h3 class="text-lg font-semibold text-indigo-700">Launch Store Campaign</h3>
            <p class="text-sm text-gray-600">Create campaigns saved to MongoDB and track their performance.</p>
          </div>

          <form id="campaignForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Campaign Name</label>
              <input id="campaignName" class="w-full border rounded px-3 py-2" placeholder="e.g., Summer Mega Sale" required />
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
              <div>
                <label class="block text-sm text-gray-600 mb-1">Budget (${shopCurrency})</label>
                <input type="number" id="campaignBudget" class="w-full border rounded px-3 py-2" placeholder="100" min="1" value="100" />
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">Duration (days)</label>
                <input type="number" id="campaignDays" class="w-full border rounded px-3 py-2" placeholder="7" min="1" value="7" />
              </div>
              <div class="text-sm bg-indigo-50/50 border rounded p-3">
                <p class="text-gray-600">Potential Reach</p>
                <p id="campaignReach" class="text-xl font-bold text-indigo-700">--</p>
              </div>
            </div>
            <div class="flex justify-end">
              <button id="launchCampaignBtn" type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Save Campaign</button>
            </div>
          </form>

          <div>
            <h4 class="text-md font-semibold text-gray-700">Your Campaigns</h4>
            <div id="campaignsList" class="mt-3 space-y-2 text-sm text-gray-700"></div>
          </div>
        </div>
      </section>

      <!-- Promotions Section -->
      <section id="section-promotions" class="section hidden">
        <div class="bg-white rounded-2xl shadow p-6 space-y-6 border border-indigo-50">
          <div>
            <h3 class="text-lg font-semibold text-indigo-700">Create Product Ads</h3>
            <p class="text-sm text-gray-600">Select a product to promote. Ads are saved to MongoDB as Pending.</p>
          </div>

          <div class="flex items-center justify-between">
            <h4 class="text-md font-semibold text-gray-700">Products</h4>
            <button id="reloadProducts" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">Reload</button>
          </div>
          <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

          <div>
            <h4 class="text-md font-semibold text-gray-700">Your Ads</h4>
            <div id="promosList" class="mt-3 space-y-2 text-sm text-gray-700"></div>
          </div>
        </div>
      </section>

      <!-- Performance Section -->
      <section id="section-performance" class="section hidden">
        <div class="bg-white rounded-2xl shadow p-6 space-y-6 border border-indigo-50">
          <div class="flex items-center justify-between mb-2">
            <div>
              <h3 class="text-lg font-semibold text-indigo-700">Performance Analytics</h3>
              <p class="text-sm text-gray-600">Track impressions, clicks, spend, and conversions.</p>
            </div>
            <div class="flex gap-2">
              <select id="analyticsFilter" class="border rounded px-2 py-1 text-sm">
                <option value="all">All</option>
                <option value="campaign">Campaigns</option>
                <option value="ad">Ads</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
                <option value="Pending">Pending</option>
              </select>
              <button id="reloadAnalytics" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">Reload</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 rounded-xl bg-gradient-to-br from-indigo-50 to-white border">
              <p class="text-sm text-gray-500">Total Promotions</p>
              <p id="metricTotal" class="text-2xl font-semibold text-gray-800">0</p>
            </div>
            <div class="p-4 rounded-xl bg-gradient-to-br from-green-50 to-white border">
              <p class="text-sm text-gray-500">Approved</p>
              <p id="metricApproved" class="text-2xl font-semibold text-gray-800">0</p>
            </div>
            <div class="p-4 rounded-xl bg-gradient-to-br from-yellow-50 to-white border">
              <p class="text-sm text-gray-500">Pending</p>
              <p id="metricPending" class="text-2xl font-semibold text-gray-800">0</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 rounded-xl bg-gradient-to-br from-indigo-50 to-white border">
              <canvas id="impressionsChart" height="150"></canvas>
            </div>
            <div class="p-4 rounded-xl bg-gradient-to-br from-indigo-50 to-white border">
              <canvas id="clicksChart" height="150"></canvas>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 rounded-xl bg-gradient-to-br from-green-50 to-white border">
              <p class="text-sm text-gray-500">Spend</p>
              <p id="metricSpend" class="text-2xl font-semibold text-gray-800">$0</p>
            </div>
            <div class="p-4 rounded-xl bg-gradient-to-br from-yellow-50 to-white border">
              <p class="text-sm text-gray-500">Conversions</p>
              <p id="metricConversions" class="text-2xl font-semibold text-gray-800">0</p>
            </div>
            <div class="p-4 rounded-xl bg-gradient-to-br from-blue-50 to-white border">
              <p class="text-sm text-gray-500">CTR</p>
              <p id="metricCTR" class="text-2xl font-semibold text-gray-800">0%</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Billing Section (local demo) -->
      <section id="section-billing" class="section hidden">
        <div class="bg-white rounded-2xl shadow p-6 space-y-6 border border-indigo-50">
          <div>
            <h3 class="text-lg font-semibold text-indigo-700">Billing & Balance</h3>
            <p class="text-sm text-gray-600">Add funds securely via Paystack. Balance reflects successful payments minus ad spend.</p>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 border">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center">
              <div>
                <p class="text-sm text-gray-500">Current Balance</p>
                <p id="currentBalance" class="text-2xl font-bold text-green-600">$0.00</p>
              </div>
              <div class="sm:col-span-2">
                <div class="flex gap-2">
                  <input type="number" id="addFundsAmount" class="flex-1 border rounded px-3 py-2" placeholder="Amount" min="1" />
                  <button id="addFundsBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add Funds</button>
                </div>
                <p class="text-xs text-gray-500 mt-1">For demo only; does not affect MongoDB.</p>
              </div>
            </div>
          </div>
          <div>
            <h4 class="text-md font-semibold text-gray-700">Transactions</h4>
            <div id="transactionsList" class="mt-3 space-y-2 text-sm text-gray-700"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Create Ad Modal -->
  <div id="adModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative max-w-md mx-auto mt-24 bg-white rounded-2xl shadow-xl p-6 space-y-4">
      <h4 class="text-lg font-semibold text-indigo-700">Create Ad</h4>
      <div class="space-y-3">
        <input id="adHeadline" class="border rounded-lg px-3 py-2 w-full text-sm" placeholder="Headline" />
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
          <div>
            <label class="block text-xs text-gray-600 mb-1">Budget (${shopCurrency})</label>
            <input id="adBudget" type="number" class="border rounded-lg px-3 py-2 w-full text-sm" placeholder="Budget" value="50" min="1" />
          </div>
          <div>
            <label class="block text-xs text-gray-600 mb-1">Duration (days)</label>
            <input id="adDays" type="number" class="border rounded-lg px-3 py-2 w-full text-sm" placeholder="Days" value="7" min="1" />
          </div>
          <div class="text-sm bg-indigo-50/50 border rounded p-3">
            <p class="text-gray-600">Potential Reach</p>
            <p id="adReachView" class="text-lg font-bold text-indigo-700">--</p>
          </div>
        </div>
        <input id="adReach" type="number" class="hidden" />
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button id="cancelAdBtn" class="px-3 py-1.5 text-sm rounded border">Cancel</button>
        <button id="saveAdBtn" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">Save Ad</button>
      </div>
    </div>
  </div>

  <!-- Paystack Inline -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
  (function(){
    // Auth context / seller
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const seller = user?.username || '';
    const sellerBadge = document.getElementById('sellerBadge');
    sellerBadge.textContent = seller ? `Signed in as: ${seller}` : 'Please sign in to manage promotions.';

    // üîó Ensure Back to Dashboard always carries ?seller=<username> if seller exists
    const backDashboard = document.getElementById('backDashboard');
    if (backDashboard) {
      backDashboard.href = seller 
        ? `dashboard/index.html?seller=${encodeURIComponent(seller)}`
        : `dashboard/index.html`;
    }
    // Seller shop currency (fallback to USD)
    let shopCurrency = 'USD';
    let currencySymbol = '$';
    const symbolMap = { USD:'$', NGN:'‚Ç¶', EUR:'‚Ç¨', GBP:'¬£', GHS:'‚Çµ', KES:'KSh', ZAR:'R', INR:'‚Çπ' };
    async function loadSellerCurrency(){
      if (!seller) return;
      try {
        const { success, data } = await jsonGet(`${API}/find?collection=users&username=${encodeURIComponent(seller)}`);
        if (success && Array.isArray(data) && data[0]){
          const u = data[0];
          const c = (u.shopSettings && (u.shopSettings.currency || u.shopSettings.shopCurrency)) || u.currency || 'USD';
          shopCurrency = String(c || 'USD').toUpperCase();
          currencySymbol = symbolMap[shopCurrency] || '$';
        }
      } catch {}
    }

    // Sidebar toggle (mobile)
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('sidebar');
    if (hamburgerBtn) {
      hamburgerBtn.addEventListener('click', () => {
        if (sidebar.classList.contains('-translate-x-full')) {
          sidebar.classList.remove('-translate-x-full');
          sidebar.classList.add('translate-x-0');
        } else {
          sidebar.classList.add('-translate-x-full');
          sidebar.classList.remove('translate-x-0');
        }
      });
    }

    // Section switching
    document.querySelectorAll('a.sidebar-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = link.getAttribute('data-section');
        if (!section) return;
        document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
        document.getElementById('section-' + section).classList.remove('hidden');
        if (window.innerWidth < 768) {
          sidebar.classList.add('-translate-x-full');
          sidebar.classList.remove('translate-x-0');
        }
      });
    });

    // Helpers
    async function jsonGet(url){ const r = await fetch(url); return r.json(); }
    async function jsonPost(url, body){ const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)}); return r.json(); }
    async function jsonPatch(url, body){ const r = await fetch(url, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)}); return r.json(); }

    // Reach calculators
    function calcReach(budget, days){ return Math.round(Math.max(0, Number(budget)) * Math.max(1, Number(days)) * 120); }
    function updateCampaignReach(){
      const b = document.getElementById('campaignBudget').value;
      const d = document.getElementById('campaignDays').value;
      document.getElementById('campaignReach').textContent = calcReach(b, d).toLocaleString();
    }
    function formatMoney(n){ return `${currencySymbol}${Number(n||0).toLocaleString()}`; }
    ['campaignBudget','campaignDays'].forEach(id => document.getElementById(id).addEventListener('input', updateCampaignReach));
    updateCampaignReach();

    // Product image helper (supports MongoDB images via /images/:id)
    function productImageUrl(p){
      const pick = () => {
        if (typeof p.image === 'string' && p.image) return p.image;
        if (Array.isArray(p.gallery)) {
          const firstStr = p.gallery.find(x => typeof x === 'string' && x);
          if (firstStr) return firstStr;
        }
        return '';
      };
      let u = pick();
      if (!u) return 'https://via.placeholder.com/600x400?text=Product';
      if (/^https?:\/\//i.test(u) || u.startsWith('data:')) return u;
      if (/^[a-f0-9]{24}$/i.test(u)) return `${API}/images/${u}`;
      if (u.startsWith('/images/') || u.startsWith('images/')) return `${API}/${u.replace(/^\/?/,'')}`;
      if (u.startsWith('/uploads/') || u.startsWith('uploads/')) return `${API}/${u.replace(/^\/?/,'')}`;
      return `${API}/uploads/${u.replace(/^\/+/, '')}`; // fallback to uploads
    }

      // Load products for seller
      async function loadProducts(){
        const grid = document.getElementById('productGrid');
        if (!grid) return;
        grid.innerHTML = '<div class="text-sm text-gray-500">Loading...</div>';
        const qs = seller ? `&seller=${encodeURIComponent(seller)}` : '';
        const { success, data } = await jsonGet(`${API}/find?collection=products${qs}`);
        if (!success){ grid.innerHTML = '<p class="text-sm text-red-600">Failed to load products.</p>'; return; }
        const items = data || [];
        grid.innerHTML = items.map(p => `
          <div class="border rounded-xl overflow-hidden bg-white shadow-sm hover:shadow transition">
            <div class="relative">
              <img src="${productImageUrl(p)}" alt="${p.name||''}" class="w-full h-40 object-cover"/>
              <span class="absolute top-2 left-2 bg-white/90 text-gray-700 text-xs px-2 py-0.5 rounded shadow">${currencySymbol}${Number(p.price||0).toLocaleString()}</span>
            </div>
            <div class="p-4 space-y-2">
              <p class="font-semibold">${p.name||'Product'}</p>
              <p class="text-xs text-gray-500 truncate">${p.description||''}</p>
                <div class="flex gap-2 pt-2">
                <button data-promote='${JSON.stringify({productId:p.id})}' class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">Promote</button>
              </div>
            </div>
          </div>
        `).join('') || '<p class="text-sm text-gray-500">No products found.</p>';
        grid.querySelectorAll('button[data-promote]')?.forEach(btn=> btn.addEventListener('click', openAdModal));
      }
      document.getElementById('reloadProducts')?.addEventListener('click', loadProducts);

      // Ad modal
      let modalProduct = null;
      function openAdModal(e){
        const payload = JSON.parse(e.currentTarget.getAttribute('data-promote'));
        modalProduct = payload;
        document.getElementById('adHeadline').value = `Ad for ${payload.productId}`;
        document.getElementById('adBudget').value = 50;
        document.getElementById('adReach').value = 1000;
        document.getElementById('adModal').classList.remove('hidden');
      }
      function closeAdModal(){ document.getElementById('adModal').classList.add('hidden'); modalProduct = null; }
      document.getElementById('cancelAdBtn').addEventListener('click', closeAdModal);
      document.getElementById('saveAdBtn').addEventListener('click', saveAd);

      function calcAdReach(){
        const b = Number(document.getElementById('adBudget').value||0);
        const d = Number(document.getElementById('adDays').value||0);
        const r = Math.round(Math.max(0,b) * Math.max(1,d) * 120);
        document.getElementById('adReachView').textContent = r.toLocaleString();
        document.getElementById('adReach').value = r;
      }
      document.getElementById('adBudget').addEventListener('input', calcAdReach);
      document.getElementById('adDays').addEventListener('input', calcAdReach);
      calcAdReach();

      async function ensureCurrencyLoaded(){ await loadSellerCurrency(); }

      function showInsufficientFunds(totalNeeded, bal){
        const existing = document.getElementById('insufficientModal');
        if (existing) existing.remove();
        const div = document.createElement('div');
        div.id = 'insufficientModal';
        div.className = 'fixed inset-0 z-50 flex items-center justify-center';
        div.innerHTML = `
          <div class="absolute inset-0 bg-black/40"></div>
          <div class="relative bg-white w-[95%] max-w-md rounded-2xl shadow-xl p-6">
            <h4 class="text-lg font-semibold text-indigo-700 mb-1">Insufficient Balance</h4>
            <p class="text-sm text-gray-600">Your current balance is <span class="font-semibold">${formatMoney(bal)}</span>, but this requires <span class="font-semibold">${formatMoney(totalNeeded)}</span>.</p>
            <p class="text-sm text-gray-600 mt-2">Reduce the budget or the duration, or add funds to continue.</p>
            <div class="mt-4 flex justify-end gap-2">
              <button id="goBilling" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">Add Funds</button>
              <button id="closeInsufficient" class="px-3 py-1.5 text-sm rounded border">Close</button>
            </div>
          </div>`;
        document.body.appendChild(div);
        document.getElementById('closeInsufficient').onclick = ()=> div.remove();
        document.getElementById('goBilling').onclick = ()=>{
          div.remove();
          document.querySelector('[data-section="billing"]').click();
        };
      }

      async function saveAd(){
        if (!modalProduct) return;
        await ensureCurrencyLoaded();
        const headline = document.getElementById('adHeadline').value.trim();
        const budget = Number(document.getElementById('adBudget').value || 0);
        const days = Number(document.getElementById('adDays').value || 0);
        const totalCost = budget * Math.max(1, days);
        const bal = await getBalance();
        if (totalCost > bal){ showInsufficientFunds(totalCost, bal); return; }
        const reach = Number(document.getElementById('adReach').value || 0);
        const body = { type:'ad', headline, budget, days, reach, productId: modalProduct.productId, seller, status:'Pending', currency: shopCurrency };
        const res = await jsonPost(`${API}/promotions`, body);
        if (!res.success){ alert('Failed to create ad'); return; }
        closeAdModal();
        await Promise.all([loadPromotions(), loadAnalytics(), renderBalance()]);
      }

      // Campaigns
      document.getElementById('campaignForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        await ensureCurrencyLoaded();
        const name = document.getElementById('campaignName').value.trim();
        const budget = Number(document.getElementById('campaignBudget').value || 0);
        const days = Number(document.getElementById('campaignDays').value || 0);
        const reach = calcReach(budget, days);
        if (!name) { alert('Enter a campaign name'); return; }
        const totalCost = budget * Math.max(1, days);
        const bal = await getBalance();
        if (totalCost > bal){ showInsufficientFunds(totalCost, bal); return; }
        const res = await jsonPost(`${API}/promotions`, { type:'campaign', name, budget, days, reach, seller, status:'Pending', currency: shopCurrency });
        if (!res.success){ alert('Failed to create campaign'); return; }
        document.getElementById('campaignName').value = '';
        document.getElementById('campaignBudget').value = '100';
        document.getElementById('campaignDays').value = '7';
        updateCampaignReach();
        await Promise.all([loadCampaigns(), loadAnalytics(), renderBalance()]);
      });

      function listItem(it){
        const when = new Date(it.createdAt || Date.now()).toLocaleString();
        return `<div class=\"p-3 border rounded flex items-center justify-between\">
          <div class=\"text-sm\">
            <p class=\"font-semibold\">${it.name || it.headline || '‚Äî'} <span class=\"text-xs text-gray-500\">${it.type}</span></p>
            <p class=\"text-xs text-gray-500\">Budget: $${it.budget||0} ‚Ä¢ Reach: ${it.reach||0} ‚Ä¢ Status: <span class=\"font-medium ${it.status==='Approved'?'text-green-600': it.status==='Rejected'?'text-red-600':'text-yellow-600'}\">${it.status||'Pending'}</span></p>
          </div>
          <div class=\"text-xs text-gray-400\">${when}</div>
        </div>`;
      }

      async function loadCampaigns(){
        const target = document.getElementById('campaignsList');
        target.innerHTML = '<p class="text-sm text-gray-500">Loading...</p>';
        const { success, data } = await jsonGet(`${API}/promotions?type=campaign&seller=${encodeURIComponent(seller)}`);
        target.innerHTML = success ? ((data||[]).map(listItem).join('') || '<p class="text-sm text-gray-500">No campaigns.</p>') : '<p class="text-sm text-red-600">Failed to load campaigns.</p>';
      }

      async function loadPromotions(){
        const target = document.getElementById('promosList');
        target.innerHTML = '<p class="text-sm text-gray-500">Loading...</p>';
        const { success, data } = await jsonGet(`${API}/promotions?type=ad&seller=${encodeURIComponent(seller)}`);
        target.innerHTML = success ? ((data||[]).map(listItem).join('') || '<p class="text-sm text-gray-500">No product ads.</p>') : '<p class="text-sm text-red-600">Failed to load product ads.</p>';
      }

      // Performance
      let charts = {};
      function setMetric(id, val){ document.getElementById(id).innerText = val; }
      function ctr(clicks, imps){ return (imps? ((clicks/imps)*100) : 0).toFixed(2) + '%'; }
      function renderCharts(labels, impressions, clicks){
        const ctx1 = document.getElementById('impressionsChart').getContext('2d');
        const ctx2 = document.getElementById('clicksChart').getContext('2d');
        charts.impressions?.destroy?.();
        charts.clicks?.destroy?.();
        charts.impressions = new Chart(ctx1, { type:'line', data:{ labels, datasets:[{ label:'Impressions', data:impressions, borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.2)', tension:.3, fill:true }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
        charts.clicks = new Chart(ctx2, { type:'bar', data:{ labels, datasets:[{ label:'Clicks', data:clicks, backgroundColor:'#22c55e' }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
      }
      async function loadAnalytics(){
        const filter = document.getElementById('analyticsFilter').value;
        const q = new URLSearchParams({ seller });
        if (['campaign','ad'].includes(filter)) q.set('type', filter);
        if (['Pending','Approved','Rejected'].includes(filter)) q.set('status', filter);
        const [promosRes, paysRes] = await Promise.all([
          jsonGet(`${API}/promotions?${q.toString()}`),
          jsonGet(`${API}/payments?seller=${encodeURIComponent(seller)}`)
        ]);
        if (!promosRes.success) return;
        const all = promosRes.data || [];
        // Spend: from promotions.spend plus successful payments total (as funding)
        const payments = (paysRes && paysRes.success ? paysRes.data : []) || [];
        const funding = payments.filter(p=> p.status==='success' || p.status==='pending').reduce((sum,p)=> sum + Number(p.amount||0), 0);
        setMetric('metricTotal', all.length);
        setMetric('metricApproved', all.filter(x=>x.status==='Approved').length);
        setMetric('metricPending', all.filter(x=>x.status==='Pending').length);
        const labels = [], imps = [], clks = [];
        let spend = 0, conv = 0, tImps = 0, tClks = 0;
        all.slice(-10).forEach((p, idx)=>{
          labels.push(p.name || p.headline || `Promo ${idx+1}`);
          imps.push(p.impressions||0); clks.push(p.clicks||0);
          spend += p.spend||0; conv += p.conversions||0; tImps += p.impressions||0; tClks += p.clicks||0;
        });
        renderCharts(labels, imps, clks);
        setMetric('metricSpend', `$${(spend).toFixed(2)}`);
        setMetric('metricConversions', `${conv}`);
        setMetric('metricCTR', ctr(tClks, tImps));
      }
      document.getElementById('reloadAnalytics').addEventListener('click', loadAnalytics);
      document.getElementById('analyticsFilter').addEventListener('change', loadAnalytics);

      // Billing with Paystack + persist payments to MongoDB
      const BAL_KEY = `promo_balance_${seller}`;
      const TX_KEY = `promo_transactions_${seller}`;
      async function getBalance(){
        try {
          const [paymentsRes, promosRes] = await Promise.all([
            jsonGet(`${API}/payments?seller=${encodeURIComponent(seller)}&status=success`),
            jsonGet(`${API}/promotions?seller=${encodeURIComponent(seller)}`)
          ]);
          const paid = (paymentsRes.success ? paymentsRes.data : []).reduce((s,p)=> s + Number(p.amount||0), 0);
          const spend = (promosRes.success ? promosRes.data : []).reduce((s,p)=> s + Number(p.spend||0), 0);
          return Math.max(0, paid - spend);
        } catch { return 0; }
      }
      async function renderBalance(){
        const bal = await getBalance();
        document.getElementById('currentBalance').textContent = `$${Number(bal).toFixed(2)}`;
      }
      async function fetchTransactions(){
        const paymentsRes = await jsonGet(`${API}/payments?seller=${encodeURIComponent(seller)}`);
        const list = document.getElementById('transactionsList');
        if (!paymentsRes.success){ list.innerHTML = '<p class="text-sm text-red-600">Failed to load transactions.</p>'; return; }
        const items = paymentsRes.data || [];
        list.innerHTML = items.map(p => `<div class="flex justify-between bg-gray-50 p-2 rounded"><span>${new Date(p.createdAt||Date.now()).toLocaleString()} ‚Äì ${p.gateway||'paystack'} (${p.status})</span><span class="font-semibold">$${Number(p.amount||0).toFixed(2)}</span></div>`).join('') || '<p class="text-sm text-gray-500">No transactions yet.</p>';
      }

      async function savePaymentToDB({ reference, amount, currency='NGN', meta={} }){
        try {
          const res = await jsonPost(`${API}/payments`, { seller, amount, currency, reference, gateway:'paystack', meta });
          if (!res.success) console.warn('Payment save failed', res);
        } catch (e) { console.error('Payment save error', e); }
      }

      function startPaystack(amount){
        if (!window.PaystackPop) { alert('Paystack not loaded'); return; }
        const email = (user && user.email) || `${seller}@example.com`;
        const reference = `promo_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
        const handler = PaystackPop.setup({
          key: 'pk_test_232531a5c927ef2cc67ed1b85af3f26e3b8ed2f2', // test key (replace)
          email: String(email),
          amount: Math.round(Number(amount || 0) * 100), // minor units
          currency: shopCurrency,
          ref: String(reference),
          callback: function(response){
            (async ()=>{
              const ref = response && response.reference ? response.reference : reference;
              try { await savePaymentToDB({ reference: ref, amount: Number(amount), currency: shopCurrency, meta:{ via:'promotion-center' } }); } catch(e){}
              try { await jsonPatch(`${API}/payments/${encodeURIComponent(ref)}`, { status:'success', currency: shopCurrency }); } catch(e) { console.warn('patch payment status failed', e); }
              await Promise.all([renderBalance(), fetchTransactions(), loadAnalytics()]);
              alert('‚úÖ Payment successful');
            })();
          },
          onClose: function(){ console.log('Paystack window closed'); }
        });
        handler.openIframe();
      }

      document.getElementById('addFundsBtn').addEventListener('click', (e)=>{
        e.preventDefault();
        const amt = Number(document.getElementById('addFundsAmount').value||0);
        if (amt<=0) return alert('Enter a valid amount');
        startPaystack(amt);
        document.getElementById('addFundsAmount').value='';
      });

      // Initial loads
      renderBalance();
      fetchTransactions();
      loadProducts();
      loadCampaigns();
      loadPromotions();
      loadAnalytics();
    })();
  </script>
</body>
</html>