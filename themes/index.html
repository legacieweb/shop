<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Select Theme - ShopRight</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Lora:wght@400;500;600;700&display=swap');
    
    body { 
      font-family: 'Lora', serif; 
      background: #f8f6f0;
      color: #2c2c2c;
    }
    
    .classic-header {
      font-family: 'Crimson Text', serif;
    }
    
    .theme-card {
      transform: translateY(0);
      transition: all 0.4s ease-in-out;
      border: 2px solid #d4af37;
      background: #ffffff;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.15);
    }
    
    .theme-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(212, 175, 55, 0.25);
      border-color: #b8941f;
    }
    
    .theme-card.restricted {
      border-color: #8b7355;
      background: #faf9f6;
      position: relative;
    }
    
    .theme-card.restricted::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(139, 115, 85, 0.1) 10px,
        rgba(139, 115, 85, 0.1) 20px
      );
      pointer-events: none;
    }
    
    .theme-image {
      transition: all 0.4s ease-in-out;
      border-bottom: 3px solid #d4af37;
    }
    
    .theme-card:hover .theme-image {
      transform: scale(1.02);
    }
    
    .classic-gradient {
      background: linear-gradient(135deg, #8b7355 0%, #d4af37 100%);
    }
    
    .classic-button {
      background: #d4af37;
      color: #2c2c2c;
      border: 2px solid #b8941f;
      transition: all 0.3s ease;
    }
    
    .classic-button:hover {
      background: #b8941f;
      color: #ffffff;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
    }
    
    .classic-button.disabled {
      background: #8b7355;
      color: #c0c0c0;
      border-color: #6b5a47;
      cursor: not-allowed;
    }
    
    .classic-button.disabled:hover {
      transform: none;
      box-shadow: none;
      background: #8b7355;
    }
    
    .premium-badge {
      background: linear-gradient(135deg, #8b7355 0%, #d4af37 100%);
    }
    
    .modal-backdrop {
      background: rgba(44, 44, 44, 0.85);
      backdrop-filter: blur(10px);
    }
    
    .filter-chip {
      transition: all 0.3s ease;
      background: #ffffff;
      border: 2px solid #d4af37;
      color: #2c2c2c;
    }
    
    .filter-chip:hover {
      background: #f8f6f0;
      border-color: #b8941f;
      transform: translateY(-2px);
    }

    .filter-chip.active {
      background: #d4af37;
      color: #2c2c2c;
      border-color: #b8941f;
      font-weight: 600;
    }

    .theme-tag {
      animation: fadeInUp 0.3s ease-out;
      background: #f8f6f0;
      border: 2px solid #d4af37;
      color: #2c2c2c;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .classic-text {
      color: #8b7355;
      font-family: 'Crimson Text', serif;
    }

    .classic-card {
      background: #ffffff;
      border: 2px solid #d4af37;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.15);
    }

    .theme-name-overlay {
      background: linear-gradient(to top, rgba(44, 44, 44, 0.9) 0%, rgba(44, 44, 44, 0.6) 50%, transparent 100%);
    }

    .restriction-overlay {
      background: rgba(139, 115, 85, 0.9);
      backdrop-filter: blur(3px);
    }

    .classic-border {
      border: 3px solid #d4af37;
      border-style: double;
    }

    .ornamental-divider {
      border-top: 3px double #d4af37;
      position: relative;
    }

    .ornamental-divider::before {
      content: '‚ù¶';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: #f8f6f0;
      color: #d4af37;
      padding: 0 15px;
      font-size: 20px;
    }
  </style>
</head>
<body>

<!-- Classic Header -->
<header class="classic-card">
  <div class="max-w-7xl mx-auto px-6 py-8">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <div>
          <h1 class="text-5xl font-bold classic-header classic-text">Theme Gallery</h1>
        </div>
      </div>
      <a href="#" id="backToShop" class="flex items-center space-x-3 classic-button px-6 py-3 rounded-lg font-semibold">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
        </svg>
        <span>Dashboard</span>
      </a>
    </div>
  </div>
</header>

<!-- Premium Status Banner -->
<div id="premiumBanner" class="hidden classic-gradient text-white text-center py-4 font-semibold classic-header text-lg">
  ‚ú¶ Premium Member - Access to All Premium Themes ‚ú¶
</div>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 py-12">

  <!-- Filter Section -->
  <div class="classic-card rounded-lg p-8 mb-10">
    <h3 class="text-2xl font-bold classic-header classic-text mb-6 text-center">Refine Your Selection</h3>
    
    <!-- Filter Buttons -->
    <div class="mb-8 flex flex-wrap justify-center gap-4">
      <button data-toggle="planFilters" class="classic-button px-6 py-3 rounded-lg font-semibold">
        Filter by Plan
      </button>
      <button data-toggle="featureFilters" class="classic-button px-6 py-3 rounded-lg font-semibold">
        Filter by Features
      </button>
      <button data-toggle="businessFilters" class="classic-button px-6 py-3 rounded-lg font-semibold">
        Filter by Business Type
      </button>
    </div>

    <!-- Collapsible Filter Sections -->
    <div id="planFilters" class="hidden mb-6">
      <div class="ornamental-divider mb-6"></div>
      <div class="flex flex-wrap justify-center gap-3">
        <button class="tier-filter-btn active filter-chip px-6 py-3 rounded-lg font-semibold" data-tier="all">All Themes</button>
        <button class="tier-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-tier="free">Free</button>
        <button class="tier-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-tier="basic">Basic</button>
        <button class="tier-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-tier="pro">Pro</button>
      </div>
    </div>

    <div id="featureFilters" class="hidden mb-6">
      <div class="ornamental-divider mb-6"></div>
      <div class="flex flex-wrap justify-center gap-3">
        <button class="feature-filter-btn active filter-chip px-6 py-3 rounded-lg font-semibold" data-feature="all">All Features</button>
        <button class="feature-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-feature="animated">Animated Layouts</button>
        <button class="feature-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-feature="social">Social Media Ready</button>
        <button class="feature-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-feature="responsive">Mobile Optimized</button>
        <button class="feature-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-feature="interactive">Interactive Elements</button>
        <button class="feature-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-feature="dark">Dark Theme Support</button>
      </div>
    </div>

    <div id="businessFilters" class="hidden mb-6">
      <div class="ornamental-divider mb-6"></div>
      <div class="flex flex-wrap justify-center gap-3">
        <button class="bestfor-filter-btn active filter-chip px-6 py-3 rounded-lg font-semibold" data-bestfor="all">All Business Types</button>
        <button class="bestfor-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-bestfor="Fashion brands">Fashion Brands</button>
        <button class="bestfor-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-bestfor="Tech products">Tech Products</button>
        <button class="bestfor-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-bestfor="Luxury brands">Luxury Brands</button>
        <button class="bestfor-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-bestfor="Eco-products">Eco-Friendly</button>
        <button class="bestfor-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-bestfor="Handmade goods">Handmade Goods</button>
        <button class="bestfor-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold" data-bestfor="Professional services">Professional Services</button>
      </div>
    </div>
  </div>

  <!-- Active Filters Display -->
  <div id="activeFilters" class="mb-10 hidden">
    <div class="classic-card rounded-lg p-6">
      <div class="flex items-center flex-wrap gap-3 justify-center">
        <span class="font-semibold classic-text classic-header text-lg">Active Filters:</span>
        <div id="activeFilterTags" class="flex flex-wrap gap-2"></div>
        <button id="clearFilters" class="text-red-600 hover:text-red-800 font-semibold underline ml-3">Clear All</button>
      </div>
    </div>
  </div>

  <!-- Theme Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" id="themeGrid"></div>

  <!-- No Results Message -->
  <div id="noResults" class="hidden text-center py-20">
    <div class="classic-card rounded-lg p-12">
      <div class="text-8xl mb-6">üîç</div>
      <h3 class="text-3xl font-bold classic-header classic-text mb-4">No Themes Found</h3>
      <p class="text-gray-600 mb-8 text-lg">Please adjust your filters to discover more distinguished themes</p>
      <button id="resetFilters" class="classic-button px-8 py-4 rounded-lg font-semibold text-lg">
        Reset All Filters
      </button>
    </div>
  </div>

</main>

<!-- Toggle Script -->
<script>
  document.querySelectorAll('[data-toggle]').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.getElementById(btn.dataset.toggle);
      target.classList.toggle('hidden');
    });
  });
</script>

<!-- Enhanced Theme Modal -->
<div id="themeModal" class="fixed inset-0 z-50 hidden modal-backdrop">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="classic-card rounded-lg shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-auto">
      <div class="p-10">
        <button class="mb-8 flex items-center space-x-3 classic-button px-4 py-2 rounded-lg font-semibold" onclick="closeModal()">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
          </svg>
          <span>Back to Themes</span>
        </button>
        <div id="themeDetails" class="space-y-10"></div>
      </div>
    </div>
  </div>
</div>

<script>
const API = "https://shop-stp5.onrender.com";
const sellerParam = new URLSearchParams(location.search).get("seller");
if (!sellerParam) location.href = "https://iyonicorp.com";
document.getElementById("backToShop").href = `../dashboard?seller=${encodeURIComponent(sellerParam)}`;

let currentUserPlan = "free";
let currentFilters = {
  tier: "all",
  feature: "all",
  bestfor: "all"
};

// Enhanced themes with portrait preview images
const themes = [
  {
    name: "Classic Light",
    tier: "free",
    previewImage: "https://placehold.co/400x600/f3f4f6/374151?text=Classic+Light+Theme",
    features: ["responsive", "social"],
    screenshots: [
      "https://placehold.co/800x500/f3f4f6/374151?text=Classic+Homepage",
      "https://placehold.co/800x500/f9fafb/6b7280?text=Product+Grid",
      "https://placehold.co/800x500/ffffff/9ca3af?text=Clean+Layout"
    ],
    featureList: [
      "Timeless and professional design",
      "Mobile-first responsive layout", 
      "Clean product grid system",
      "Easy navigation structure",
      "Fast loading performance"
    ],
    description: "Perfect for traditional businesses seeking a clean, professional appearance that builds trust with customers.",
    bestFor: ["Professional services", "Traditional retail", "B2B businesses"],
    colorScheme: ["#f9fafb", "#ffffff", "#374151", "#6b7280"],
    theme: {
      layout: "classic",
      title: "Classic Store",
      name: "Welcome to classic store",
      bio: "Best deals, always.",
      header: "All products",
      bgColor: "#f9fafb",
      logo: "https://placehold.co/40x40/1e40af/ffffff?text=C",
      heroImage: "https://placehold.co/1920x600/f3f4f6/374151?text=Classic+Hero+Section"
    }
  },
  {
    name: "Minimalist Pro",
    tier: "pro",
    previewImage: "https://placehold.co/400x600/fef08a/ca8a04?text=Minimalist+Pro+Theme",
    features: ["animated", "responsive", "social"],
    screenshots: [
      "https://placehold.co/800x500/fef08a/ca8a04?text=Bold+Hero",
      "https://placehold.co/800x500/fef9c3/f59e0b?text=Bright+Cards",
      "https://placehold.co/800x500/fef3c7/eab308?text=Vibrant+Grid"
    ],
    featureList: [
      "Eye-catching color palette",
      "Smooth hover animations",
      "Responsive design for all devices",
      "Social media integration",
      "Inventory showcases",
      "Engaging call-to-action buttons"
    ],
    description: "A vibrant, energetic design that captures attention and encourages exploration of your products.",
    bestFor: ["Retail stores", "E-commerce platforms", "Creative businesses"],
    colorScheme: ["#fef3c7", "#fef08a", "#ca8a04", "#f59e0b"],
    theme: {
      layout: "minimalist",
      title: "minimalist",
      name: "minimalist Shop",
      bio: "Where colors come alive.",
      header: "New Arrivals",
      bgColor: "#fef3c7",
      logo: "https://placehold.co/40x40/ca8a04/ffffff?text=B",
      heroImage: "https://i.imgur.com/mE0WxlR.png"
    }
  },
  {
    name: "Modern Vibe",
    tier: "basic",
    previewImage: "https://placehold.co/400x600/ddd6fe/6d28d9?text=Modern+Vibe+Theme",
    features: ["animated", "interactive", "responsive", "social"],
    screenshots: [
      "https://placehold.co/800x500/ddd6fe/6d28d9?text=Modern+Hero",
      "https://placehold.co/800x500/f3f4f6/8b5cf6?text=Card+Layout",
      "https://placehold.co/800x500/fafafa/a855f7?text=Grid+System"
    ],
    featureList: [
      "Contemporary card-based design",
      "Smooth animations and transitions",
      "Advanced filtering options",
      "Social media integration",
      "Modern typography system",
      "Interactive hover effects"
    ],
    description: "A sleek, contemporary design that appeals to modern shoppers with its clean lines and intuitive interface.",
    bestFor: ["Fashion brands", "Tech products", "Lifestyle businesses"],
    colorScheme: ["#fafafa", "#ddd6fe", "#6d28d9", "#8b5cf6"],
    theme: {
      layout: "modern",
      title: "Modern Vibe",
      name: "Modern Vibe Shop",
      bio: "Where style meets function.",
      header: "Latest Picks",
      bgColor: "#fafafa",
      logo: "https://placehold.co/40x40/6d28d9/ffffff?text=M",
      heroImage: "https://placehold.co/1920x600/ddd6fe/6d28d9?text=Modern+Hero+Banner"
    }
  },
  {
    name: "Cyber Neon",
    tier: "pro",
    previewImage: "https://placehold.co/400x600/0f172a/38bdf8?text=Cyber+Neon+Theme",
    features: ["animated", "interactive", "dark", "social"],
    screenshots: [
      "https://placehold.co/800x500/0f172a/38bdf8?text=Cyber+Interface",
      "https://placehold.co/800x500/1e293b/06b6d4?text=Neon+Effects",
      "https://placehold.co/800x500/0f172a/0ea5e9?text=Dark+Theme"
    ],
    featureList: [
      "Futuristic dark theme design",
      "Animated neon glow effects",
      "High contrast accessibility",
      "Interactive particle backgrounds",
      "Custom cursor effects",
      "Sound feedback integration",
      "Advanced parallax scrolling"
    ],
    description: "A cutting-edge cyberpunk aesthetic that creates an immersive, high-tech shopping experience.",
    bestFor: ["Gaming products", "Tech gadgets", "Digital services", "Creative agencies"],
    colorScheme: ["#0f172a", "#1e293b", "#38bdf8", "#06b6d4"],
    theme: {
      layout: "cyber",
      title: "Cyber Shop",
      name: "Cyber Shop",
      bio: "Electric deals await.",
      header: "Hot Picks",
      bgColor: "#0f172a",
      logo: "https://placehold.co/40x40/38bdf8/0f172a?text=C",
      heroImage: "https://placehold.co/1920x600/0f172a/38bdf8?text=Cyberpunk+Hero"
    }
  },
  {
    name: "Vintage Touch",
    tier: "basic",
    previewImage: "https://placehold.co/400x600/fef3c7/d97706?text=Vintage+Touch+Theme",
    features: ["responsive", "social"],
    screenshots: [
      "https://placehold.co/800x500/fef3c7/d97706?text=Vintage+Style",
      "https://placehold.co/800x500/fbbf24/92400e?text=Retro+Layout",
      "https://placehold.co/800x500/fed7aa/c2410c?text=Classic+Grid"
    ],
    featureList: [
      "Warm, nostalgic color palette",
      "Vintage typography and fonts",
      "Textured backgrounds",
      "Classic grid layouts",
      "Retro-inspired icons",
      "Sepia photo filters"
    ],
    description: "Evokes nostalgia with warm tones and classic design elements perfect for artisanal and handcrafted products.",
    bestFor: ["Handmade goods", "Antiques", "Artisanal products", "Vintage items"],
    colorScheme: ["#fef3c7", "#fed7aa", "#d97706", "#92400e"],
    theme: {
      layout: "vintage",
      title: "Vintage shop",
      name: "Vintage shop",
      bio: "Retro shopping experience.",
      header: "Editor's Picks",
      bgColor: "#fef3c7",
      logo: "https://placehold.co/40x40/d97706/ffffff?text=V",
      heroImage: "https://placehold.co/1920x600/fef3c7/d97706?text=Vintage+Hero"
    }
  },
  {
    name: "Elegant Minimal",
    tier: "pro",
    previewImage: "https://placehold.co/400x600/ffffff/000000?text=Elegant+Minimal+Theme",
    features: ["animated", "interactive", "responsive"],
    screenshots: [
      "https://placehold.co/800x500/ffffff/000000?text=Minimal+Clean",
      "https://placehold.co/800x500/f8fafc/334155?text=White+Space",
      "https://placehold.co/800x500/ffffff/64748b?text=Typography"
    ],
    featureList: [
      "Timeless minimalist aesthetic",
      "Premium, balanced typography system",
      "Smooth micro-interactions",
      "Generous, airy white space",
      "Delicate and strategic shadow usage",
      "Visual emphasis on product photography",
      "Graceful, refined loading animations"
    ],
    description: "An expression of refined simplicity where minimalism meets luxury. This layout strips away distractions, allowing your products to shine with elegance and clarity.",
    bestFor: ["Luxury brands", "Designer collections", "Art & photography portfolios", "Premium lifestyle services"],
    colorScheme: ["#ffffff", "#f8fafc", "#000000", "#334155"],
    theme: {
      layout: "elegant",
      title: "Elegant Minimal",
      name: "Sop Elegance",
      bio: "Simplicity, perfected.",
      header: "Curated Selections",
      bgColor: "#ffffff",
      logo: "https://placehold.co/40x40/000000/ffffff?text=M",
      heroImage: "https://placehold.co/1920x600/ffffff/000000?text=Minimal+Hero"
    }
  },
  {
    name: "Nature Inspired",
    tier: "pro",
    previewImage: "https://placehold.co/400x600/065f46/d1fae5?text=Nature+Inspired+Theme",
    features: ["animated", "responsive", "social"],
    screenshots: [
      "https://placehold.co/800x500/065f46/d1fae5?text=Nature+Theme",
      "https://placehold.co/800x500/047857/a7f3d0?text=Green+Design",
      "https://placehold.co/800x500/059669/6ee7b7?text=Eco+Layout"
    ],
    featureList: [
      "Earth-tone color palette",
      "Organic shapes and patterns",
      "Sustainability focus",
      "Nature-inspired animations",
      "Eco-friendly messaging",
      "Carbon footprint tracking",
      "Green certification badges"
    ],
    description: "Embrace sustainability with an eco-friendly design that resonates with environmentally conscious consumers.",
    bestFor: ["Eco-products", "Organic goods", "Sustainable brands", "Outdoor gear"],
    colorScheme: ["#065f46", "#047857", "#d1fae5", "#a7f3d0"],
    theme: {
      layout: "nature",
      title: "Nature Inspired",
      name: "Green shop green",
      bio: "Sustainable shopping experience.",
      header: "Eco Favorites",
      bgColor: "#f0fdf4",
      logo: "https://placehold.co/40x40/065f46/ffffff?text=N",
      heroImage: "https://placehold.co/1920x600/065f46/d1fae5?text=Nature+Hero"
    }
  }
];

const themeGrid = document.getElementById("themeGrid");
const themeModal = document.getElementById("themeModal");
const themeDetails = document.getElementById("themeDetails");

async function getUserPlan() {
  try {
    // Prefer plan from dashboard (localStorage), fallback to API
    const stored = JSON.parse(localStorage.getItem("user") || "{}");
    if (stored && stored.username === sellerParam && stored.plan) {
      currentUserPlan = String(stored.plan).toLowerCase();
    }

    // Refresh from backend for accuracy
    const res = await fetch(`${API}/api/subscription-info?username=${encodeURIComponent(sellerParam)}`);
    if (res.ok) {
      const payload = await res.json();
      if (payload && payload.success && payload.user?.plan) {
        currentUserPlan = String(payload.user.plan).toLowerCase();
        // Merge back into localStorage user so themes/shop stay in sync with dashboard
        const updatedUser = { ...(stored || {}), ...payload.user, username: sellerParam };
        localStorage.setItem("user", JSON.stringify(updatedUser));
      }
    }

    if (currentUserPlan === "premium" || currentUserPlan === "pro") {
      document.getElementById("premiumBanner").classList.remove("hidden");
    }
  } catch (err) {
    console.error("Failed to fetch subscription info:", err);
    currentUserPlan = currentUserPlan || "free";
  }
}

function getTierAccess(userPlan) {
  const planHierarchy = {
    "free": ["free"],
    "basic": ["free", "basic"], 
    "pro": ["free", "basic", "pro"],
    "premium": ["free", "basic", "pro"]
  };
  return planHierarchy[userPlan] || ["free"];
}

function filterThemes() {
  let filteredThemes = themes;

  // Filter by tier
  if (currentFilters.tier !== "all") {
    filteredThemes = filteredThemes.filter(t => t.tier === currentFilters.tier);
  }

  // Filter by feature
  if (currentFilters.feature !== "all") {
    filteredThemes = filteredThemes.filter(t => t.features.includes(currentFilters.feature));
  }

  // Filter by best for
  if (currentFilters.bestfor !== "all") {
    filteredThemes = filteredThemes.filter(t => t.bestFor.includes(currentFilters.bestfor));
  }

  return filteredThemes;
}

function updateActiveFilters() {
  const activeFilters = document.getElementById("activeFilters");
  const activeFilterTags = document.getElementById("activeFilterTags");
  
  const hasActiveFilters = Object.values(currentFilters).some(filter => filter !== "all");
  
  if (hasActiveFilters) {
    activeFilters.classList.remove("hidden");
    activeFilterTags.innerHTML = "";
    
    Object.entries(currentFilters).forEach(([type, value]) => {
      if (value !== "all") {
        const tag = document.createElement("span");
        tag.className = "theme-tag inline-flex items-center px-4 py-2 rounded-lg font-semibold";
        tag.innerHTML = `
          ${value}
          <button onclick="removeFilter('${type}')" class="ml-2 hover:text-red-600 transition-colors duration-200">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        `;
        activeFilterTags.appendChild(tag);
      }
    });
  } else {
    activeFilters.classList.add("hidden");
  }
}

function renderThemes() {
  const filteredThemes = filterThemes();
  const accessibleTiers = getTierAccess(currentUserPlan);
  
  themeGrid.innerHTML = "";
  
  if (filteredThemes.length === 0) {
    document.getElementById("noResults").classList.remove("hidden");
    return;
  } else {
    document.getElementById("noResults").classList.add("hidden");
  }
  
  filteredThemes.forEach((t, i) => {
    const originalIndex = themes.indexOf(t);
    const tierLabel = t.tier.toUpperCase();
    const canAccess = accessibleTiers.includes(t.tier);
    
    let tierColor, tierIcon;
    switch(t.tier) {
      case "free":
        tierColor = "bg-green-600 text-white";
        tierIcon = "FREE";
        break;
      case "basic":
        tierColor = "bg-amber-600 text-white";
        tierIcon = "BASIC";
        break;
      case "pro":
        tierColor = "bg-purple-600 text-white";
        tierIcon = "PRO";
        break;
    }

    const card = document.createElement("div");
    card.className = `theme-card rounded-lg overflow-hidden cursor-pointer ${!canAccess ? 'restricted' : ''}`;
    
    card.innerHTML = `
      <div class="relative group h-80">
        <img src="${t.previewImage}" alt="${t.name}" class="theme-image w-full h-full object-cover">
        
        <!-- Theme Name Overlay -->
        <div class="absolute bottom-0 left-0 right-0 theme-name-overlay">
          <div class="p-6">
            <h3 class="text-2xl font-bold text-white mb-2 classic-header">${t.name}</h3>
          </div>
        </div>
        
        <!-- Plan Badge -->
        <div class="absolute top-4 right-4">
          <span class="${tierColor} px-4 py-2 rounded-full text-xs font-bold shadow-lg classic-border">
            ${tierIcon}
          </span>
        </div>
        
        <!-- Restriction Overlay for locked themes -->
        ${!canAccess ? `
          <div class="absolute inset-0 flex items-center justify-center restriction-overlay">
            <div class="text-center text-white">
              <svg class="w-12 h-12 mx-auto mb-3 opacity-80" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
              </svg>
              <div class="text-sm font-semibold">Upgrade Required</div>
              <div class="text-xs mt-1 opacity-80">Click to view details</div>
            </div>
          </div>
        ` : ''}
        
        <!-- Hover Overlay -->
        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
          <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform translate-y-4 group-hover:translate-y-0">
            <button class="viewThemeBtn classic-button px-8 py-3 rounded-lg font-semibold shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105" data-index="${originalIndex}">
              View Details
            </button>
          </div>
        </div>
      </div>
    `;
    
    themeGrid.appendChild(card);
  });

  updateActiveFilters();
}

function openModal(index) {
  const t = themes[index];
  const accessibleTiers = getTierAccess(currentUserPlan);
  const canAccess = accessibleTiers.includes(t.tier);
  
  let tierColor, tierIcon;
  switch(t.tier) {
    case "free":
      tierColor = "bg-green-100 text-green-800 border-green-300";
      tierIcon = "FREE";
      break;
    case "basic":
      tierColor = "bg-amber-100 text-amber-800 border-amber-300";
      tierIcon = "BASIC";
      break;
    case "pro":
      tierColor = "bg-purple-100 text-purple-800 border-purple-300";
      tierIcon = "PRO";
      break;
  }

  const featureBadges = t.features.map(feature => {
    const featureLabels = {
      animated: { label: "Animated Layouts", color: "bg-blue-50 text-blue-800 border-blue-300", icon: "üé¨" },
      social: { label: "Social Media Ready", color: "bg-pink-50 text-pink-800 border-pink-300", icon: "üì±" },
      responsive: { label: "Mobile Optimized", color: "bg-green-50 text-green-800 border-green-300", icon: "üì±" },
      interactive: { label: "Interactive Elements", color: "bg-indigo-50 text-indigo-800 border-indigo-300", icon: "‚ú®" },
      dark: { label: "Dark Theme Support", color: "bg-gray-50 text-gray-800 border-gray-300", icon: "üåô" }
    };
    
    const featureInfo = featureLabels[feature] || { label: feature, color: "bg-gray-50 text-gray-800 border-gray-300", icon: "‚ö°" };
    return `<span class="inline-flex items-center space-x-3 ${featureInfo.color} px-4 py-3 rounded-lg border-2 font-semibold text-sm shadow-md hover:shadow-lg transition-all duration-300"><span class="text-lg">${featureInfo.icon}</span><span>${featureInfo.label}</span></span>`;
  }).join('');

  themeDetails.innerHTML = `
    <div class="flex items-start justify-between mb-12">
      <div class="flex-1">
        <h2 class="text-5xl font-bold classic-header classic-text mb-4">${t.name}</h2>
        <p class="text-gray-600 text-xl leading-relaxed max-w-4xl">${t.description}</p>
      </div>
      <span class="${tierColor} px-6 py-4 rounded-lg font-bold uppercase border-2 text-lg tracking-wide shadow-lg classic-border">
        ${tierIcon}
      </span>
    </div>

    <div class="ornamental-divider mb-12"></div>

    <div class="grid lg:grid-cols-2 gap-12 mb-12">
      <div>
        <h4 class="text-2xl font-bold mb-6 classic-header classic-text flex items-center space-x-3">
          <span class="w-3 h-3 bg-amber-600 rounded-full"></span>
          <span>Distinguished Features</span>
        </h4>
        <div class="space-y-4">
          ${t.featureList.map(f => `<div class="flex items-start space-x-4 p-4 classic-card rounded-lg hover:shadow-lg transition-all duration-300"><div class="w-3 h-3 bg-amber-600 rounded-full mt-2 flex-shrink-0"></div><span class="text-gray-700 font-medium text-lg">${f}</span></div>`).join('')}
        </div>
      </div>
      
      <div>
        <h4 class="text-2xl font-bold mb-6 classic-header classic-text flex items-center space-x-3">
          <span class="w-3 h-3 bg-amber-600 rounded-full"></span>
          <span>Ideal For</span>
        </h4>
        <div class="space-y-4 mb-8">
          ${t.bestFor.map(item => `<div class="classic-card rounded-lg px-6 py-4 text-gray-800 font-bold text-center transform hover:scale-105 transition-transform duration-300 shadow-lg">${item}</div>`).join('')}
        </div>
        
        <div>
          <h5 class="text-lg font-bold mb-4 classic-text uppercase tracking-wide classic-header">Color Palette</h5>
          <div class="flex space-x-4">
            ${t.colorScheme.map(color => `<div class="flex flex-col items-center group"><div class="w-16 h-16 rounded-lg classic-border shadow-xl group-hover:scale-110 transition-transform duration-300" style="background-color: ${color}"></div><span class="text-sm text-gray-500 mt-3 font-mono font-semibold">${color}</span></div>`).join('')}
          </div>
        </div>
      </div>
    </div>

    <div class="ornamental-divider mb-12"></div>

    <div class="mb-12">
      <h4 class="text-2xl font-bold mb-6 classic-header classic-text flex items-center space-x-3">
        <span class="w-3 h-3 bg-amber-600 rounded-full"></span>
        <span>Feature Highlights</span>
      </h4>
      <div class="flex flex-wrap gap-4">
        ${featureBadges}
      </div>
    </div>

    <div class="ornamental-divider mb-12"></div>

    <div class="mb-12">
      <h4 class="text-2xl font-bold mb-6 classic-header classic-text flex items-center space-x-3">
        <span class="w-3 h-3 bg-amber-600 rounded-full"></span>
        <span>Preview Gallery</span>
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        ${t.screenshots.map((img, idx) => `
          <div class="relative group overflow-hidden rounded-lg shadow-2xl hover:shadow-3xl transition-all duration-500 classic-border">
            <img src="${img}" class="w-full h-64 object-cover transition-transform duration-700 group-hover:scale-110" />
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
            <div class="absolute bottom-6 left-6 text-white font-bold text-lg opacity-0 group-hover:opacity-100 transition-opacity duration-500 classic-header">
              Preview ${idx + 1}
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="ornamental-divider pt-10 mb-10"></div>

    <div class="flex flex-col sm:flex-row gap-6">
      <button onclick="previewTheme(${index})" class="flex-1 classic-button py-5 px-8 rounded-lg font-bold text-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center space-x-4 shadow-xl hover:shadow-2xl">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
          <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
        </svg>
        <span>Live Preview</span>
      </button>
      
      ${canAccess
        ? `<button onclick="applyTheme(${index})" class="flex-1 classic-gradient text-white py-5 px-8 rounded-lg font-bold text-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center space-x-4 shadow-xl hover:shadow-2xl">
             <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
               <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
             </svg>
             <span>Apply Theme</span>
           </button>`
        : `<button onclick="showUpgradeModal()" class="flex-1 classic-button disabled py-5 px-8 rounded-lg font-bold text-lg flex items-center justify-center space-x-4 shadow-xl">
             <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
               <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
             </svg>
             <span>Upgrade Required</span>
           </button>`
      }
    </div>

    ${!canAccess ? `
      <div class="mt-8 p-6 classic-card rounded-lg bg-amber-50 border-amber-300">
        <div class="text-center">
          <h5 class="text-lg font-bold classic-header classic-text mb-3">Upgrade Your Plan</h5>
          <p class="text-gray-700 mb-4">This premium theme requires a ${t.tier} plan or higher to apply to your store.</p>
          <p class="text-sm text-gray-600">You can still preview this theme, but you'll need to upgrade to use it.</p>
        </div>
      </div>
    ` : ''}
  `;

  themeModal.classList.remove("hidden");
  document.body.style.overflow = "hidden";
}

function closeModal() {
  themeModal.classList.add("hidden");
  document.body.style.overflow = "auto";
}

function previewTheme(index) {
  const selectedTheme = themes[index].theme;
  // Store the preview theme
  const previewData = JSON.stringify(selectedTheme);
  sessionStorage.setItem("previewTheme", previewData);
  window.open("../preview?seller=" + sellerParam, "_blank");
}

async function applyTheme(index) {
  const selectedTheme = themes[index].theme;
  const layoutName = selectedTheme.layout;

  try {
    // Fetch the selected layout HTML (JSON response with { data: { html } })
    const layoutRes = await fetch(`${API}/layouts/${layoutName}`);
    if (!layoutRes.ok) throw new Error("Failed to fetch layout");
    const layoutJson = await layoutRes.json();
    const layoutHTML = layoutJson?.data?.html || "";

    if (!layoutHTML) throw new Error("Empty layout HTML");

    // Save theme + layout HTML on the user
    const updateRes = await fetch(`${API}/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        collection: "users",
        query: { username: sellerParam },
        updates: {
          customTheme: selectedTheme,
          layoutHTML: layoutHTML,
          layoutTheme: layoutName,
          themeUpdatedAt: new Date().toISOString()
        }
      })
    });

    if (updateRes.ok) {
      const successDiv = document.createElement("div");
      successDiv.className = "fixed inset-0 z-[60] flex items-center justify-center modal-backdrop";
      successDiv.innerHTML = `
        <div class="classic-card rounded-lg p-12 text-center max-w-lg mx-4 transform scale-0 transition-all duration-500 shadow-2xl">
          <div class="text-7xl mb-8">üéâ</div>
          <h3 class="text-4xl font-bold classic-header classic-text mb-6">Theme Applied Successfully!</h3>
          <p class="text-gray-600 mb-10 leading-relaxed text-lg">Your distinguished store has been transformed with this exquisite theme.</p>
          <div class="flex flex-col gap-5">
            <button onclick="this.parentElement.parentElement.parentElement.remove(); window.location.href='../shop?seller=${encodeURIComponent(sellerParam)}'" class="classic-gradient text-white px-10 py-5 rounded-lg font-bold text-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
              View Your Store
            </button>
            <button onclick="this.parentElement.parentElement.parentElement.remove(); window.location.href='../dashboard?seller=${encodeURIComponent(sellerParam)}'" class="classic-button px-10 py-5 rounded-lg font-bold text-lg transition-all duration-300">
              Return to Dashboard
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(successDiv);
      setTimeout(() => successDiv.firstElementChild.style.transform = "scale(1)", 100);
    } else {
      alert("Failed to apply theme. Please try again.");
    }
  } catch (err) {
    console.error("Error applying theme:", err);
    alert("Something went wrong. Please try again.");
  }
}

function showUpgradeModal() {
  const upgradeDiv = document.createElement("div");
  upgradeDiv.className = "fixed inset-0 z-[60] flex items-center justify-center modal-backdrop";
  upgradeDiv.innerHTML = `
    <div class="classic-card rounded-lg p-12 text-center max-w-lg mx-4 transform scale-0 transition-all duration-500 shadow-2xl">
      <div class="text-6xl mb-8">üîí</div>
      <h3 class="text-4xl font-bold classic-header classic-text mb-6">Upgrade Required</h3>
      <p class="text-gray-600 mb-10 leading-relaxed text-lg">Unlock premium themes and distinguished features to elevate your store's presence.</p>
      <div class="flex flex-col gap-5">
        <button onclick="window.open('../dashboard?seller=${encodeURIComponent(sellerParam)}', '_self')" class="classic-gradient text-white px-10 py-5 rounded-lg font-bold text-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
          Upgrade Now
        </button>
        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="classic-button px-10 py-5 rounded-lg font-bold text-lg transition-all duration-300">
          Continue Browsing
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(upgradeDiv);
  setTimeout(() => upgradeDiv.firstElementChild.style.transform = "scale(1)", 100);
}

function removeFilter(filterType) {
  currentFilters[filterType] = "all";
  updateFilterButtons();
  renderThemes();
}

function updateFilterButtons() {
  // Update tier filter buttons
  document.querySelectorAll(".tier-filter-btn").forEach(btn => {
    const isActive = btn.dataset.tier === currentFilters.tier;
    btn.className = `tier-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold transition-all duration-300 ${
      isActive ? 'active' : ''
    }`;
  });

  // Update feature filter buttons
  document.querySelectorAll(".feature-filter-btn").forEach(btn => {
    const isActive = btn.dataset.feature === currentFilters.feature;
    btn.className = `feature-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold transition-all duration-300 ${
      isActive ? 'active' : ''
    }`;
  });

  // Update best for filter buttons
  document.querySelectorAll(".bestfor-filter-btn").forEach(btn => {
    const isActive = btn.dataset.bestfor === currentFilters.bestfor;
    btn.className = `bestfor-filter-btn filter-chip px-6 py-3 rounded-lg font-semibold transition-all duration-300 ${
      isActive ? 'active' : ''
    }`;
  });
}

// Enhanced Filter functionality
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("viewThemeBtn")) {
    const index = e.target.dataset.index;
    openModal(index);
  }
  
  if (e.target.classList.contains("tier-filter-btn")) {
    currentFilters.tier = e.target.dataset.tier;
    updateFilterButtons();
    renderThemes();
  }

  if (e.target.classList.contains("feature-filter-btn")) {
    currentFilters.feature = e.target.dataset.feature;
    updateFilterButtons();
    renderThemes();
  }

  if (e.target.classList.contains("bestfor-filter-btn")) {
    currentFilters.bestfor = e.target.dataset.bestfor;
    updateFilterButtons();
    renderThemes();
  }
});

// Clear filters functionality
document.getElementById("clearFilters").addEventListener("click", () => {
  currentFilters = { tier: "all", feature: "all", bestfor: "all" };
  updateFilterButtons();
  renderThemes();
});

document.getElementById("resetFilters").addEventListener("click", () => {
  currentFilters = { tier: "all", feature: "all", bestfor: "all" };
  updateFilterButtons();
  renderThemes();
});

// Close modal on backdrop click
document.getElementById("themeModal").addEventListener("click", (e) => {
  if (e.target === e.currentTarget) {
    closeModal();
  }
});

// Close modal on escape key
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !themeModal.classList.contains("hidden")) {
    closeModal();
  }
});

// Initialize the application
(async function init() {
  await getUserPlan();
  updateFilterButtons();
  renderThemes();
})();
</script>

</body>
</html>