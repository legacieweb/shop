<!-- Nature Inspired Layout -->
<div id="layoutDefault" class="flex-grow flex flex-col bg-emerald-50">
  <!-- Header -->
  <header id="headerSection" class="bg-gradient-to-r from-emerald-100 to-green-100 shadow-lg sticky top-0 z-40 border-b-4 border-emerald-800">
    <div class="max-w-7xl mx-auto px-4 py-6 flex items-center justify-between border-2 border-transparent" id="boxHeader">
      <div class="flex items-center gap-4">
        <img id="shopLogo" src="https://placehold.co/50x50" class="w-12 h-12 rounded-full object-cover border-4 border-emerald-800 shadow-lg" />
        <span id="shopTitle" class="text-2xl font-bold text-emerald-900 border-2 border-transparent nature-font">loading...</span>
      </div>
      
      <!-- Desktop Auth Buttons -->
      <div class="hidden md:flex items-center gap-4">
        <div id="shopAuthButtons" class="flex items-center gap-2 text-sm"></div>
      </div>
      
      <!-- Mobile Hamburger Menu -->
      <div class="md:hidden">
        <button id="mobileMenuBtn" class="p-2 rounded-lg bg-emerald-800 text-white hover:bg-emerald-900 transition-all duration-300">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Mobile Dropdown Menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-emerald-100 border-t-2 border-emerald-800 px-4 py-4">
      <div id="mobileAuthButtons" class="flex flex-col gap-2 text-sm mb-4"></div>
      <div id="mobileCustomizeBtn" class="hidden"></div>
    </div>
  </header>

  <!-- Main Hero Section -->
  <section id="heroSection" class="relative py-24 text-center text-white border-2 border-transparent nature-hero">
    <div id="heroOverlay" class="absolute inset-0 bg-gradient-to-b from-emerald-900/40 via-green-900/30 to-emerald-800/40 z-0"></div>
    <img id="heroImage" class="absolute inset-0 w-full h-full object-cover z-[-1] border-2 border-transparent nature-filter" />
    <div class="relative z-10 max-w-4xl mx-auto px-4">
      <h1 id="shopName" class="text-4xl md:text-6xl font-extrabold mb-4 border-2 border-transparent nature-title text-shadow-nature">Loading Store...</h1>
      <p id="shopBio" class="text-lg md:text-xl border-2 border-transparent nature-subtitle mb-6">Please wait while we load the store.</p>
      <div class="nature-leaf-ornament mx-auto mb-4"></div>
      <button id="uploadHeroBtn" class="hidden mt-6 inline-block bg-emerald-800 hover:bg-emerald-900 text-white font-bold px-8 py-3 rounded-lg shadow-lg transition-all duration-300 nature-button">
        Upload Hero Image
      </button>
    </div>
  </section>

  <!-- Dynamic Category Sections Container -->
  <div id="categorySectionsContainer">
    <!-- Categories will be dynamically generated here -->
  </div>

  <!-- Product Not Found -->
  <section id="productNotFound" class="max-w-2xl mx-auto px-6 py-20 text-center hidden">
    <h2 class="text-4xl font-bold text-emerald-800 mb-6 nature-font">No Eco Products Available</h2>
    <p class="text-emerald-700 mb-6 text-lg">This sustainable shop hasn't added any eco-friendly products yet. Check back later for amazing green finds!</p>
    <a href="index.html" class="inline-block bg-emerald-800 hover:bg-emerald-900 text-white px-8 py-4 rounded-lg transition-all duration-300 nature-button font-bold">← Back to Marketplace</a>
  </section>

  <!-- Footer -->
  <footer id="footer" class="bg-gradient-to-r from-emerald-100 to-green-100 border-t-4 border-emerald-800 py-8 text-center mt-auto">
    <div class="nature-leaf-ornament-footer mx-auto mb-4"></div>
    <span id="footerText" class="border-2 border-transparent text-emerald-900 font-semibold text-lg nature-font">
      © <span id="year"></span> Green Living Store. Sustainably made.
    </span>
    <div class="mt-4 text-sm">
      <a href="https://iyonicorp.com"
         target="_blank"
         rel="noopener noreferrer"
         class="nature-glow-text">
        Sustainably crafted by iyonicorp
      </a>
    </div>
  </footer>
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Merriweather:wght@300;400;700&display=swap');
  
  .nature-font {
    font-family: 'Poppins', sans-serif;
  }
  
  .nature-title {
    font-family: 'Poppins', sans-serif;
    font-weight: 800;
    letter-spacing: 1px;
  }
  
  .nature-subtitle {
    font-family: 'Merriweather', serif;
    font-weight: 300;
    font-style: italic;
  }
  
  .nature-category-title {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }
  
  .nature-category-subtitle {
    font-family: 'Merriweather', serif;
    font-style: italic;
  }
  
  .text-shadow-nature {
    text-shadow: 3px 3px 6px rgba(0,0,0,0.7), 1px 1px 2px rgba(0,0,0,0.5);
  }
  
  .nature-filter {
    filter: hue-rotate(60deg) saturate(1.3) brightness(0.9);
  }
  
  .nature-leaf-ornament {
    width: 120px;
    height: 30px;
    background: linear-gradient(90deg, transparent, #059669, #047857, #059669, transparent);
    position: relative;
    border-radius: 15px;
  }
  
  .nature-leaf-ornament::before,
  .nature-leaf-ornament::after {
    content: '';
    position: absolute;
    top: -5px;
    width: 20px;
    height: 20px;
    background: #059669;
    border-radius: 50% 0;
  }
  
  .nature-leaf-ornament::before {
    left: -25px;
    transform: rotate(-45deg);
  }
  
  .nature-leaf-ornament::after {
    right: -25px;
    transform: rotate(135deg);
  }
  
  .nature-divider {
    width: 150px;
    height: 3px;
    background: linear-gradient(90deg, transparent, #10b981, #059669, #10b981, transparent);
    position: relative;
    border-radius: 2px;
  }
  
  .nature-divider::before,
  .nature-divider::after {
    content: '';
    position: absolute;
    top: -8px;
    width: 15px;
    height: 15px;
    background: #10b981;
    border-radius: 50% 0;
  }
  
  .nature-divider::before {
    left: -20px;
    transform: rotate(-45deg);
  }
  
  .nature-divider::after {
    right: -20px;
    transform: rotate(135deg);
  }
  
  .nature-leaf-ornament-footer {
    width: 200px;
    height: 35px;
    background: linear-gradient(90deg, transparent, #059669, #047857, #059669, transparent);
    position: relative;
    border-radius: 18px;
  }
  
  .nature-leaf-ornament-footer::before,
  .nature-leaf-ornament-footer::after {
    content: '';
    position: absolute;
    top: -8px;
    width: 25px;
    height: 25px;
    background: #059669;
    border-radius: 50% 0;
  }
  
  .nature-leaf-ornament-footer::before {
    left: -35px;
    transform: rotate(-45deg);
  }
  
  .nature-leaf-ornament-footer::after {
    right: -35px;
    transform: rotate(135deg);
  }
  
  .nature-pattern {
    background-image: 
      radial-gradient(circle at 25% 25%, #10b981 2px, transparent 2px),
      radial-gradient(circle at 75% 75%, #059669 2px, transparent 2px);
    background-size: 60px 60px;
    background-position: 0 0, 30px 30px;
  }
  
  .nature-button {
    position: relative;
    overflow: hidden;
    font-family: 'Poppins', sans-serif;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
    border-radius: 12px;
  }
  
  .nature-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  .nature-button:hover::before {
    left: 100%;
  }
  
  .nature-glow-text {
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    color: #059669;
    text-decoration: none;
    transition: all 0.3s ease;
    text-shadow: 0 0 5px rgba(5, 150, 105, 0.3);
  }
  
  .nature-glow-text:hover {
    color: #047857;
    text-shadow: 0 0 10px rgba(5, 150, 105, 0.6), 0 0 20px rgba(5, 150, 105, 0.4);
    text-decoration: underline;
  }
  
  .nature-category-hero {
    position: relative;
    overflow: hidden;
    border-radius: 0 0 50px 50px;
  }
  
  .nature-category-hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
      linear-gradient(45deg, transparent 30%, rgba(16, 185, 129, 0.1) 50%, transparent 70%),
      linear-gradient(-45deg, transparent 30%, rgba(5, 150, 105, 0.1) 50%, transparent 70%);
    z-index: 1;
  }
  
  /* Nature Product Cards */
  .nature-product-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
  }
  
  .nature-product-image-container {
    background: linear-gradient(145deg, #d1fae5, #a7f3d0, #ecfdf5);
    border: 3px solid #059669;
    border-radius: 50%;
    width: 240px;
    height: 240px;
    box-shadow: 
      0 10px 30px rgba(5, 150, 105, 0.25),
      inset 0 2px 0 rgba(255, 255, 255, 0.4),
      0 0 0 0 rgba(5, 150, 105, 0.3);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    animation: floatBubble 6s ease-in-out infinite;
  }
  
  .nature-product-image-container::before {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    background: linear-gradient(45deg, #059669, #10b981, #34d399, #6ee7b7, #10b981, #059669);
    background-size: 300% 300%;
    border-radius: 50%;
    z-index: -1;
    opacity: 0;
    transition: all 0.5s ease;
    animation: gradientShift 4s ease-in-out infinite;
  }
  
  .nature-product-image-container::after {
    content: '';
    position: absolute;
    top: 15%;
    left: 15%;
    width: 30px;
    height: 30px;
    background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.2) 50%, transparent 70%);
    border-radius: 50%;
    opacity: 0.7;
    animation: shimmer 3s ease-in-out infinite;
  }
  
  .nature-product-card:hover .nature-product-image-container::before {
    opacity: 1;
  }
  
  .nature-product-card:hover .nature-product-image-container {
    transform: translateY(-12px) scale(1.08) rotate(2deg);
    box-shadow: 
      0 20px 50px rgba(5, 150, 105, 0.4),
      inset 0 3px 0 rgba(255, 255, 255, 0.5),
      0 0 30px rgba(5, 150, 105, 0.3);
    animation: hoverPulse 0.6s ease-in-out;
  }
  
  .nature-product-card:hover {
    transform: translateY(-5px);
  }
  
  .nature-product-image {
    width: 100%;
    height: 100%;
    object-cover: cover;
    border-radius: 50%;
    filter: saturate(1.2) brightness(1.05);
    transition: filter 0.3s ease;
  }
  
  .nature-product-card:hover .nature-product-image {
    filter: saturate(1.4) brightness(1.15) hue-rotate(5deg);
  }
  
  .nature-product-info {
    text-align: center;
    max-width: 200px;
  }
  
  .nature-product-title {
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    color: #047857;
    text-shadow: 1px 1px 2px rgba(4, 120, 87, 0.1);
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }
  
  .nature-product-price {
    font-family: 'Merriweather', serif;
    font-weight: 700;
    color: #047857;
    font-size: 1.25rem;
  }
  
  .nature-view-btn {
    background: linear-gradient(145deg, #059669, #047857);
    border: 2px solid #047857;
    color: white;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(4, 120, 87, 0.3);
    position: absolute;
    bottom: 10px;
    right: 10px;
  }
  
  .nature-view-btn:hover {
    background: linear-gradient(145deg, #047857, #065f46);
    transform: scale(1.1) rotate(10deg);
    box-shadow: 0 6px 18px rgba(4, 120, 87, 0.4);
  }
  
  /* Pagination Styles */
  .nature-pagination-btn {
    background: linear-gradient(145deg, #059669, #047857);
    color: white;
    border: 2px solid #047857;
    padding: 12px 24px;
    border-radius: 12px;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(4, 120, 87, 0.3);
  }
  
  .nature-pagination-btn:hover:not(:disabled) {
    background: linear-gradient(145deg, #047857, #065f46);
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(4, 120, 87, 0.4);
  }
  
  .nature-pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  /* Sustainability Badge */
  .sustainability-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
    z-index: 10;
  }
  
  /* Carbon footprint indicator */
  .carbon-neutral {
    background: linear-gradient(135deg, #059669, #10b981);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
    margin-top: 0.5rem;
    display: inline-block;
  }
  
  /* Responsive Modal Styles */
  #customModal {
    max-height: 90vh;
    overflow-y: auto;
    width: min(480px, 90vw);
  }
  
  @media (max-width: 640px) {
    #customModal {
      top: 1rem;
      width: calc(100vw - 2rem);
      max-height: calc(100vh - 2rem);
      padding: 1.5rem;
    }
    
    .nature-product-image-container {
      width: 150px;
      height: 150px;
    }
    
    .nature-product-info {
      max-width: 150px;
    }
    
    .nature-product-title {
      font-size: 1rem;
    }
    
    .nature-product-price {
      font-size: 1.1rem;
    }
  }
</style>

<!-- Responsive Modal -->
<div id="customModal" class="hidden fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-gradient-to-br from-emerald-50 to-green-50 p-8 shadow-2xl rounded-3xl w-[480px] max-w-full space-y-6 border-4 border-emerald-800">
  <h3 class="text-2xl font-bold text-emerald-900 nature-font">Customize Your Green Shop</h3>
  <div class="space-y-4 max-h-60 overflow-y-auto" id="modalContent"></div>
  <div class="flex flex-col sm:flex-row justify-between gap-4 pt-6">
    <button id="cancelBtn" class="bg-emerald-200 hover:bg-emerald-300 text-emerald-900 px-6 py-3 rounded-lg font-semibold transition-all duration-300 w-full sm:w-1/2 nature-font">Cancel</button>
    <button id="applyBtn" class="bg-emerald-800 hover:bg-emerald-900 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 w-full sm:w-1/2 nature-font">Apply Changes</button>
  </div>
</div>

<!-- Script -->
<script>
(async function () {
  const { sellerParam, isOwner, API, theme } = window.__SHOP_DATA__ || {};
  const set = (id, fn) => { const el = document.getElementById(id); if (el) fn(el); };

  // Fix year display
  const yearSpan = document.getElementById("year");
  if (yearSpan) yearSpan.textContent = new Date().getFullYear();

  // Mobile menu functionality
  const mobileMenuBtn = document.getElementById("mobileMenuBtn");
  const mobileMenu = document.getElementById("mobileMenu");
  
  if (mobileMenuBtn && mobileMenu) {
    mobileMenuBtn.addEventListener("click", () => {
      mobileMenu.classList.toggle("hidden");
    });
  }

  const resolveImage = (img) => {
    if (!img || typeof img !== 'string') return '';
    let val = img.trim().replace(/\\\\/g, '/').replace(/\\/g, '/');
    // Absolute URLs or data URIs
    if (/^(https?:)?\/\//i.test(val) || val.startsWith('data:')) return val;
    // Strip any leading host part accidentally embedded
    const uploadsIdx = val.toLowerCase().lastIndexOf('/uploads/');
    const uploadsIdx2 = uploadsIdx === -1 ? val.toLowerCase().lastIndexOf('uploads/') : uploadsIdx;
    if (uploadsIdx2 !== -1) {
      const clean = val.slice(uploadsIdx2 + (val.toLowerCase().startsWith('/uploads/') ? 9 : (val.toLowerCase().indexOf('uploads/') >= 0 ? val.toLowerCase().indexOf('uploads/') + 8 : 0)));
      return `${API}/uploads/${clean.replace(/^\/+/, '')}`;
    }
    // Starts with uploads path (with or without slash)
    if (/^\/?uploads\//i.test(val)) {
      const clean = val.replace(/^\/?uploads\//i, '');
      return `${API}/uploads/${clean}`;
    }
    // Raw filename
    return `${API}/uploads/${val.replace(/^\/+/, '')}`;
  };

  // Helper: currency symbol map
  function getCurrencySymbol(code) {
    const symbols = {
      USD: "$", EUR: "€", GBP: "£", NGN: "₦", INR: "₹", KES: "KSh", ZAR: "R"
    };
    return symbols[code] || code;
  }

  // Apply theme to DOM
  set("shopLogo", el => {
    el.src = resolveImage(theme.logo);
    el.onerror = () => el.src = "https://placehold.co/50x50?text=S";
  });

  set("shopTitle", el => {
    el.textContent = theme.title || sellerParam;
    el.style.color = theme.titleColor || "";
  });

  set("shopName", el => {
    el.textContent = theme.name || "";
    el.style.color = theme.nameColor || "";
  });

  set("shopBio", el => {
    el.textContent = theme.bio || "";
    el.style.color = theme.bioColor || "";
  });

  set("heroImage", el => {
    el.src = resolveImage(theme.heroImage);
  });

  set("headerSection", el => {
    el.style.backgroundColor = theme.headerBg || "";
  });

  set("footer", el => {
    el.style.backgroundColor = theme.footerBg || "";
  });

  set("footerText", el => {
    el.textContent = theme.footerText || `© ${new Date().getFullYear()} Green Living Store. Sustainably made.`;
    el.style.color = theme.footerColor || "";
  });

  // 🔄 Fetch products and seller
  const res = await fetch(`${API}/find?collection=products&seller=${encodeURIComponent(sellerParam)}`);
  const products = await res.json();

  const sellerRes = await fetch(`${API}/find?collection=users&username=${encodeURIComponent(sellerParam)}`);
  const [seller] = await sellerRes.json();
  const shopSettings = seller?.shopSettings || {};
  const storeCurrency = shopSettings?.storeCurrency || "USD";

  // Get category heroes from theme or create defaults
  const categoryHeroes = theme.categoryHeroes || {};
  
  // Group products by category
  const productsByCategory = {};
  products.forEach(product => {
    const category = product.category || 'Uncategorized';
    if (!productsByCategory[category]) {
      productsByCategory[category] = [];
    }
    productsByCategory[category].push(product);
  });

  const categories = Object.keys(productsByCategory);
  const container = document.getElementById("categorySectionsContainer");
  const notFound = document.getElementById("productNotFound");

  // Clear container
  container.innerHTML = "";

  if (categories.length > 0 && products.length > 0) {
    notFound?.classList.add("hidden");

    // Create sections for each category
    categories.forEach((category, index) => {
      const categoryProducts = productsByCategory[category];
      const categoryId = `category_${category.replace(/\s+/g, '_').toLowerCase()}`;
      
      // Get category hero data
      const categoryHero = categoryHeroes[category] || {
        title: category,
        subtitle: `Sustainable ${category.toLowerCase()} for a greener future`,
        backgroundImage: '',
        backgroundColor: `hsl(${120 + index * 15}, 70%, 45%)`
      };

      // Create category hero section
      const heroSection = document.createElement("section");
      heroSection.id = `categoryHero_${categoryId}`;
      heroSection.className = "relative py-16 text-center text-white nature-category-hero border-2 border-transparent";
      heroSection.style.backgroundColor = categoryHero.backgroundColor || `hsl(${120 + index * 15}, 70%, 45%)`;
      
      if (categoryHero.backgroundImage) {
        heroSection.style.backgroundImage = `url(${resolveImage(categoryHero.backgroundImage)})`;
        heroSection.style.backgroundSize = 'cover';
        heroSection.style.backgroundPosition = 'center';
      }

      heroSection.innerHTML = `
        <div class="absolute inset-0 bg-gradient-to-r from-emerald-800/60 to-green-800/60 z-0"></div>
        <div class="absolute inset-0 nature-pattern opacity-20"></div>
        <img class="category-hero-bg-image absolute inset-0 w-full h-full object-cover z-[-1] nature-filter ${categoryHero.backgroundImage ? '' : 'hidden'}" src="${resolveImage(categoryHero.backgroundImage)}" />
        <div class="relative z-10 max-w-4xl mx-auto px-4">
          <h2 class="category-hero-title text-4xl font-bold mb-4 nature-category-title border-2 border-transparent">
            ${categoryHero.title}
          </h2>
          <p class="category-hero-subtitle text-lg nature-category-subtitle border-2 border-transparent">${categoryHero.subtitle}</p>
          <div class="nature-divider mx-auto mt-4"></div>
          <div class="mt-4 text-sm opacity-90">
            Eco-friendly • Sustainable • Carbon Neutral
          </div>
          <button class="upload-category-hero-btn hidden mt-6 inline-block bg-emerald-800 hover:bg-emerald-900 text-white font-bold px-6 py-2 rounded-lg shadow-lg transition-all duration-300 nature-button">
            Upload Background Image
          </button>
        </div>
      `;

      container.appendChild(heroSection);

      // Create product grid section
      const gridSection = document.createElement("main");
      gridSection.className = "max-w-7xl mx-auto px-4 py-8";
      
      const gridContainer = document.createElement("div");
      gridContainer.id = `productGrid_${categoryId}`;
      gridContainer.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 min-h-[300px]";
      
      // Pagination state
      const productsPerPage = 10;
      let currentPage = 1;
      const totalPages = Math.ceil(categoryProducts.length / productsPerPage);

      function renderProducts(page = 1) {
        gridContainer.innerHTML = "";
        const startIndex = (page - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const pageProducts = categoryProducts.slice(startIndex, endIndex);

        pageProducts.forEach((p, productIndex) => {
          const imageSrc = resolveImage(p.image);
          const card = document.createElement("a");
          card.href = `../detail?id=${p.id}`;
          card.className = "nature-product-card";

          // Add sustainability badges randomly for demo
          const sustainabilityFeatures = ['Organic', 'Fair Trade', 'Carbon Neutral', 'Recyclable', 'Biodegradable'];
          const randomFeature = sustainabilityFeatures[productIndex % sustainabilityFeatures.length];

          card.innerHTML = `
            <div class="nature-product-image-container">
              <div class="sustainability-badge">
                ${randomFeature}
              </div>
              ${p.image ? `
                <img src="${imageSrc}" alt="${p.name}" class="nature-product-image" />
              ` : `
                <div class="nature-product-image bg-gradient-to-br from-emerald-200 to-green-200 flex items-center justify-center text-4xl text-emerald-800">
                  S
                </div>
              `}
              <button
                class="nature-view-btn"
                aria-label="View ${p.name}"
                title="View ${p.name}"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
            </div>
            <div class="nature-product-info">
              <h4 class="nature-product-title truncate" title="${p.name}">
                ${p.name}
              </h4>
              <div class="flex flex-col items-center">
                <p class="nature-product-price">${getCurrencySymbol(storeCurrency)}${p.price.toFixed(2)}</p>
                <span class="carbon-neutral">Carbon Neutral</span>
              </div>
            </div>
          `;

          gridContainer.appendChild(card);
        });
      }

      // Create pagination if needed
      if (totalPages > 1) {
        const paginationContainer = document.createElement("div");
        paginationContainer.className = "flex justify-center items-center gap-4 mt-8";
        
        function updatePagination() {
          paginationContainer.innerHTML = `
            <button class="nature-pagination-btn ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                    ${currentPage === 1 ? 'disabled' : ''}
                    onclick="changePage(${currentPage - 1})">
              Previous
            </button>
            <span class="text-emerald-800 font-semibold nature-font">
              Page ${currentPage} of ${totalPages}
            </span>
            <button class="nature-pagination-btn ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                    ${currentPage === totalPages ? 'disabled' : ''}
                    onclick="changePage(${currentPage + 1})">
              Next
            </button>
          `;
        }

        window[`changePage_${categoryId}`] = function(page) {
          if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderProducts(currentPage);
            updatePagination();
          }
        };

        // Make changePage function available globally for this category
        const changePageScript = document.createElement("script");
        changePageScript.textContent = `
          function changePage(page) {
            window['changePage_${categoryId}'](page);
          }
        `;
        paginationContainer.appendChild(changePageScript);

        gridSection.appendChild(gridContainer);
        gridSection.appendChild(paginationContainer);
        updatePagination();
      } else {
        gridSection.appendChild(gridContainer);
      }

      container.appendChild(gridSection);
      renderProducts(1);
    });

  } else {
    notFound?.classList.remove("hidden");
  }

  // Customization tools (nature-themed styling)
  if (!isOwner) return;

  const btn = document.createElement("button");
  btn.textContent = "Customize Green Shop";
  btn.className = "fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-emerald-800 hover:bg-emerald-900 text-white px-8 py-3 rounded-full shadow-lg transition-all duration-300 nature-font font-bold";
  btn.id = "customizeBtn";
  document.body.appendChild(btn);

  // Add customize button to mobile menu when owner
  const mobileCustomizeContainer = document.getElementById("mobileCustomizeBtn");
  if (mobileCustomizeContainer) {
    const mobileCustomizeBtn = document.createElement("button");
    mobileCustomizeBtn.textContent = "Customize Green Shop";
    mobileCustomizeBtn.className = "w-full bg-emerald-800 hover:bg-emerald-900 text-white px-4 py-2 rounded-lg transition-all duration-300 nature-font font-semibold";
    mobileCustomizeBtn.id = "mobileCustomizeBtnEl";
    mobileCustomizeContainer.appendChild(mobileCustomizeBtn);
    mobileCustomizeContainer.classList.remove("hidden");
    
    // Sync both buttons
    const syncCustomizeButtons = () => {
      const isCustomizing = btn.textContent.includes("Close");
      btn.textContent = isCustomizing ? "Close Customization" : "Customize Green Shop";
      mobileCustomizeBtn.textContent = isCustomizing ? "Close Customization" : "Customize Green Shop";
    };
    
    mobileCustomizeBtn.addEventListener("click", () => {
      btn.click();
      syncCustomizeButtons();
      mobileMenu.classList.add("hidden"); // Close mobile menu after clicking
    });
  }

  const customizableElements = {
    "shopLogo": { label: "Shop Logo (100×100px)", type: "image" },
    "shopTitle": { label: "Store Title", type: "text-edit", key: "title" },
    "boxHeader": { label: "Header Background", type: "background", key: "headerBg" },
    "heroImage": { label: "Hero Banner Image", type: "image" },
    "shopName": { label: "Hero Title", type: "text-edit", key: "name" },
    "shopBio": { label: "Hero Bio", type: "text-edit", key: "bio" },
    "footer": { label: "Footer Background", type: "background", key: "footerBg" },
    "footerText": { label: "Footer Text", type: "text-edit", key: "footerText", colorKey: "footerColor" }
  };

  let isCustomizing = false;
  btn.addEventListener("click", () => {
    isCustomizing = !isCustomizing;
    btn.textContent = isCustomizing ? "Close Customization" : "Customize Green Shop";
    
    // Update mobile button if it exists
    const mobileCustomizeBtn = document.getElementById("mobileCustomizeBtnEl");
    if (mobileCustomizeBtn) {
      mobileCustomizeBtn.textContent = isCustomizing ? "Close Customization" : "Customize Green Shop";
    }
    
    document.getElementById("uploadHeroBtn")?.classList.toggle("hidden", !isCustomizing);
    
    if (isCustomizing) {
      // Add customization to main elements
      Object.keys(customizableElements).forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.dataset.bound) {
          el.dataset.bound = "true";
          el.classList.add("cursor-pointer", "border-4", "border-emerald-600", "border-dashed");
          el.addEventListener("click", openModal);
        }
      });
      
      // Add customization to category heroes
      document.querySelectorAll('.nature-category-hero').forEach(heroEl => {
        if (!heroEl.dataset.bound) {
          heroEl.dataset.bound = "true";
          heroEl.classList.add("cursor-pointer", "border-4", "border-emerald-600", "border-dashed");
          heroEl.addEventListener("click", openCategoryModal);
          
          // Show upload buttons for category heroes
          const uploadBtn = heroEl.querySelector('.upload-category-hero-btn');
          if (uploadBtn) {
            uploadBtn.classList.remove('hidden');
            uploadBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              openCategoryModal({ currentTarget: heroEl, stopPropagation: () => {} });
            });
          }
        }
      });
    } else {
      removeHighlights();
    }
  });

  document.getElementById("uploadHeroBtn")?.addEventListener("click", () => {
    if (!isCustomizing) return;
    openModal({ currentTarget: { id: "heroImage" }, stopPropagation: () => {} });
  });

  function openModal(e) {
    e.stopPropagation();
    const id = e.currentTarget.id;
    const config = customizableElements[id];
    if (!config) return;

    const modal = document.getElementById("customModal");
    const content = document.getElementById("modalContent");
    modal.classList.remove("hidden");
    content.innerHTML = `<label class="text-lg font-semibold block mb-2 text-emerald-900 nature-font">${config.label}</label>`;

    if (config.type === "image") {
      content.innerHTML += `
        <input type="text" id="customInputURL" placeholder="Image URL or filename" class="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg mb-3 focus:border-emerald-600 focus:outline-none" />
        <input type="file" id="customInputFile" accept="image/*" class="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg focus:border-emerald-600 focus:outline-none" />
        <div id="uploadProgress" class="hidden mt-2">
          <div class="bg-emerald-200 rounded-full h-2">
            <div id="progressBar" class="bg-emerald-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <p class="text-sm text-emerald-700 mt-1">Uploading...</p>
        </div>
      `;
    } else if (config.type === "text-edit") {
      const el = document.getElementById(id);
      content.innerHTML += `
        <input type="text" id="customTextValue" value="${el.textContent}" class="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg mb-3 focus:border-emerald-600 focus:outline-none" />
        <input type="color" id="customInputColor" class="w-full h-12 border-2 border-emerald-300 rounded-lg focus:border-emerald-600 focus:outline-none" />
      `;
    } else if (config.type === "background") {
      content.innerHTML += `<input type="color" id="customInputBg" class="w-full h-12 border-2 border-emerald-300 rounded-lg focus:border-emerald-600 focus:outline-none" />`;
    }

    document.getElementById("applyBtn").onclick = () => applyChange(id, config);
    document.getElementById("cancelBtn").onclick = () => modal.classList.add("hidden");
  }

  function openCategoryModal(e) {
    e.stopPropagation();
    const heroEl = e.currentTarget;
    const categoryId = heroEl.id.replace('categoryHero_', '');
    const titleEl = heroEl.querySelector('.category-hero-title');
    const subtitleEl = heroEl.querySelector('.category-hero-subtitle');
    const bgImageEl = heroEl.querySelector('.category-hero-bg-image');
    
    // Extract category name from the ID
    const categoryName = categoryId.replace('category_', '').replace(/_/g, ' ');
    const currentCategoryHero = categoryHeroes[categoryName] || {};

    const modal = document.getElementById("customModal");
    const content = document.getElementById("modalContent");
    modal.classList.remove("hidden");
    content.innerHTML = `
      <label class="text-lg font-semibold block mb-2 text-emerald-900 nature-font">Customize Category: ${categoryName}</label>
      
      <div class="space-y-4">
        <div>
          <label class="text-sm font-semibold block mb-1 text-emerald-800">Category Title</label>
          <input type="text" id="categoryTitle" value="${titleEl.textContent.trim()}" class="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg focus:border-emerald-600 focus:outline-none" />
        </div>
        
        <div>
          <label class="text-sm font-semibold block mb-1 text-emerald-800">Category Subtitle</label>
          <input type="text" id="categorySubtitle" value="${subtitleEl.textContent}" class="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg focus:border-emerald-600 focus:outline-none" />
        </div>
        
        <div>
          <label class="text-sm font-semibold block mb-1 text-emerald-800">Background Image</label>
          <input type="text" id="categoryBgURL" placeholder="Image URL or filename" class="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg mb-3 focus:border-emerald-600 focus:outline-none" />
          <input type="file" id="categoryBgFile" accept="image/*" class="w-full px-4 py-3 border-2 border-emerald-300 rounded-lg focus:border-emerald-600 focus:outline-none" />
          <div id="categoryUploadProgress" class="hidden mt-2">
            <div class="bg-emerald-200 rounded-full h-2">
              <div id="categoryProgressBar" class="bg-emerald-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p class="text-sm text-emerald-700 mt-1">Uploading...</p>
          </div>
        </div>
        
        <div>
          <label class="text-sm font-semibold block mb-1 text-emerald-800">Background Color</label>
          <input type="color" id="categoryBgColor" value="${currentCategoryHero.backgroundColor || '#059669'}" class="w-full h-12 border-2 border-emerald-300 rounded-lg focus:border-emerald-600 focus:outline-none" />
        </div>
      </div>
    `;

    document.getElementById("applyBtn").onclick = () => applyCategoryChange(categoryName, heroEl);
    document.getElementById("cancelBtn").onclick = () => modal.classList.add("hidden");
  }

  async function applyCategoryChange(categoryName, heroEl) {
    const title = document.getElementById("categoryTitle").value;
    const subtitle = document.getElementById("categorySubtitle").value;
    const bgUrl = document.getElementById("categoryBgURL").value.trim();
    const bgColor = document.getElementById("categoryBgColor").value;
    const fileInput = document.getElementById("categoryBgFile");
    
    let backgroundImage = bgUrl;
    
    // Show progress bar
    const progressDiv = document.getElementById("categoryUploadProgress");
    const progressBar = document.getElementById("categoryProgressBar");
    
    if (!bgUrl && fileInput?.files?.[0]) {
      const file = fileInput.files[0];
      
      // Show upload progress
      if (progressDiv) {
        progressDiv.classList.remove("hidden");
        progressBar.style.width = "10%";
      }

      try {
        // Use the new server endpoint for category hero uploads
        const formData = new FormData();
        formData.append("categoryImage", file);
        formData.append("username", sellerParam);
        formData.append("categoryName", categoryName);

        progressBar.style.width = "50%";

        const uploadResponse = await fetch(`${API}/upload-category-hero`, {
          method: "POST",
          body: formData
        });

        progressBar.style.width = "80%";

        if (!uploadResponse.ok) {
          throw new Error("Upload failed");
        }

        const uploadResult = await uploadResponse.json();
        backgroundImage = uploadResult.imageUrl;
        
        progressBar.style.width = "100%";
        setTimeout(() => {
          if (progressDiv) progressDiv.classList.add("hidden");
        }, 1000);

      } catch (error) {
        console.error("Category upload error:", error);
        if (progressDiv) progressDiv.classList.add("hidden");
        alert("Upload failed. Please try again.");
        return;
      }
    }

    // Update the category hero data
    if (!theme.categoryHeroes) theme.categoryHeroes = {};
    theme.categoryHeroes[categoryName] = {
      title,
      subtitle,
      backgroundImage,
      backgroundColor: bgColor
    };

    // Update the DOM elements
    const titleEl = heroEl.querySelector('.category-hero-title');
    const subtitleEl = heroEl.querySelector('.category-hero-subtitle');
    const bgImageEl = heroEl.querySelector('.category-hero-bg-image');
    
    if (titleEl) titleEl.textContent = title;
    if (subtitleEl) subtitleEl.textContent = subtitle;
    
    heroEl.style.backgroundColor = bgColor;
    
    if (backgroundImage) {
      heroEl.style.backgroundImage = `url(${resolveImage(backgroundImage)})`;
      heroEl.style.backgroundSize = 'cover';
      heroEl.style.backgroundPosition = 'center';
      if (bgImageEl) {
        bgImageEl.src = resolveImage(backgroundImage);
        bgImageEl.classList.remove('hidden');
      }
    } else {
      heroEl.style.backgroundImage = '';
      if (bgImageEl) {
        bgImageEl.classList.add('hidden');
      }
    }

    // Save to backend only if not using server upload (server already saved it)
    if (bgUrl || !fileInput?.files?.[0]) {
      await fetch(`${API}/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          collection: "users",
          query: { username: sellerParam },
          updates: { customTheme: theme }
        })
      });
    }

    document.getElementById("customModal").classList.add("hidden");
  }

  async function applyChange(id, config) {
    const el = document.getElementById(id);
    if (!el) return;

    if (config.type === "image") {
      const url = document.getElementById("customInputURL").value.trim();
      const fileInput = document.getElementById("customInputFile");
      let image = url;

      // Show progress bar
      const progressDiv = document.getElementById("uploadProgress");
      const progressBar = document.getElementById("progressBar");
      
      if (!url && fileInput?.files?.[0]) {
        const file = fileInput.files[0];
        
        // Show upload progress
        if (progressDiv) {
          progressDiv.classList.remove("hidden");
          progressBar.style.width = "10%";
        }

        try {
          // Use the new server endpoint for hero image uploads
          if (id === "heroImage") {
            const formData = new FormData();
            formData.append("heroImage", file);
            formData.append("username", sellerParam);
            formData.append("imageType", "heroImage");

            progressBar.style.width = "50%";

            const uploadResponse = await fetch(`${API}/upload-hero-image`, {
              method: "POST",
              body: formData
            });

            progressBar.style.width = "80%";

            if (!uploadResponse.ok) {
              throw new Error("Upload failed");
            }

            const uploadResult = await uploadResponse.json();
            image = uploadResult.imageUrl;
            
            progressBar.style.width = "100%";
            setTimeout(() => {
              if (progressDiv) progressDiv.classList.add("hidden");
            }, 1000);

          } else {
            // For other images, use base64 encoding
            image = await new Promise(res => {
              const reader = new FileReader();
              reader.onloadend = () => res(reader.result);
              reader.readAsDataURL(file);
            });
          }
        } catch (error) {
          console.error("Upload error:", error);
          if (progressDiv) progressDiv.classList.add("hidden");
          alert("Upload failed. Please try again.");
          return;
        }
      }

      const stored = image;
      el.src = resolveImage(stored);

      if (id === "shopLogo") theme.logo = stored;
      if (id === "heroImage") theme.heroImage = stored;

    } else if (config.type === "text-edit") {
      const color = document.getElementById("customInputColor").value;
      const text = document.getElementById("customTextValue").value;
      el.textContent = text;
      el.style.color = color;
      theme[config.key] = text;
      theme[config.colorKey || `${config.key}Color`] = color;

    } else if (config.type === "background") {
      const bg = document.getElementById("customInputBg").value;
      el.style.backgroundColor = bg;
      theme[config.key] = bg;
    }

    // Only update theme if it's not a hero image (already updated by server)
    if (id !== "heroImage") {
      await fetch(`${API}/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          collection: "users",
          query: { username: sellerParam },
          updates: { customTheme: theme }
        })
      });
    }

    document.getElementById("customModal").classList.add("hidden");
  }

  function removeHighlights() {
    Object.keys(customizableElements).forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.classList.remove("cursor-pointer", "border-4", "border-emerald-600", "border-dashed");
        el.removeEventListener("click", openModal);
        el.removeAttribute("data-bound");
      }
    });
    
    // Remove highlights from category heroes
    document.querySelectorAll('.nature-category-hero').forEach(heroEl => {
      heroEl.classList.remove("cursor-pointer", "border-4", "border-emerald-600", "border-dashed");
      heroEl.removeEventListener("click", openCategoryModal);
      heroEl.removeAttribute("data-bound");
      
      // Hide upload buttons for category heroes
      const uploadBtn = heroEl.querySelector('.upload-category-hero-btn');
      if (uploadBtn) {
        uploadBtn.classList.add('hidden');
      }
    });
    
    document.getElementById("uploadHeroBtn")?.classList.add("hidden");
  }
})();

// Auth Buttons: login/signup vs dashboard/logout
(function renderAuthButtons() {
  const user = JSON.parse(localStorage.getItem("user"));
  const desktopContainer = document.getElementById("shopAuthButtons");
  const mobileContainer = document.getElementById("mobileAuthButtons");
  
  if (!desktopContainer || !mobileContainer) return;

  desktopContainer.innerHTML = "";
  mobileContainer.innerHTML = "";

  // Get the real seller (not the preview one)
  const actualSeller =
    (window.__SHOP_DATA__ && window.__SHOP_DATA__.actualSeller) ||
    new URLSearchParams(window.location.search).get("seller");

  function createAuthButtons(container, isMobile = false) {
    const buttonClass = isMobile 
      ? "w-full px-4 py-2 rounded-lg transition-all duration-300 nature-font font-semibold text-center"
      : "px-4 py-2 rounded-lg transition-all duration-300 nature-font font-semibold";

    if (user) {
      const dashboard = document.createElement("a");
      const actualSeller = window.__SHOP_DATA__?.actualSeller || user.username;

      if (user.role && user.role.startsWith("seller")) {
        dashboard.href = `../dashboard?seller=${encodeURIComponent(actualSeller)}`;
      } else {
        dashboard.href = `../buyer?seller=${encodeURIComponent(actualSeller)}`;
      }
      dashboard.className = `${buttonClass} bg-emerald-800 hover:bg-emerald-900 text-white`;
      dashboard.textContent = "Dashboard";

      const logout = document.createElement("button");
      logout.className = `${buttonClass} border-2 border-emerald-800 text-emerald-800 hover:bg-emerald-100`;
      logout.textContent = "Logout";
      logout.onclick = () => {
        localStorage.removeItem("user");
        location.reload();
      };

      container.appendChild(dashboard);
      container.appendChild(logout);
    } else {
      const signup = document.createElement("a");
      signup.href = actualSeller ? `../signup?seller=${actualSeller}` : "../signup";
      signup.className = `${buttonClass} bg-emerald-800 hover:bg-emerald-900 text-white`;
      signup.textContent = "Sign Up";

      const login = document.createElement("a");
      login.href = actualSeller ? `../login?seller=${actualSeller}` : "../login";
      login.className = `${buttonClass} border-2 border-emerald-800 text-emerald-800 hover:bg-emerald-100`;
      login.textContent = "Log In";

      container.appendChild(signup);
      container.appendChild(login);
    }
  }

  // Create buttons for both desktop and mobile
  createAuthButtons(desktopContainer, false);
  createAuthButtons(mobileContainer, true);
})();
</script>