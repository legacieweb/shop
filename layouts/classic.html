<!-- Layout -->
<div id="layoutDefault" class="flex-grow flex flex-col">
<!-- Header -->
<header id="headerSection" class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between border-2 border-transparent" id="boxHeader">
    <div class="flex items-center gap-2">
      <img id="shopLogo" src="https://placehold.co/40x40" class="w-10 h-10 rounded-full object-cover border-2 border-transparent" />
      <span id="shopTitle" class="text-xl font-bold border-2 border-transparent">loading...</span>
    </div>

    <div class="flex items-center gap-4">
      <div id="shopAuthButtons" class="flex items-center gap-2 text-sm"></div>
    </div>
  </div>
</header>


  <!-- Hero -->
  <section id="heroSection" class="relative py-20 text-center text-white border-2 border-transparent">
    <div id="heroOverlay" class="absolute inset-0 bg-black/40 z-0"></div>
    <img id="heroImage" class="absolute inset-0 w-full h-full object-cover z-[-1] border-2 border-transparent" />
    <div class="relative z-10 max-w-2xl mx-auto px-4">
      <h2 id="shopName" class="text-4xl font-extrabold mb-2 border-2 border-transparent">Loading Store...</h2>
      <p id="shopBio" class="text-lg border-2 border-transparent">Please wait while we load the store.</p>
      <button id="uploadHeroBtn" class="hidden mt-4 inline-block bg-white/80 text-indigo-700 font-medium px-4 py-2 rounded shadow hover:bg-white/90 text-sm">
        üì§ Upload Hero Image
      </button>
    </div>
  </section>

  <!-- Product Grid -->
  <main class="max-w-7xl mx-auto px-4 py-12 flex-grow">
    <h3 id="productHeader" class="text-2xl font-bold mb-6 text-center border-2 border-transparent">Our Products</h3>
<div id="productGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 min-h-[400px] justify-center"></div>
  </main>

  <!-- Product Not Found -->
  <section id="productNotFound" class="max-w-2xl mx-auto px-6 py-20 text-center hidden">
    <h2 class="text-3xl font-bold text-yellow-500 mb-4">üõí No Products Available</h2>
    <p class="text-gray-600 mb-4">This shop hasn't added any products yet. Check back later!</p>
    <a href="https://iyonicorp.com" class="inline-block bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700 transition">‚Üê Back to Marketplace</a>
  </section>

  <!-- Footer -->
<footer id="footer" class="bg-white border-t py-6 text-center text-sm mt-auto">
  <span id="footerText" class="border-2 border-transparent">
    ¬© <span id="year"></span>  Seller Store. All rights reserved.
  </span>
  <div class="mt-2 text-xs">
    <a href="https://iyonicorp.com"
       target="_blank"
       rel="noopener noreferrer"
       class="flame-text-glow">
      Powered by iyonicorp
    </a>
  </div>
</footer>

<style>
  @keyframes flameGlowShift {
    0% {
      color: #000;
      text-shadow: 
        0 0 2px #757575,
        0 0 4px #838383,
        0 0 6px #a1a1a1,
        0 0 8px #b1b1b1;
    }
    50% {
      color: #c0c0c0;
      text-shadow: 
        0 0 4px #c0c0c0,
        0 0 8px #cecece,
        0 0 10px #c2c2c2,
        0 0 12px #e0e0e0;
    }
    100% {
      color: #d1cece;
      text-shadow: 
        0 0 6px #dbdbdb,
        0 0 12px #f7f4f3,
        0 0 18px #f7f5f2,
        0 0 24px #ffffff;
    }
  }

  .flame-text-glow {
    font-weight: bold;
    display: inline-block;
    animation: flameGlowShift 3s ease-in-out infinite alternate;
    transition: text-shadow 0.3s ease;
  }

  .flame-text-glow:hover {
    text-decoration: underline;
  }
</style>


<!-- Modal -->
<div id="customModal" class="hidden fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-white p-6 shadow-xl rounded-lg w-[420px] max-w-full space-y-4">
  <h3 class="text-lg font-bold text-indigo-700">Customize This Layout</h3>
  <div class="space-y-2" id="modalContent"></div>
  <div class="flex justify-between gap-2 pt-4">
    <button id="cancelBtn" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400 w-1/2">Cancel</button>
    <button id="applyBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-1/2">Apply</button>
  </div>
</div>
<!-- Script -->
<script>
(async function () {
  const { sellerParam, isOwner, API, theme } = window.__SHOP_DATA__ || {};
  const set = (id, fn) => { const el = document.getElementById(id); if (el) fn(el); };

  // Fix year display
  const yearSpan = document.getElementById("year");
  if (yearSpan) yearSpan.textContent = new Date().getFullYear();

  const resolveImage = (img) => {
    if (!img || typeof img !== 'string') return '';
    let val = img.trim().replace(/\\\\/g, '/').replace(/\\/g, '/');
    // Absolute URLs or data URIs
    if (/^(https?:)?\/\//i.test(val) || val.startsWith('data:')) return val;

    // MongoDB image paths (e.g., "/images/<id>" or "images/<id>")
    if (/^\/?images\//i.test(val) || val.toLowerCase().includes('/images/')) {
      const clean = val.split(/images\//i).pop();
      return `${API}/images/${clean.replace(/^\/+/, '')}`;
    }

    // Legacy uploads paths
    if (/^\/?uploads\//i.test(val) || val.toLowerCase().includes('/uploads/')) {
      const clean = val.split(/uploads\//i).pop();
      return `${API}/uploads/${clean.replace(/^\/+/, '')}`;
    }

    // If it looks like a Mongo ObjectId, assume images endpoint
    if (/^[a-f0-9]{24}$/i.test(val)) {
      return `${API}/images/${val}`;
    }

    // Fallback: treat as a filename under uploads
    return `${API}/uploads/${val.replace(/^\/+/, '')}`;
  };

  // Helper: currency symbol map
  function getCurrencySymbol(code) {
    const symbols = {
      USD: "$", EUR: "‚Ç¨", GBP: "¬£", NGN: "‚Ç¶", INR: "‚Çπ", KES: "KSh", ZAR: "R"
    };
    return symbols[code] || code;
  }

  // Apply theme to DOM
  set("shopLogo", el => {
    el.src = resolveImage(theme.logo);
    el.onerror = () => el.src = "https://placehold.co/40x40?text=Logo";
  });

  set("shopTitle", el => {
    el.textContent = theme.title || sellerParam;
    el.style.color = theme.titleColor || "";
  });

  set("shopName", el => {
    el.textContent = theme.name || "";
    el.style.color = theme.nameColor || "";
  });

  set("shopBio", el => {
    el.textContent = theme.bio || "";
    el.style.color = theme.bioColor || "";
  });

  set("productHeader", el => {
    el.textContent = theme.header || "Our Products";
    el.style.color = theme.headerColor || "";
  });

  set("heroImage", el => {
    el.src = resolveImage(theme.heroImage);
  });

  set("headerSection", el => {
    el.style.backgroundColor = theme.headerBg || "#ffffff";
  });

  set("footer", el => {
    el.style.backgroundColor = theme.footerBg || "#ffffff";
  });

  set("footerText", el => {
    el.textContent = theme.footerText || `¬© ${new Date().getFullYear()} iyonicorp Seller Store. All rights reserved.`;
    el.style.color = theme.footerColor || "";
  });

  // üîÑ Fetch products and seller
  const res = await fetch(`${API}/find?collection=products&seller=${encodeURIComponent(sellerParam)}`);
  const products = await res.json();

  const sellerRes = await fetch(`${API}/find?collection=users&username=${encodeURIComponent(sellerParam)}`);
  const [seller] = await sellerRes.json();
  const shopSettings = seller?.shopSettings || {};
  const storeCurrency = shopSettings?.storeCurrency || "USD";

  const grid = document.getElementById("productGrid");
  const notFound = document.getElementById("productNotFound");

  // ‚úÖ Clear grid before rendering
  grid.innerHTML = "";

  if (products.length > 0) {
    grid.classList.remove("hidden");
    notFound?.classList.add("hidden");

    products.forEach(p => {
      const imageSrc = resolveImage(p.image);
      const card = document.createElement("a");
      card.href = `../detail?id=${p.id}`;
      card.className = `
        bg-white
        rounded-xl
        overflow-hidden
        shadow-md
        hover:shadow-2xl
        transition
        duration-300
        border
        border-gray-200
        flex
        flex-col
        cursor-pointer
        relative
        transform
        hover:scale-[1.04]
        hover:-translate-y-1
        aspect-[4/5]
        max-w-[300px]
        sm:max-w-[320px]
        md:max-w-xs
      `;

      card.innerHTML = `
        <div class="relative w-full flex-shrink-0 h-[65%] overflow-hidden rounded-t-xl">
          ${p.image ? `
            <img src="${imageSrc}" alt="${p.name}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-110" />
            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-50 pointer-events-none rounded-t-xl"></div>
          ` : ""}
          <button 
            class="absolute bottom-4 right-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-4 shadow-lg transition-transform duration-300 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-indigo-400"
            aria-label="View ${p.name}"
            title="View ${p.name}"
            tabindex="0"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
          </button>
        </div>
        <div class="flex flex-col justify-center flex-grow px-5 pb-5 pt-3">
          <h4 class="text-lg font-semibold text-indigo-700 truncate" title="${p.name}">${p.name}</h4>
          <p class="mt-1 text-xl font-bold text-gray-900">${getCurrencySymbol(storeCurrency)}${p.price.toFixed(2)}</p>
        </div>
      `;

      grid.appendChild(card);
    });

  } else {
    grid.classList.add("hidden");
    notFound?.classList.remove("hidden");
  }

  // Customization tools (unchanged)
  if (!isOwner) return;

  const btn = document.createElement("button");
  btn.textContent = "‚ú® Customize";
  btn.className = "fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-indigo-600 text-white px-6 py-2 rounded-full shadow hover:bg-indigo-700";
  btn.id = "customizeBtn";
  document.body.appendChild(btn);

  const customizableElements = {
    "shopLogo": { label: "Logo (100√ó100px)", type: "image" },
    "shopTitle": { label: "Store Title", type: "text-edit", key: "title" },
    "boxHeader": { label: "Header Background", type: "background", key: "headerBg" },
    "heroImage": { label: "Hero Banner Image", type: "image" },
    "shopName": { label: "Hero Title", type: "text-edit", key: "name" },
    "shopBio": { label: "Hero Bio", type: "text-edit", key: "bio" },
    "productHeader": { label: "Product Section", type: "text-edit", key: "header" },
    "footer": { label: "Footer Background", type: "background", key: "footerBg" },
    "footerText": { label: "Footer Text", type: "text-edit", key: "footerText", colorKey: "footerColor" }
  };

  let isCustomizing = false;
  btn.addEventListener("click", () => {
    isCustomizing = !isCustomizing;
    btn.textContent = isCustomizing ? "‚ùå Close Customization" : "‚ú® Customize";
    document.getElementById("uploadHeroBtn")?.classList.toggle("hidden", !isCustomizing);
    if (isCustomizing) {
      Object.keys(customizableElements).forEach(id => {
        const el = document.getElementById(id);
        if (el && !el.dataset.bound) {
          el.dataset.bound = "true";
          el.classList.add("cursor-pointer", "border-2", "border-indigo-500");
          el.addEventListener("click", openModal);
        }
      });
    } else {
      removeHighlights();
    }
  });

  document.getElementById("uploadHeroBtn")?.addEventListener("click", () => {
    if (!isCustomizing) return;
    openModal({ currentTarget: { id: "heroImage" }, stopPropagation: () => {} });
  });

  function openModal(e) {
    e.stopPropagation();
    const id = e.currentTarget.id;
    const config = customizableElements[id];
    if (!config) return;

    const modal = document.getElementById("customModal");
    const content = document.getElementById("modalContent");
    modal.classList.remove("hidden");
    content.innerHTML = `<label class="text-sm font-semibold block mb-1">${config.label}</label>`;

    if (config.type === "image") {
      content.innerHTML += `
        <input type="text" id="customInputURL" placeholder="Image URL or filename" class="w-full px-3 py-2 border rounded mb-2" />
        <input type="file" id="customInputFile" accept="image/*" class="w-full" />
      `;
    } else if (config.type === "text-edit") {
      const el = document.getElementById(id);
      content.innerHTML += `
        <input type="text" id="customTextValue" value="${el.textContent}" class="w-full px-3 py-2 border rounded mb-2" />
        <input type="color" id="customInputColor" class="w-full h-10 border rounded" />
      `;
    } else if (config.type === "background") {
      content.innerHTML += `<input type="color" id="customInputBg" class="w-full h-10 border rounded" />`;
    }

    document.getElementById("applyBtn").onclick = () => applyChange(id, config);
    document.getElementById("cancelBtn").onclick = () => modal.classList.add("hidden");
  }

  async function applyChange(id, config) {
    const el = document.getElementById(id);
    if (!el) return;

    if (config.type === "image") {
      const url = document.getElementById("customInputURL").value.trim();
      const fileInput = document.getElementById("customInputFile");
      let image = url;

      if (!url && fileInput?.files?.[0]) {
        const file = fileInput.files[0];
        image = await new Promise(res => {
          const reader = new FileReader();
          reader.onloadend = () => res(reader.result);
          reader.readAsDataURL(file);
        });
      }

      const stored = image;
      el.src = resolveImage(stored);

      if (id === "shopLogo") theme.logo = stored;
      if (id === "heroImage") theme.heroImage = stored;

    } else if (config.type === "text-edit") {
      const color = document.getElementById("customInputColor").value;
      const text = document.getElementById("customTextValue").value;
      el.textContent = text;
      el.style.color = color;
      theme[config.key] = text;
      theme[config.colorKey || `${config.key}Color`] = color;

    } else if (config.type === "background") {
      const bg = document.getElementById("customInputBg").value;
      el.style.backgroundColor = bg;
      theme[config.key] = bg;
    }

    await fetch(`${API}/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        collection: "users",
        query: { username: sellerParam },
        updates: { customTheme: theme }
      })
    });

    document.getElementById("customModal").classList.add("hidden");
  }

  function removeHighlights() {
    Object.keys(customizableElements).forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.classList.remove("cursor-pointer", "border-2", "border-indigo-500");
        el.removeEventListener("click", openModal);
        el.removeAttribute("data-bound");
      }
    });
    document.getElementById("uploadHeroBtn")?.classList.add("hidden");
  }
})();

// üîê Auth Buttons: login/signup vs dashboard/logout
(function renderAuthButtons() {
  const user = JSON.parse(localStorage.getItem("user"));
  const container = document.getElementById("shopAuthButtons");
  if (!container) return;

  container.innerHTML = "";

  if (user) {
    const dashboard = document.createElement("a");
    const actualSeller = window.__SHOP_DATA__?.actualSeller || user.username;

    if (user.role && user.role.startsWith("seller")) {
      dashboard.href = `../dashboard?seller=${encodeURIComponent(actualSeller)}`;
    } else {
      dashboard.href = `../buyer?seller=${encodeURIComponent(actualSeller)}`;
    }

    dashboard.className = "px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700 transition";
    dashboard.textContent = "Dashboard";

    const logout = document.createElement("button");
    logout.className = "px-3 py-1 rounded border border-indigo-600 text-indigo-600 hover:bg-indigo-50 transition";
    logout.textContent = "Logout";
    logout.onclick = () => {
      localStorage.removeItem("user");
      location.reload();
    };

    container.appendChild(dashboard);
    container.appendChild(logout);
  } else {
    const sellerParam = new URLSearchParams(window.location.search).get("seller");

    const signup = document.createElement("a");
    signup.href = sellerParam ? `../signup?seller=${sellerParam}` : "../signup";
    signup.className = "px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700 transition";
    signup.textContent = "Sign Up";

    const login = document.createElement("a");
    login.href = sellerParam ? `../login?seller=${sellerParam}` : "../login";
    login.className = "px-3 py-1 rounded border border-indigo-600 text-indigo-600 hover:bg-indigo-50 transition";
    login.textContent = "Log In";

    container.appendChild(signup);
    container.appendChild(login);
  }
})();
</script>